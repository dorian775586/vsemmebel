<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mebel.by - Выгодные предложения</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; min-height: 100vh; } 
        .header-bg { background-color: #ffffff; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); }
        .category-button {
            padding: 0.6rem 1.4rem; border: 2px solid #ffedd5; background-color: #ffffff;
            border-radius: 9999px; font-weight: 600; color: #4b5563; transition: all 0.3s ease;
            cursor: pointer; text-align: center; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.95rem; 
        }
        .category-button.active, .category-button:hover {
            border-color: #f97316; background-color: #f97316; color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(249,115,22,0.3); transform: translateY(-1px);
        }
        #category-filter::-webkit-scrollbar { display: none; }
        #category-filter { -ms-overflow-style: none; scrollbar-width: none; }
        .offer-card {
            background-color: white; border-radius: 1.25rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05),0 10px 10px -5px rgba(0,0,0,0.04);
            transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1); border: 1px solid #f3f4f6;
            cursor: pointer;
        }
        .offer-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1),0 15px 30px -5px rgba(0,0,0,0.08);
        }
        .card-button { background-color: #f97316; box-shadow: 0 4px 10px rgba(249,115,22,0.4); }
        .card-button:hover { background-color: #ea580c; }

                /* --- Исправление наложений на мобильных --- */
        @media (max-width: 768px) {
        .product-layout {
            flex-direction: column !important;
            align-items: center !important;
            gap: 1.5rem !important;
        }
        .product-description,
        .product-pricing {
            width: 100% !important;
            text-align: center !important;
        }
        .product-pricing {
            margin-top: 1rem !important;
        }
        }

    </style>
</head>
<body>

<!-- Верхняя навигация -->
<!-- Верхняя навигация -->
<header class="sticky top-0 header-bg z-20">
  <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
    <!-- Скрытая кнопка админа -->
    <div id="hidden-admin-btn" style="width:20px;height:20px;opacity:0;cursor:pointer;margin-right:8px;"></div>

    <h1 class="text-3xl font-black text-gray-900 tracking-tight cursor-pointer" onclick="window.scrollTo(0, 0)">Mebel.by</h1>

    <div class="flex items-center space-x-4">
      <!-- Город -->
      <div class="flex items-center space-x-2 text-sm cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
        <span id="current-city" class="font-bold text-gray-700">Гомель</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>

      <!-- Избранное -->
      <a href="favorites.html"
         class="group relative flex items-center justify-center w-12 h-12 rounded-full hover:bg-orange-100 transition"
         title="Избранное">
        <svg xmlns="http://www.w3.org/2000/svg" 
             fill="none" 
             viewBox="0 0 24 24" 
             stroke-width="2" 
             stroke="currentColor" 
             class="w-6 h-6 text-gray-700 group-hover:text-orange-500 transition">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 21C12 21 6 16 4 11C2 6 4 2 8 3C10 4 12 6 12 6C12 6 14 4 16 3C20 2 22 6 20 11C18 16 12 21 12 21Z" />
        </svg>
        <span class="sr-only">Избранное</span>
      </a>

      <!-- Корзина (новый значок) -->
      <a href="order.html" 
         class="group relative flex items-center justify-center w-12 h-12 rounded-full hover:bg-orange-100 transition"
         title="Корзина">
        <svg xmlns="http://www.w3.org/2000/svg"
             fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
             class="w-6 h-6 text-gray-700 group-hover:text-orange-500 transition">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M6 7V6a3 3 0 013-3h6a3 3 0 013 3v1m2 0a1 1 0 011 1v12a2 2 0 01-2 2H5a2 2 0 01-2-2V8a1 1 0 011-1h16z" />
        </svg>
        <span class="sr-only">Корзина</span>
      </a>
    </div>
  </div>
</header>

    <!-- ОСНОВНОЙ КОНТЕЙНЕР ДЛЯ СПИСКА ТОВАРОВ (Единственный видимый вид) -->
    <div id="main-view-container">
        <main class="max-w-4xl mx-auto px-4 mt-6">
            <!-- Баннер Карусель -->
            <div id="carousel-banner" class="relative rounded-3xl overflow-hidden shadow-2xl mb-8 h-64 md:h-96 bg-gray-200">
                <!-- Слайды будут добавляться через JS -->
                <div id="carousel-slides" class="h-full w-full relative"></div>

                <!-- Навигационные кнопки -->
                <button id="carousel-prev" class="absolute left-3 top-1/2 transform -translate-y-1/2 bg-black/20 text-white p-2 rounded-full hover:bg-black/40 transition z-20">
                    &#10094;
                </button>
                <button id="carousel-next" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-black/20 text-white p-2 rounded-full hover:bg-black/40 transition z-20">
                    &#10095;
                </button>

                <!-- Индикаторы -->
                <div id="carousel-indicators" class="absolute bottom-3 left-1/2 transform -translate-x-1/2 flex space-x-2 z-20"></div>
            </div>


            <!-- Поиск -->
            <div class="relative mb-8">
                <input type="text" id="search-input" placeholder="Поиск: диван, шкаф, кухня..." class="w-full py-3.5 pl-14 pr-6 text-lg border-2 border-gray-200 rounded-full focus:ring-orange-500 focus:border-orange-500 transition duration-200" />
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>

            <!-- Категории -->
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Каталог</h3>
            <div id="category-filter" class="flex flex-nowrap overflow-x-auto space-x-3 pb-4 scrollbar-hide">
                <!-- Категории будут загружены сюда JavaScript'ом -->
            </div>

            <!-- Предложения -->
            <h3 class="text-2xl font-bold text-gray-800 my-6">Выгодные предложения</h3>
            <div id="offers-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                <div id="no-offers" class="col-span-full text-center text-gray-500 hidden p-8">Предложений по вашему запросу не найдено.</div>
                <!-- Карточки товаров будут загружены сюда JavaScript'ом -->
            </div>
        </main>
    </div>

    <!-- Модальное окно админа -->
    <div id="admin-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 w-80 relative">
            <h3 class="text-xl font-bold mb-4">Вход Админа</h3>
            <!-- Контейнер для сообщений об ошибках -->
            <div id="admin-message" class="text-sm text-center font-medium my-2 hidden p-2 rounded"></div>
            
            <input type="email" id="admin-email" placeholder="Email" class="w-full mb-3 p-2 border rounded-lg focus:ring-orange-500 focus:border-orange-500 transition" />
            <input type="password" id="admin-password" placeholder="Пароль" class="w-full mb-3 p-2 border rounded-lg focus:ring-orange-500 focus:border-orange-500 transition" />
            <div class="flex justify-between">
                <button id="admin-register" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Регистрация</button>
                <button id="admin-login" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Войти</button>
            </div>
            <button id="admin-close" class="absolute top-3 right-3 text-2xl text-gray-400 hover:text-gray-600 leading-none">&times;</button>
        </div>
    </div>
    
    <!-- Кастомное модальное окно сообщений -->
    <div id="custom-message-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full relative text-center shadow-xl">
            <p id="custom-message-text" class="text-gray-700 mb-4"></p>
            <button id="custom-message-close" class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition">ОК</button>
        </div>
    </div>

    <!-- JavaScript логика -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Устанавливаем режим отладки для Firestore
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION & AUTH VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Предоставленная пользователем конфигурация в качестве резервной
        const USER_FALLBACK_CONFIG = {
            apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
            authDomain: "vsemmebel-90d48.firebaseapp.com",
            projectId: "vsemmebel-90d48",
            storageBucket: "vsemmebel-90d48.firebasestorage.app",
            messagingSenderId: "958123504041",
            appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
        };
        
        let firebaseConfig = USER_FALLBACK_CONFIG; // Начинаем с резервной конфигурации

        try {
            // Попытка использовать конфигурацию из переменной хостинга
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const envConfig = JSON.parse(__firebase_config);
                if (typeof envConfig === 'object' && envConfig !== null && envConfig.projectId) {
                    firebaseConfig = envConfig;
                }
            }
        } catch (e) {
            console.warn("Предупреждение: Не удалось распарсить JSON из переменной хостинга. Используется предоставленная конфигурация.", e);
        }

        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        const productCollectionPath = `artifacts/${appId}/public/data/offers`;

        // 1. Инициализация Firebase
        function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("КРИТИЧЕСКАЯ ОШИБКА: Конфигурация Firebase недоступна.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                console.log("Firebase успешно инициализирован.");
                loadCarouselFromFirestore();
            } catch (e) {
                console.error("КРИТИЧЕСКАЯ ОШИБКА: Ошибка инициализации Firebase.", e);
                db = null; auth = null; // Обеспечиваем, что переменные null в случае ошибки
            }
        }

        // 2. Инициализация аутентификации (вход анонимно или по токену)
        async function initializeAuth() {
            if (!auth) {
                // Если Auth не инициализирован, используем рандомный ID
                userId = crypto.randomUUID();
                return; 
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Аутентификация успешна. UID:", userId);
                // Запуск загрузки данных после успешной аутентификации
                setupRealtimeOffersListener();
            } catch (error) {
                console.error("Ошибка аутентификации Firebase:", error);
                showCustomMessage("Ошибка аутентификации. Проверьте консоль для деталей.");
            }
        }
        
        // --- Custom Message Modal (Замена alert/confirm) ---
        const customModal = document.getElementById('custom-message-modal');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageCloseBtn = document.getElementById('custom-message-close');
        
        function closeCustomMessage() {
            customModal.classList.add('hidden');
        }

        function showCustomMessage(message) {
            customMessageText.textContent = message;
            customModal.classList.remove('hidden');
        }

        customMessageCloseBtn.onclick = closeCustomMessage;


        // --- Admin Login Modal Logic ---
        const adminModal = document.getElementById('admin-modal');
        const adminCloseBtn = document.getElementById('admin-close');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLogin = document.getElementById('admin-login');
        const adminRegister = document.getElementById('admin-register');
        const adminMessageDiv = document.getElementById('admin-message');
        
        // Примечание: предполагается, что admin.html существует в корневом каталоге.
        const ADMIN_REDIRECT_URL = 'admin.html'; 

        adminCloseBtn.onclick = () => adminModal.classList.add('hidden');

        function showAdminMessage(message, isError = false) {
            adminMessageDiv.textContent = message;
            adminMessageDiv.classList.remove('hidden');
            if (isError) {
                adminMessageDiv.className = 'text-sm text-center font-medium my-2 p-2 rounded bg-red-100 text-red-700';
            } else {
                adminMessageDiv.className = 'text-sm text-center font-medium my-2 p-2 rounded bg-green-100 text-green-700';
            }
        }

        // --- ЛОГИКА АДМИНА: ВХОД ЧЕРЕЗ EMAIL/ПАРОЛЬ ---
        adminLogin.onclick = async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            if (!email || !password) return showAdminMessage('Введите email и пароль', true);
            
            if (!auth) {
                console.error("Ошибка: Firebase Auth не инициализирован. Попробуйте обновить страницу.");
                return showAdminMessage('Ошибка: Firebase Auth не инициализирован. Проверьте консоль.', true);
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("Админ вошел. Перенаправление на admin.html");
                window.location.href = ADMIN_REDIRECT_URL;
                
            } catch (error) {
                console.error("Ошибка входа админа:", error);
                let errorMessage = 'Ошибка входа. Проверьте данные.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Пользователь с таким email не найден.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Неверный пароль.';
                }
                showAdminMessage(errorMessage, true);
            }
        };

        // --- ЛОГИКА АДМИНА: РЕГИСТРАЦИЯ ЧЕРЕЗ EMAIL/ПАРОЛЬ ---
        adminRegister.onclick = async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            if (!email || !password) return showAdminMessage('Введите email и пароль', true);
            
            if (!auth) {
                console.error("Ошибка: Firebase Auth не инициализирован. Попробуйте обновить страницу.");
                return showAdminMessage('Ошибка: Firebase Auth не инициализирован. Проверьте консоль.', true);
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                console.log("Админ зарегистрирован. Перенаправление на admin.html");
                window.location.href = ADMIN_REDIRECT_URL;
                
            } catch (error) {
                console.error("Ошибка регистрации админа:", error);
                let errorMessage = 'Ошибка регистрации.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Этот email уже используется.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Пароль должен быть не менее 6 символов.';
                }
                showAdminMessage(errorMessage, true);
            }
        };

        // --- Carousel Logic ---
let carouselData = []; // объекты: {imageUrl, title, subtitle, buttonText, buttonLink, order}
let currentSlide = 0;
let carouselInterval = null;

const slidesContainer = document.getElementById('carousel-slides');
const indicatorsContainer = document.getElementById('carousel-indicators');
const prevBtn = document.getElementById('carousel-prev');
const nextBtn = document.getElementById('carousel-next');

// Функция рендера карусели
function renderCarousel() {
    slidesContainer.innerHTML = '';
    indicatorsContainer.innerHTML = '';

    carouselData.forEach((slide, index) => {
        // Создание слайдов
        const slideDiv = document.createElement('div');
        slideDiv.className = `absolute inset-0 transition-opacity duration-700 ease-in-out ${index === currentSlide ? 'opacity-100 z-10' : 'opacity-0 z-0'}`;
        slideDiv.innerHTML = `
            <img src="${slide.url}" alt="${slide.title || ''}" class="w-full h-full object-cover">
            <div class="absolute inset-0 flex flex-col justify-center items-center text-center text-white px-4">
                ${slide.title ? `<h2 class="text-3xl md:text-5xl font-bold mb-2">${slide.title}</h2>` : ''}
                ${slide.subtitle ? `<p class="text-lg md:text-xl mb-4">${slide.subtitle}</p>` : ''}
                ${slide.buttonText ? `<a href="${slide.buttonLink || '#'}" class="bg-white text-orange-600 font-bold py-2 px-6 rounded-full hover:bg-gray-100 transition">${slide.buttonText}</a>` : ''}
            </div>
        `;
        slidesContainer.appendChild(slideDiv);

        // Создание индикаторов
        const indicator = document.createElement('button');
        indicator.className = `w-3 h-3 rounded-full bg-white/50 hover:bg-white transition ${index === currentSlide ? 'bg-white' : ''}`;
        indicator.onclick = () => {
            currentSlide = index;
            updateCarousel();
            startCarouselAutoplay(); // сброс таймера при ручном клике
        };
        indicatorsContainer.appendChild(indicator);
    });
}

// Функция обновления видимого слайда
function updateCarousel() {
    const slides = slidesContainer.children;
    const indicators = indicatorsContainer.children;
    for (let i = 0; i < slides.length; i++) {
        slides[i].classList.toggle('opacity-100', i === currentSlide);
        slides[i].classList.toggle('opacity-0', i !== currentSlide);
        slides[i].classList.toggle('z-10', i === currentSlide);
        slides[i].classList.toggle('z-0', i !== currentSlide);
        indicators[i].classList.toggle('bg-white', i === currentSlide);
        indicators[i].classList.toggle('bg-white/50', i !== currentSlide);
    }
}

// Автоперелистывание каждые 5 секунд
function startCarouselAutoplay() {
    if (carouselInterval) clearInterval(carouselInterval);
    if (carouselData.length === 0) return; // если слайдов нет
    carouselInterval = setInterval(() => {
        currentSlide = (currentSlide + 1) % carouselData.length;
        updateCarousel();
    }, 5000);
}

// Кнопки вручную
prevBtn.onclick = () => {
    currentSlide = (currentSlide - 1 + carouselData.length) % carouselData.length;
    updateCarousel();
    startCarouselAutoplay(); // сброс таймера
};

nextBtn.onclick = () => {
    currentSlide = (currentSlide + 1) % carouselData.length;
    updateCarousel();
    startCarouselAutoplay(); // сброс таймера
};

// Загрузка карусели из Firestore
function loadCarouselFromFirestore() {
    if (!db) return;

    const carouselRef = collection(db, `artifacts/${appId}/public/data/carousel`);
    onSnapshot(carouselRef, snapshot => {
        carouselData = [];
        snapshot.forEach(doc => {
            carouselData.push({ id: doc.id, ...doc.data() });
        });

        // Сортируем по порядку и ограничиваем максимум 5 слайдов
        carouselData.sort((a, b) => (a.order || 0) - (b.order || 0));
        if (carouselData.length > 5) carouselData = carouselData.slice(0,5);

        currentSlide = 0;
        renderCarousel();
        startCarouselAutoplay();
    });
}

// Запуск после инициализации Firebase
        // --- MAIN APPLICATION LOGIC ---

        // Категории (заглушка)
        const CATEGORIES = ["Все товары", "Диваны", "Кровати", "Шкафы", "Столы и Стулья", "Кухни"];

        let currentCategory = "Все товары";
        let allOffers = []; // Будет хранить ВСЕ загруженные товары (полные объекты)
        let searchTerm = "";

        const categoryFilterDiv = document.getElementById('category-filter');
        const offersListDiv = document.getElementById('offers-list');
        const searchInput = document.getElementById('search-input');
        const noOffersDiv = document.getElementById('no-offers');


        // --- Data Loading and Filtering ---

        // 3. Установка слушателя Firestore для получения данных
        function setupRealtimeOffersListener() {
            if (!db) return;

            const offersRef = collection(db, productCollectionPath);
            const q = query(offersRef);

            onSnapshot(q, (snapshot) => {
                const fetchedOffers = [];
                snapshot.forEach(doc => {
                    // Сохраняем ВЕСЬ объект данных
                    fetchedOffers.push({ id: doc.id, ...doc.data() });
                });
                
                allOffers = fetchedOffers;
                // *** ДОБАВЛЕНО ЛОГИРОВАНИЕ: Проверяем, сколько товаров пришло из базы ***
                console.log(`[Firestore] Загружено ${allOffers.length} товаров. (0 = нет товаров)`);
                // Перерисовываем при получении новых данных
                renderOffers(); 
            }, (error) => {
                console.error("Ошибка получения товаров из Firestore:", error);
                showCustomMessage("Не удалось загрузить товары. Проверьте консоль.");
            });
        }

        // --- Render Functions ---

        function renderCategories() {
            categoryFilterDiv.innerHTML = '';
            CATEGORIES.forEach(category => {
                const button = document.createElement('button');
                button.className = `category-button ${category === currentCategory ? 'active' : ''}`;
                button.textContent = category;
                button.onclick = () => {
                    setActiveCategory(category);
                };
                categoryFilterDiv.appendChild(button);
            });
        }

        function setActiveCategory(category) {
            currentCategory = category;
            renderCategories(); // Обновить стили кнопок
            renderOffers();    // Применить фильтр
        }

        function renderOffers() {
            // *** ДОБАВЛЕНО ЛОГИРОВАНИЕ: Проверяем, что очистка происходит ***
            console.log(`[Render] Очистка списка товаров. Товаров к рендерингу после фильтра: ${allOffers.length}`);

            offersListDiv.innerHTML = '';
            
            // 1. Фильтр по категории
            const filteredByCategory = currentCategory === "Все товары"
                ? allOffers
                : allOffers.filter(offer => offer.category === currentCategory);

            // 2. Фильтр по поисковому запросу
            const filteredBySearch = searchTerm.trim().toLowerCase();
            const finalOffers = filteredByCategory.filter(offer => 
                offer.title?.toLowerCase().includes(filteredBySearch) || 
                offer.category?.toLowerCase().includes(filteredBySearch)
            );

            if (finalOffers.length === 0) {
                noOffersDiv.classList.remove('hidden');
                // Важно: вставляем сообщение "Нет товаров" в контейнер offersListDiv
                offersListDiv.appendChild(noOffersDiv);
                return;
            }
            noOffersDiv.classList.add('hidden');

            // 3. Рендеринг карточек
            finalOffers.forEach(offer => {
                // Ищем первую активную комбинацию для отображения цены
                // *** БЫЛА ДОБАВЛЕНА ПРОВЕРКА НА СУЩЕСТВОВАНИЕ offer.combinations ***
                const activeCombo = offer.combinations?.find(c => c.isActive) || offer.combinations?.[0] || { price: 0 }; 
                const originalPrice = activeCombo.price || 0;
                const finalPrice = originalPrice * (1 - (offer.discount || 0) / 100);
                const imageUrl = offer.images?.[0] || `https://placehold.co/400x300/f3f4f6/4b5563?text=${encodeURIComponent(offer.title || 'Нет Фото')}`;

                const card = document.createElement('div');
                card.className = 'offer-card flex flex-col cursor-pointer';
                card.setAttribute('data-offer-id', offer.id);
                
                // *** ИЗМЕНЕНИЕ: Теперь клик на карточку перенаправляет на purchase.html ***
                card.onclick = () => showProductDetails(offer.id);

                const priceDisplay = offer.discount > 0 ? 
                    `
                    <p class="text-xl font-extrabold text-red-600">${Math.round(finalPrice)} BYN</p>
                    <p class="text-sm text-gray-400 line-through">${Math.round(originalPrice)} BYN</p>
                    ` : 
                    `<p class="text-xl font-extrabold text-gray-900">${Math.round(finalPrice)} BYN</p>`;

                card.innerHTML = `
                    <div class="h-48 overflow-hidden relative">
                        <!-- Изображение с заглушкой -->
                        <img 
                            src="${imageUrl}" 
                            alt="${offer.title}" 
                            class="w-full h-full object-cover transition duration-500 ease-in-out hover:scale-105"
                            onerror="this.onerror=null; this.src='https://placehold.co/400x300/f3f4f6/4b5563?text=Нет+Фото';"
                        >
                        ${offer.discount > 0 ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">- ${offer.discount}%</div>` : ''}
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <p class="text-sm font-semibold text-orange-600 mb-1">${offer.category || 'Прочее'}</p>
                        <h4 class="text-lg font-bold text-gray-900 mb-3 flex-grow">${offer.title || 'Товар без названия'}</h4>
                        <div class="flex items-end justify-between mt-auto">
                            <div class="flex items-center space-x-2">
                                ${priceDisplay}
                            </div>
                            <!-- Кнопка "Заказать" теперь вызывает сообщение, чтобы не мешать клику по карточке -->
                            <button onclick="event.stopPropagation(); window.showCustomMessage('Вы добавили ${offer.title || 'этот товар'} в корзину (имитация)!')" class="card-button text-white text-sm font-bold py-2 px-4 rounded-full transition">
                                Заказать
                            </button>
                        </div>
                    </div>
                `;
                offersListDiv.appendChild(card);
            });
        }
        
        // --- Product Detail Page (PDP) Logic ---

        // *** ИЗМЕНЕНИЕ: УПРОЩЕННАЯ ФУНКЦИЯ ДЛЯ РЕДИРЕКТА ***
        function showProductDetails(id) {
            // Перенаправляем на новую страницу, передавая ID товара
            window.location.href = `product.html?id=${id}`;
        }
        
        // Глобальные функции для доступа из HTML
        window.showCustomMessage = showCustomMessage;


        // --- Event Listeners ---

        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderOffers();
        });


        // --- Initialization ---

        // 1. Запускаем инициализацию Firebase и Auth НЕМЕДЛЕННО
        initializeFirebase();
        initializeAuth(); // Аутентификация -> setupRealtimeOffersListener

        // 2. DOM-зависимые функции запускаем после полной загрузки страницы
        window.onload = () => {
            renderCategories(); // Рендерим кнопки категорий
            // Рендеринг товаров будет вызван после успешной аутентификации в initializeAuth -> setupRealtimeOffersListener
        };
            // --- Секретная кнопка админа слева от логотипа ---
        const hiddenAdminBtn = document.getElementById('hidden-admin-btn');
        hiddenAdminBtn.onclick = () => {
            const password = prompt("Введите пароль для админа:");
            if (password === "1234") {  // <-- здесь твой пароль
                adminModal.classList.remove('hidden'); // открываем модалку админа
            } else {
                alert("Неверный пароль!");
            }
        };

    </script>
</body>
</html>