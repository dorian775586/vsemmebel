<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mebel.by - Выгодные предложения</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; min-height: 100vh; } 
        .header-bg { background-color: #ffffff; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); }
        .category-button {
            padding: 0.6rem 1.4rem; border: 2px solid #ffedd5; background-color: #ffffff;
            border-radius: 9999px; font-weight: 600; color: #4b5563; transition: all 0.3s ease;
            cursor: pointer; text-align: center; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.95rem; 
        }
        .category-button.active, .category-button:hover {
            border-color: #f97316; background-color: #f97316; color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(249,115,22,0.3); transform: translateY(-1px);
        }
        #category-filter::-webkit-scrollbar { display: none; }
        #category-filter { -ms-overflow-style: none; scrollbar-width: none; }
        .offer-card {
            background-color: white; border-radius: 1.25rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05),0 10px 10px -5px rgba(0,0,0,0.04);
            transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1); border: 1px solid #f3f4f6;
        }
        .offer-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1),0 15px 30px -5px rgba(0,0,0,0.08);
        }
        .card-button { background-color: #f97316; box-shadow: 0 4px 10px rgba(249,115,22,0.4); }
        .card-button:hover { background-color: #ea580c; }
    </style>
</head>
<body>

    <!-- Верхняя навигация -->
    <header class="sticky top-0 header-bg z-20">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Mebel.by</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-sm cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
                    <span id="current-city" class="font-bold text-gray-700">Гомель</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-600 cursor-pointer hover:text-orange-500 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <!-- Кнопка для входа/выхода админа. Стиль будет меняться JS -->
                <button id="admin-login-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition font-semibold">Админ</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 mt-6">
        <!-- Баннер (всегда виден) -->
        <div class="p-8 md:p-12 rounded-3xl bg-gradient-to-br from-orange-500 to-red-500 text-white shadow-2xl mb-8 relative overflow-hidden">
            <div class="relative z-10 text-center">
                <p class="text-xl font-medium text-white mb-2 tracking-wider">СКИДКИ ДО 50%</p>
                <h2 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Ваша Новая Кухня</h2>
                <p class="text-lg font-light max-w-lg mx-auto">Получите бесплатный 3D-проект и замер уже сегодня!</p>
                <button class="mt-6 bg-white text-orange-600 font-black py-3 px-8 rounded-full transition duration-300 shadow-lg hover:bg-gray-100 uppercase text-base">
                    Записаться на замер
                </button>
            </div>
        </div>

        <!-- ОСНОВНОЙ КОНТЕНТ (Скрывается, когда активна админ-панель) -->
        <div id="main-content-wrapper">
            <!-- Поиск -->
            <div class="relative mb-8">
                <input type="text" id="search-input" placeholder="Поиск: диван, шкаф, кухня..." class="w-full py-3.5 pl-14 pr-6 text-lg border-2 border-gray-200 rounded-full focus:ring-orange-500 focus:border-orange-500 transition duration-200" />
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>

            <!-- Категории -->
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Каталог</h3>
            <div id="category-filter" class="flex flex-nowrap overflow-x-auto space-x-3 pb-4 scrollbar-hide">
                <!-- Категории будут загружены сюда JavaScript'ом -->
            </div>

            <!-- Предложения -->
            <h3 class="text-2xl font-bold text-gray-800 my-6">Выгодные предложения</h3>
            <div id="offers-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
                <div id="no-offers" class="col-span-full text-center text-gray-500 hidden p-8">Предложений по вашему запросу не найдено.</div>
                <!-- Карточки товаров будут загружены сюда JavaScript'ом -->
            </div>
        </div>

        <!-- АДМИН ПАНЕЛЬ (Изначально скрыта) -->
        <div id="admin-panel" class="hidden">
            <h3 class="text-3xl font-black text-gray-900 mb-6 border-b pb-3 border-gray-200">Панель Управления Товарами</h3>
            
            <!-- Форма добавления нового товара -->
            <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 mb-8">
                <h4 class="text-xl font-bold text-orange-600 mb-4">Добавить Новый Товар</h4>
                <div id="admin-product-message" class="text-sm font-medium my-3 p-3 rounded hidden"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="product-title" placeholder="Название товара (Диван 'Уют')" class="p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition" />
                    
                    <select id="product-category" class="p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition">
                        <option value="" disabled selected>Выберите категорию</option>
                        <option value="Диваны">Диваны</option>
                        <option value="Кровати">Кровати</option>
                        <option value="Шкафы">Шкафы</option>
                        <option value="Столы и Стулья">Столы и Стулья</option>
                        <option value="Кухни">Кухни</option>
                        <option value="Прочее">Прочее</option>
                    </select>
                    
                    <input type="number" id="product-price" placeholder="Базовая цена (₽)" class="p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition" min="0"/>
                    <input type="number" id="product-discount" placeholder="Скидка (%)" class="p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition" min="0" max="100" value="0"/>
                    
                    <input type="text" id="product-image-url" placeholder="URL изображения (Необязательно)" class="p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition col-span-full" />
                </div>
                
                <button id="add-product-btn" class="mt-5 w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 transition">
                    Добавить Товар
                </button>
            </div>

            <!-- Список текущих товаров для администрирования -->
            <h4 class="text-xl font-bold text-gray-800 mb-4">Текущие Товары</h4>
            <div id="admin-offers-list" class="space-y-4">
                <div class="text-gray-500 p-4 bg-gray-50 rounded-lg">Загрузка товаров...</div>
            </div>
        </div>
    </main>

    <!-- Модальное окно админа -->
    <div id="admin-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 w-80 relative shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Вход Админа</h3>
            <!-- Контейнер для сообщений об ошибках -->
            <div id="admin-message" class="text-sm text-center font-medium my-2 hidden p-2 rounded"></div>
            
            <input type="email" id="admin-email" placeholder="Email" class="w-full mb-3 p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition" />
            <input type="password" id="admin-password" placeholder="Пароль" class="w-full mb-4 p-3 border rounded-xl focus:ring-orange-500 focus:border-orange-500 transition" />
            <div class="flex justify-between space-x-2">
                <button id="admin-register" class="flex-1 bg-green-500 text-white px-3 py-2 rounded-xl hover:bg-green-600 transition font-semibold">Регистрация</button>
                <button id="admin-login" class="flex-1 bg-orange-500 text-white px-3 py-2 rounded-xl hover:bg-orange-600 transition font-semibold">Войти</button>
            </div>
            <button id="admin-close" class="absolute top-3 right-3 text-2xl text-gray-400 hover:text-gray-600 leading-none">&times;</button>
        </div>
    </div>
    
    <!-- Custom Message Modal (Замена alert) -->
    <div id="custom-message-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full relative text-center shadow-xl">
            <p id="custom-message-text" class="text-gray-700 mb-4 text-lg font-medium"></p>
            <button id="custom-message-close" class="bg-orange-500 text-white px-6 py-2 rounded-xl hover:bg-orange-600 transition font-semibold">ОК</button>
        </div>
    </div>

    <!-- JavaScript логика -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Устанавливаем режим отладки для Firestore
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION & AUTH VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Резервная конфигурация
        const USER_FALLBACK_CONFIG = {
            apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
            authDomain: "vsemmebel-90d48.firebaseapp.com",
            projectId: "vsemmebel-90d48",
            storageBucket: "vsemmebel-90d48.firebasestorage.app",
            messagingSenderId: "958123504041",
            appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
        };
        
        let firebaseConfig = USER_FALLBACK_CONFIG;

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const envConfig = JSON.parse(__firebase_config);
                if (typeof envConfig === 'object' && envConfig !== null && envConfig.projectId) {
                    firebaseConfig = envConfig;
                }
            }
        } catch (e) {
            console.warn("Предупреждение: Не удалось распарсить JSON из переменной хостинга. Используется предоставленная конфигурация.", e);
        }

        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        const productCollectionPath = `artifacts/${appId}/public/data/offers`;

        // 1. Инициализация Firebase
        function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("КРИТИЧЕСКАЯ ОШИБКА: Конфигурация Firebase недоступна.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                console.log("Firebase успешно инициализирован.");
            } catch (e) {
                console.error("КРИТИЧЕСКАЯ ОШИБКА: Ошибка инициализации Firebase.", e);
                db = null; auth = null;
            }
        }

        // --- DOM Elements ---
        const adminModal = document.getElementById('admin-modal');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminCloseBtn = document.getElementById('admin-close');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLogin = document.getElementById('admin-login');
        const adminRegister = document.getElementById('admin-register');
        const adminMessageDiv = document.getElementById('admin-message');

        const customModal = document.getElementById('custom-message-modal');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageCloseBtn = document.getElementById('custom-message-close');

        const categoryFilterDiv = document.getElementById('category-filter');
        const offersListDiv = document.getElementById('offers-list');
        const searchInput = document.getElementById('search-input');
        const noOffersDiv = document.getElementById('no-offers');

        // Admin Panel specific elements
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const adminPanelDiv = document.getElementById('admin-panel');
        const addProductBtn = document.getElementById('add-product-btn');
        const adminProductMessageDiv = document.getElementById('admin-product-message');
        const adminOffersListDiv = document.getElementById('admin-offers-list');

        let allOffers = []; 
        let currentCategory = "Все товары";
        let searchTerm = "";
        const CATEGORIES = ["Все товары", "Диваны", "Кровати", "Шкафы", "Столы и Стулья", "Кухни"];

        // --- Custom Message Modal (Замена alert/confirm) ---
        function closeCustomMessage() { customModal.classList.add('hidden'); }
        function showCustomMessage(message) {
            customMessageText.textContent = message;
            customModal.classList.remove('hidden');
        }
        customMessageCloseBtn.onclick = closeCustomMessage;

        // --- Admin Message Display ---
        function showAdminMessage(message, isError = false) {
            adminMessageDiv.textContent = message;
            adminMessageDiv.classList.remove('hidden');
            if (isError) {
                adminMessageDiv.className = 'text-sm text-center font-medium my-2 p-2 rounded bg-red-100 text-red-700';
            } else {
                adminMessageDiv.className = 'text-sm text-center font-medium my-2 p-2 rounded bg-green-100 text-green-700';
            }
        }
        
        function showProductMessage(message, isError = false) {
            adminProductMessageDiv.textContent = message;
            adminProductMessageDiv.classList.remove('hidden');
            adminProductMessageDiv.className = `text-sm font-medium my-3 p-3 rounded ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        }

        // --- UI Update (Admin/Public mode switch) ---
        function updateUIForAuth(user) {
            const isAdmin = user && user.email && !user.isAnonymous;
            
            if (isAdmin) {
                // Admin Mode
                adminLoginBtn.textContent = 'Выход';
                adminLoginBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                adminLoginBtn.classList.add('bg-gray-700', 'hover:bg-gray-800');
                
                if (mainContentWrapper) mainContentWrapper.classList.add('hidden');
                if (adminPanelDiv) adminPanelDiv.classList.remove('hidden');

                // Render admin list on view switch
                renderAdminOffersList(allOffers);
                
            } else {
                // Public Mode
                adminLoginBtn.textContent = 'Админ';
                adminLoginBtn.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                adminLoginBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                
                if (mainContentWrapper) mainContentWrapper.classList.remove('hidden');
                if (adminPanelDiv) adminPanelDiv.classList.add('hidden');
            }
        }


        // 2. Инициализация аутентификации (вход анонимно или по токену)
        async function initializeAuth() {
            if (!auth) {
                userId = crypto.randomUUID();
                return; 
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }
                
                // Слушаем изменения состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    userId = user?.uid || crypto.randomUUID();
                    updateUIForAuth(user); // Обновляем UI
                    console.log("Аутентификация успешна. UID:", userId);
                    setupRealtimeOffersListener(); // Запускаем загрузку данных
                });

            } catch (error) {
                console.error("Ошибка аутентификации Firebase:", error);
                showCustomMessage("Ошибка аутентификации. Проверьте консоль для деталей.");
            }
        }

        // --- Admin Login/Logout Handlers ---
        
        // Admin Button Click (Toggle Modal or Logout)
        adminLoginBtn.onclick = async () => {
            if (auth && auth.currentUser && !auth.currentUser.isAnonymous) {
                // Если админ вошел, делаем выход
                try {
                    await auth.signOut();
                    updateUIForAuth(null); // Переключаемся в публичный режим
                    showCustomMessage('Вы успешно вышли из режима администратора.');
                } catch (error) {
                    console.error("Ошибка выхода:", error);
                    showCustomMessage('Ошибка при выходе. Проверьте консоль.', true);
                }
            } else {
                // Показываем модальное окно входа
                adminMessageDiv.classList.add('hidden'); // Очищаем сообщение
                adminModal.classList.remove('hidden');
            }
        };

        adminCloseBtn.onclick = () => adminModal.classList.add('hidden');

        // Вход Админа
        adminLogin.onclick = async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            if (!email || !password) return showAdminMessage('Введите email и пароль', true);
            if (!auth) return showAdminMessage('Ошибка: Firebase Auth не инициализирован. Проверьте консоль.', true);

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                adminModal.classList.add('hidden');
                updateUIForAuth(userCredential.user); // Переключаемся в админ-режим (сообщение не показываем)
            } catch (error) {
                console.error("Ошибка входа админа:", error);
                let errorMessage = 'Ошибка входа. Проверьте данные.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Пользователь с таким email не найден.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Неверный пароль.';
                }
                showAdminMessage(errorMessage, true);
            }
        };

        // Регистрация Админа
        adminRegister.onclick = async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            if (!email || !password) return showAdminMessage('Введите email и пароль', true);
            if (!auth) return showAdminMessage('Ошибка: Firebase Auth не инициализирован. Проверьте консоль.', true);

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                adminModal.classList.add('hidden');
                updateUIForAuth(userCredential.user); // Переключаемся в админ-режим (сообщение не показываем)
            } catch (error) {
                console.error("Ошибка регистрации админа:", error);
                let errorMessage = 'Ошибка регистрации.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Этот email уже используется.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Пароль должен быть не менее 6 символов.';
                }
                showAdminMessage(errorMessage, true);
            }
        };

        // --- Data Loading and Filtering ---

        // Установка слушателя Firestore для получения данных
        function setupRealtimeOffersListener() {
            if (!db) return;

            const offersRef = collection(db, productCollectionPath);
            const q = query(offersRef);

            onSnapshot(q, (snapshot) => {
                const fetchedOffers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const activeCombo = data.combinations?.find(c => c.isActive);
                    
                    if (activeCombo) {
                        fetchedOffers.push({
                            id: doc.id,
                            title: data.title || 'Товар без названия',
                            category: data.category || 'Прочее',
                            imageUrl: data.images?.[0] || `https://placehold.co/400x300/f3f4f6/4b5563?text=${encodeURIComponent(data.title || 'Нет Фото')}`,
                            discount: data.discount || 0,
                            originalPrice: activeCombo.price || 0, 
                            finalPrice: activeCombo.price * (1 - (data.discount || 0) / 100),
                        });
                    }
                });
                
                allOffers = fetchedOffers;
                console.log(`Загружено ${allOffers.length} активных товаров.`);
                
                // Рендерим для публичного просмотра
                renderOffers(); 
                
                // Рендерим для админ-панели, если она активна
                if (adminPanelDiv && !adminPanelDiv.classList.contains('hidden')) {
                    renderAdminOffersList(allOffers);
                }

            }, (error) => {
                console.error("Ошибка получения товаров из Firestore:", error);
                showCustomMessage("Не удалось загрузить товары. Проверьте консоль.");
            });
        }

        // --- Render Functions ---

        function renderCategories() {
            categoryFilterDiv.innerHTML = '';
            CATEGORIES.forEach(category => {
                const button = document.createElement('button');
                button.className = `category-button ${category === currentCategory ? 'active' : ''}`;
                button.textContent = category;
                button.onclick = () => {
                    setActiveCategory(category);
                };
                categoryFilterDiv.appendChild(button);
            });
        }

        function setActiveCategory(category) {
            currentCategory = category;
            renderCategories(); // Обновить стили кнопок
            renderOffers();    // Применить фильтр
        }

        function renderOffers() {
            offersListDiv.innerHTML = '';
            
            // 1. Фильтр по категории
            const filteredByCategory = currentCategory === "Все товары"
                ? allOffers
                : allOffers.filter(offer => offer.category === currentCategory);

            // 2. Фильтр по поисковому запросу
            const filteredBySearch = searchTerm.trim().toLowerCase();
            const finalOffers = filteredByCategory.filter(offer => 
                offer.title.toLowerCase().includes(filteredBySearch) || 
                offer.category.toLowerCase().includes(filteredBySearch)
            );

            if (finalOffers.length === 0) {
                noOffersDiv.classList.remove('hidden');
                return;
            }
            noOffersDiv.classList.add('hidden');

            // 3. Рендеринг карточек
            finalOffers.forEach(offer => {
                const card = document.createElement('div');
                card.className = 'offer-card flex flex-col';

                const priceDisplay = offer.discount > 0 ? 
                    `
                    <p class="text-xl font-extrabold text-red-600">${Math.round(offer.finalPrice)} ₽</p>
                    <p class="text-sm text-gray-400 line-through">${Math.round(offer.originalPrice)} ₽</p>
                    ` : 
                    `<p class="text-xl font-extrabold text-gray-900">${Math.round(offer.finalPrice)} ₽</p>`;

                card.innerHTML = `
                    <div class="h-48 overflow-hidden relative">
                        <!-- Изображение с заглушкой -->
                        <img 
                            src="${offer.imageUrl}" 
                            alt="${offer.title}" 
                            class="w-full h-full object-cover transition duration-500 ease-in-out hover:scale-105"
                            onerror="this.onerror=null; this.src='https://placehold.co/400x300/f3f4f6/4b5563?text=Нет+Фото';"
                        >
                        ${offer.discount > 0 ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">- ${offer.discount}%</div>` : ''}
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <p class="text-sm font-semibold text-orange-600 mb-1">${offer.category}</p>
                        <h4 class="text-lg font-bold text-gray-900 mb-3 flex-grow">${offer.title}</h4>
                        <div class="flex items-end justify-between mt-auto">
                            <div class="flex items-center space-x-2">
                                ${priceDisplay}
                            </div>
                            <button class="card-button text-white text-sm font-bold py-2 px-4 rounded-full transition">
                                Заказать
                            </button>
                        </div>
                    </div>
                `;
                offersListDiv.appendChild(card);
            });
        }
        
        // Рендеринг списка товаров для Админ Панели
        function renderAdminOffersList(offers) {
            adminOffersListDiv.innerHTML = '';
            if (offers.length === 0) {
                adminOffersListDiv.innerHTML = '<div class="text-gray-500 p-4 bg-gray-50 rounded-lg">Пока нет загруженных активных товаров.</div>';
                return;
            }

            offers.forEach(offer => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-100';
                
                const originalPrice = Math.round(offer.originalPrice);
                const finalPrice = Math.round(offer.finalPrice);
                
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${offer.title}</p>
                        <p class="text-xs text-orange-600">${offer.category}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="text-sm font-bold text-gray-700">${finalPrice} ₽</p>
                        ${offer.discount > 0 ? `<p class="text-xs text-red-500">Скидка: ${offer.discount}%</p>` : ''}
                    </div>
                `;
                
                adminOffersListDiv.appendChild(item);
            });
        }


        // --- Admin Product Addition Logic ---
        addProductBtn.onclick = async () => {
            if (!auth || !db || auth.currentUser.isAnonymous) {
                return showProductMessage('Ошибка: Войдите как администратор для добавления товаров.', true);
            }
            
            const title = document.getElementById('product-title').value.trim();
            const category = document.getElementById('product-category').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const discount = parseInt(document.getElementById('product-discount').value) || 0;
            const imageUrl = document.getElementById('product-image-url').value.trim();

            if (!title || !category || isNaN(price) || price <= 0) {
                return showProductMessage('Пожалуйста, заполните Название, Категорию и корректную Цену.', true);
            }

            const newProduct = {
                title: title,
                category: category,
                discount: discount,
                images: imageUrl ? [imageUrl] : [],
                combinations: [{
                    name: 'Стандарт',
                    price: price,
                    isActive: true, 
                    attributes: {},
                }],
                createdAt: new Date(),
                updatedBy: auth.currentUser.uid
            };

            try {
                const offersRef = collection(db, productCollectionPath);
                await addDoc(offersRef, newProduct);
                
                showProductMessage('Товар успешно добавлен!');
                
                // Очистка формы
                document.getElementById('product-title').value = '';
                document.getElementById('product-category').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-discount').value = '0';
                document.getElementById('product-image-url').value = '';

            } catch (error) {
                console.error("Ошибка добавления товара:", error);
                showProductMessage(`Ошибка добавления товара: ${error.message}`, true);
            }
        };


        // --- Event Listeners ---
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderOffers();
        });


        // --- Initialization ---

        initializeFirebase();
        initializeAuth(); // Аутентификация -> onAuthStateChanged -> updateUIForAuth -> setupRealtimeOffersListener

        window.onload = () => {
            renderCategories(); // Рендерим кнопки категорий
        };

    </script>
</body>
</html>
