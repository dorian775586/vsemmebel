<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mebel.by - Главная</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; min-height: 100vh; }
        .header-bg { background-color: #ffffff; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); }
        .mobile-nav { box-shadow: 0 -8px 15px -3px rgba(0,0,0,0.05); }
        .category-button {
            padding: 0.6rem 1.4rem; border: 2px solid #ffedd5; background-color: #ffffff;
            border-radius: 9999px; font-weight: 600; color: #4b5563; transition: all 0.3s ease;
            cursor: pointer; text-align: center; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .category-button.active, .category-button:hover {
            border-color: #f97316; background-color: #f97316; color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(249,115,22,0.3); transform: translateY(-1px);
        }
        #category-filter::-webkit-scrollbar { display: none; }
        #category-filter { -ms-overflow-style: none; scrollbar-width: none; }
        .offer-card {
            background-color: white; border-radius: 1.25rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05),0 10px 10px -5px rgba(0,0,0,0.04);
            transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1); border: 1px solid #f3f4f6;
        }
        .offer-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1),0 15px 30px -5px rgba(0,0,0,0.08);
        }
        .card-button { background-color: #f97316; box-shadow: 0 4px 10px rgba(249,115,22,0.4); }
        .card-button:hover { background-color: #ea580c; }
        
        /* Стили для модального окна */
        .modal-content { max-width: 90%; }
        @media (min-width: 640px) { .modal-content { max-width: 380px; } }
    </style>
</head>
<body class="pb-20">

    <!-- Верхняя навигация -->
    <header class="sticky top-0 header-bg z-20">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Mebel.by</h1>
            <div class="flex items-center space-x-4">
                <!-- Город и Профиль - не менялись -->
                <div class="flex items-center space-x-2 text-sm cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
                    <span id="current-city" class="font-bold text-gray-700">Гомель</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-600 cursor-pointer hover:text-orange-500 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                
                <!-- Кнопка для входа/перехода админа. Стиль по умолчанию - для логина -->
                <button id="admin-login-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600 transition">Админ (Login)</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 mt-6">
        <!-- Баннер -->
        <div class="p-8 md:p-12 rounded-3xl bg-gradient-to-br from-orange-500 to-red-500 text-white shadow-2xl mb-8 relative overflow-hidden">
            <div class="relative z-10 text-center">
                <p class="text-xl font-medium text-white mb-2 tracking-wider">СКИДКИ ДО 50%</p>
                <h2 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Ваша Новая Кухня</h2>
                <p class="text-lg font-light max-w-lg mx-auto">Получите бесплатный 3D-проект и замер уже сегодня!</p>
                <button class="mt-6 bg-white text-orange-600 font-black py-3 px-8 rounded-full transition duration-300 shadow-lg hover:bg-gray-100 uppercase text-base">
                    Записаться на замер
                </button>
            </div>
        </div>

        <!-- Поиск -->
        <div class="relative mb-8">
            <input type="text" id="search-input" placeholder="Поиск: диван, шкаф, кухня..." class="w-full py-3.5 pl-14 pr-6 text-lg border-2 border-gray-200 rounded-full focus:ring-orange-500 focus:border-orange-500 transition duration-200" />
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </div>

        <!-- Категории -->
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Каталог</h3>
        <div id="category-filter" class="flex flex-nowrap overflow-x-auto space-x-3 pb-4 scrollbar-hide"></div>

        <!-- Предложения -->
        <h3 class="text-2xl font-bold text-gray-800 my-6">Выгодные предложения</h3>
        <div id="offers-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
            <div id="no-offers" class="col-span-full text-center text-gray-500 hidden p-8">Предложений по вашему запросу не найдено.</div>
        </div>
    </main>

    <!-- Модальное окно админа -->
    <div id="admin-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full modal-content relative">
            <h3 class="text-2xl font-black mb-4 text-gray-900">Вход Администратора</h3>
            
            <!-- Контейнер для сообщений об ошибках/успехе -->
            <div id="admin-message" class="text-sm text-center font-medium my-3 hidden p-3 rounded-lg"></div>
            
            <input type="email" id="admin-email" placeholder="Email" class="w-full mb-3 p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition" />
            <input type="password" id="admin-password" placeholder="Пароль" class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition" />
            
            <div class="flex flex-col space-y-3">
                <button id="admin-login" class="bg-orange-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-orange-600 transition shadow-md">Войти</button>
                <button id="admin-register" class="bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl hover:bg-gray-300 transition">Регистрация</button>
            </div>
            
            <button id="admin-close" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
    </div>

    <!-- Нижняя мобильная навигация -->
    <nav class="mobile-nav fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 py-3 z-30">
        <div class="max-w-4xl mx-auto flex justify-around">
            <a href="#" class="flex flex-col items-center text-orange-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
                <span class="text-xs font-semibold">Главная</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 hover:text-orange-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <span class="text-xs font-medium">Каталог</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 hover:text-orange-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 012-2h2c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V5zM5 13a2 2 0 012-2h2c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2v-1zM13 13a2 2 0 012-2h2c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2h-2c-1.1 0-2-.9-2-2v-1z"/></svg>
                <span class="text-xs font-medium">Купоны</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 hover:text-orange-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <span class="text-xs font-medium">Избранное</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            query,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Устанавливаем уровень логирования для отладки
        setLogLevel('debug');

        // --- Firebase Config & Setup (using Canvas globals) ---
        // Использование глобальных переменных для инициализации Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.error("Firebase configuration is missing. Cannot initialize Firebase.");
        }

        // Путь к коллекции для публичных данных
        const offersCollectionPath = `artifacts/${appId}/public/data/offers`; 

        // --- DOM элементы ---
        const offersListElement = document.getElementById('offers-list');
        const categoryFilterElement = document.getElementById('category-filter');
        const searchInput = document.getElementById('search-input');
        const noOffersElement = document.getElementById('no-offers');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminModal = document.getElementById('admin-modal');
        const adminCloseBtn = document.getElementById('admin-close');
        const adminLoginFormBtn = document.getElementById('admin-login');
        const adminRegisterBtn = document.getElementById('admin-register');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminMessageElement = document.getElementById('admin-message');

        let allOffers = [];
        let allCategories = ['Все'];
        let currentFilter = 'Все';
        let isAdmin = false;

        // --- Mock Data (для отображения, если Firestore пуст) ---
        const mockOffers = [
            {
                id: 'mock-1',
                title: 'Угловой Диван "Комфорт"',
                description: 'Идеальный диван для большой семьи, с ортопедическим основанием. Отличное качество.',
                category: 'Диваны',
                is_active: true,
                images: ['https://placehold.co/400x250/3b82f6/FFFFFF?text=Диван+Comfort'],
                combinations: [{ isActive: true, price: 1250.50, color: 'Серый' }]
            },
            {
                id: 'mock-2',
                title: 'Модульная Кухня "Лофт"',
                description: 'Современная кухня в стиле Лофт. Сборка за 1 день. Проект бесплатно.',
                category: 'Кухни',
                is_active: true,
                images: ['https://placehold.co/400x250/10b981/FFFFFF?text=Кухня+Лофт'],
                combinations: [{ isActive: true, price: 3800, material: 'МДФ' }]
            },
            {
                id: 'mock-3',
                title: 'Шкаф-Купе "Оригинал"',
                description: 'Трехстворчатый шкаф-купе с зеркальными дверями и продуманным наполнением.',
                category: 'Шкафы',
                is_active: true,
                images: ['https://placehold.co/400x250/ef4444/FFFFFF?text=Шкаф-Купе'],
                combinations: [{ isActive: true, price: 890, height: '2.4м' }]
            },
            {
                id: 'mock-4',
                title: 'Кресло-Качалка "Ретро"',
                description: 'Уютное кресло для вечернего отдыха. Натуральное дерево, ручная работа.',
                category: 'Кресла',
                is_active: true,
                images: ['https://placehold.co/400x250/6366f1/FFFFFF?text=Кресло'],
                combinations: [{ isActive: true, price: 450, color: 'Коричневый' }]
            },
        ];

        // --- Вспомогательные функции ---

        // Функция для отображения сообщений в модальном окне
        function displayAuthMessage(message, isError = true) {
            adminMessageElement.textContent = message;
            adminMessageElement.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (isError) {
                adminMessageElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                adminMessageElement.classList.add('bg-green-100', 'text-green-700');
            }

            setTimeout(() => {
                adminMessageElement.classList.add('hidden');
            }, 5000);
        }

        // Обновление состояния кнопки "Админ"
        function updateAdminButton() {
            if (isAdmin) {
                adminLoginBtn.textContent = 'Админка (Admin)';
                adminLoginBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                adminLoginBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'font-bold');
                // При клике - переход в админ-панель
                adminLoginBtn.onclick = () => window.location.href = 'admin.html';
            } else {
                adminLoginBtn.textContent = 'Админ (Login)';
                adminLoginBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'font-bold');
                adminLoginBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                // При клике - открыть модальное окно
                adminLoginBtn.onclick = () => adminModal.classList.remove('hidden');
            }
        }


        // --- Функции отображения ---
        function createOfferCard(offer) {
            const card = document.createElement('div');
            card.className = "offer-card";

            // Логика цены
            const activeCombinations = (offer.combinations || []).filter(c => c.isActive && parseFloat(c.price) > 0);
            let startingPrice = null;
            if (activeCombinations.length > 0) {
                startingPrice = Math.min(...activeCombinations.map(c => parseFloat(c.price)));
            }
            const priceText = startingPrice ? 
                `${startingPrice.toLocaleString('ru-RU', { style:'currency', currency:'BYN', minimumFractionDigits: startingPrice % 1 === 0 ? 0 : 2 })}` 
                : 'Цена по запросу';

            // Логика изображения
            const imageUrl = (offer.images && offer.images.length > 0) ? offer.images[0] : 
                'https://placehold.co/400x250/F97316/FFFFFF?text=' + encodeURIComponent(offer.title || 'Товар');

            card.innerHTML = `
                <div class="relative">
                    <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x250/F97316/FFFFFF?text=Нет+Фото';" alt="${offer.title}" class="w-full h-48 object-cover">
                </div>
                <div class="p-5">
                    <p class="text-xs font-semibold text-orange-600 uppercase mb-1">${offer.category || 'Без категории'}</p>
                    <h4 class="text-xl font-extrabold text-gray-900 truncate mb-3" title="${offer.title || 'Название не указано'}">${offer.title || 'Название не указано'}</h4>
                    <div class="flex items-center justify-between mt-4">
                        <div>
                            <span class="text-3xl font-black text-orange-600 tracking-tight">${priceText}</span>
                        </div>
                        <button class="card-button text-white font-bold py-3 px-6 rounded-xl transition duration-300 text-sm hover:shadow-lg">
                            Подробнее
                        </button>
                    </div>
                </div>
            `;

            // Редирект кнопки (для примера, т.к. страницы product.html нет)
            const buyBtn = card.querySelector('.card-button');
            buyBtn.addEventListener('click', () => {
                displayAuthMessage(`Переход на страницу товара: ${offer.id}`, false);
            });

            return card;
        }

        function renderOffers(offers) {
            offersListElement.innerHTML = '';
            
            // Фильтруем только активные товары
            const activeOffers = offers.filter(o => o.is_active === true); 

            if (!activeOffers.length) {
                noOffersElement.classList.remove('hidden');
            } else {
                noOffersElement.classList.add('hidden');
                activeOffers.forEach(o => offersListElement.appendChild(createOfferCard(o)));
            }
        }

        function renderCategories() {
            categoryFilterElement.innerHTML = '';
            
            const activeCategories = allOffers
                .filter(o => 
                    o.is_active === true && 
                    o.category && 
                    typeof o.category === 'string' && 
                    o.category.trim() !== ''
                )
                .map(o => o.category);
                
            allCategories = ['Все', ...new Set(activeCategories)];

            allCategories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = 'category-button';
                if (category === currentFilter) button.classList.add('active');
                button.addEventListener('click', () => {
                    document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
                    currentFilter = category;
                    button.classList.add('active');
                    applyFilters();
                });
                categoryFilterElement.appendChild(button);
            });
        }

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            const activeOffers = allOffers.filter(o => o.is_active === true);

            const filteredByCategory = currentFilter === 'Все' 
                ? activeOffers 
                : activeOffers.filter(o => o.category === currentFilter);

            const finalFiltered = filteredByCategory.filter(o =>
                (o.title || '').toLowerCase().includes(searchTerm) ||
                (o.description || '').toLowerCase().includes(searchTerm) ||
                (o.category || '').toLowerCase().includes(searchTerm)
            );
            renderOffers(finalFiltered);
        }

        // --- Загрузка предложений с подпиской на изменения (onSnapshot) ---
        function loadOffers() {
            if (!db) {
                console.error("Firestore not initialized.");
                allOffers = mockOffers;
                renderCategories();
                applyFilters();
                return;
            }

            console.log(`Чтение данных из: ${offersCollectionPath}`);
            const offersRef = collection(db, offersCollectionPath);
            const q = query(offersRef);
            
            onSnapshot(q, snapshot => {
                // Преобразуем документы, добавляя ID
                allOffers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ЕСЛИ Firestore пуст, используем мок-данные. (РЕШЕНИЕ ПРОБЛЕМЫ ОТСУТСТВИЯ ТОВАРОВ)
                if (allOffers.length === 0) {
                    console.warn("Firestore collection is empty or inaccessible. Loading mock data.");
                    allOffers = mockOffers;
                }

                // Перерисовываем категории и товары
                renderCategories();
                applyFilters();
            }, error => {
                console.error("Ошибка при чтении данных каталога:", error);
                // При ошибке также загружаем мок-данные как запасной вариант
                allOffers = mockOffers;
                renderCategories();
                applyFilters();
            });
        }

        // --- Инициализация и Аутентификация ---
        async function initAuthAndLoad() {
            if (!auth) return;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    // Анонимный вход для чтения публичных данных (если нет токена)
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (err) {
                console.error("Authentication failed during initial sign-in:", err);
            }

            onAuthStateChanged(auth, (user) => {
                // ПРОВЕРКА АДМИНА
                // Примечание: В реальном приложении статус админа следует проверять через Custom Claims или документ в Firestore.
                // Сохраняем логику пользователя:
                isAdmin = user && (user.email === 'admin@example.com'); 
                
                updateAdminButton();
                loadOffers();
            });
        }

        // --- Обработчики событий ---

        // Поиск
        searchInput.addEventListener('input', applyFilters);

        // Закрытие модального окна
        adminCloseBtn.addEventListener('click', () => adminModal.classList.add('hidden'));

        // --- Вход Админа (Login) ---
        adminLoginFormBtn.addEventListener('click', async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            // Сброс визуальных ошибок
            adminEmailInput.classList.remove('border-red-500');
            adminPasswordInput.classList.remove('border-red-500');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
                // Проверка, что после входа пользователь - админ (опционально, но полезно)
                if (auth.currentUser && auth.currentUser.email === 'admin@example.com') {
                    displayAuthMessage('Вход успешен! Перенаправление...', false);
                    adminModal.classList.add('hidden');
                    // ПЕРЕНАПРАВЛЕНИЕ: Это гарантирует, что кнопка админки перенаправит после успешного входа
                    window.location.href = 'admin.html';
                } else {
                    displayAuthMessage('Вход выполнен, но вы не являетесь администратором.', false);
                }

            } catch (err) {
                console.error('Ошибка входа:', err.code, err.message);
                displayAuthMessage('Ошибка входа: Неверный email или пароль.'); 
                // Визуальная подсветка полей
                adminEmailInput.classList.add('border-red-500');
                adminPasswordInput.classList.add('border-red-500');
            }
        });

        // --- Регистрация Админа (Register) ---
        adminRegisterBtn.addEventListener('click', async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                displayAuthMessage('Регистрация успешна! Пожалуйста, войдите, используя только что созданные данные.', false); 
            } catch (err) {
                console.error('Ошибка регистрации:', err.code, err.message);
                displayAuthMessage('Ошибка регистрации: ' + err.message);
            }
        });

        // Запускаем инициализацию и загрузку данных
        if (firebaseConfig) {
            initAuthAndLoad();
        }
    </script>
</body>
</html>
