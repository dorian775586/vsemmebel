<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mebel.bel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Убран pb-20 из body */
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; min-height: 100vh; } 
        .header-bg { background-color: #ffffff; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); }
        /* mobile-nav больше не нужен, но оставляем на случай, если вы добавите его позже */
        .mobile-nav { box-shadow: 0 -8px 15px -3px rgba(0,0,0,0.05); } 
        .category-button {
            padding: 0.6rem 1.4rem; border: 2px solid #ffedd5; background-color: #ffffff;
            border-radius: 9999px; font-weight: 600; color: #4b5563; transition: all 0.3s ease;
            cursor: pointer; text-align: center; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.95rem; /* Немного уменьшил размер шрифта */
        }
        .category-button.active, .category-button:hover {
            border-color: #f97316; background-color: #f97316; color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(249,115,22,0.3); transform: translateY(-1px);
        }
        #category-filter::-webkit-scrollbar { display: none; }
        #category-filter { -ms-overflow-style: none; scrollbar-width: none; }
        .offer-card {
            background-color: white; border-radius: 1.25rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05),0 10px 10px -5px rgba(0,0,0,0.04);
            transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1); border: 1px solid #f3f4f6;
        }
        .offer-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1),0 15px 30px -5px rgba(0,0,0,0.08);
        }
        .card-button { background-color: #f97316; box-shadow: 0 4px 10px rgba(249,115,22,0.4); }
        .card-button:hover { background-color: #ea580c; }
    </style>
</head>
<body>

    <!-- Верхняя навигация -->
    <header class="sticky top-0 header-bg z-20">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Mebel.by</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-sm cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition">
                    <span id="current-city" class="font-bold text-gray-700">Гомель</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-600 cursor-pointer hover:text-orange-500 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <!-- Кнопка для входа админа -->
                <button id="admin-login-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Админ</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 mt-6">
        <!-- Баннер -->
        <div class="p-8 md:p-12 rounded-3xl bg-gradient-to-br from-orange-500 to-red-500 text-white shadow-2xl mb-8 relative overflow-hidden">
            <div class="relative z-10 text-center">
                <p class="text-xl font-medium text-white mb-2 tracking-wider">СКИДКИ ДО 50%</p>
                <h2 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Ваша Новая Кухня</h2>
                <p class="text-lg font-light max-w-lg mx-auto">Получите бесплатный 3D-проект и замер уже сегодня!</p>
                <button class="mt-6 bg-white text-orange-600 font-black py-3 px-8 rounded-full transition duration-300 shadow-lg hover:bg-gray-100 uppercase text-base">
                    Записаться на замер
                </button>
            </div>
        </div>

        <!-- Поиск -->
        <div class="relative mb-8">
            <input type="text" id="search-input" placeholder="Поиск: диван, шкаф, кухня..." class="w-full py-3.5 pl-14 pr-6 text-lg border-2 border-gray-200 rounded-full focus:ring-orange-500 focus:border-orange-500 transition duration-200" />
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute left-5 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <!-- Категории -->
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Каталог</h3>
        <div id="category-filter" class="flex flex-nowrap overflow-x-auto space-x-3 pb-4 scrollbar-hide">
            <!-- Категории будут загружены сюда JavaScript'ом -->
        </div>

        <!-- Предложения -->
        <h3 class="text-2xl font-bold text-gray-800 my-6">Выгодные предложения</h3>
        <div id="offers-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
            <div id="no-offers" class="col-span-full text-center text-gray-500 hidden p-8">Предложений по вашему запросу не найдено.</div>
            <!-- Карточки товаров будут загружены сюда JavaScript'ом -->
        </div>
    </main>

    <!-- Модальное окно админа -->
    <div id="admin-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 w-80 relative">
            <h3 class="text-xl font-bold mb-4">Вход Админа</h3>
            <!-- Контейнер для сообщений об ошибках -->
            <div id="admin-message" class="text-sm text-center font-medium my-2 hidden p-2 rounded"></div>
            
            <input type="email" id="admin-email" placeholder="Email" class="w-full mb-3 p-2 border rounded-lg" />
            <input type="password" id="admin-password" placeholder="Пароль" class="w-full mb-3 p-2 border rounded-lg" />
            <div class="flex justify-between">
                <button id="admin-register" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Регистрация</button>
                <button id="admin-login" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Войти</button>
            </div>
            <button id="admin-close" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">&times;</button>
        </div>
    </div>
    
    <div id="custom-message-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full relative text-center">
            <p id="custom-message-text" class="text-gray-700 mb-4"></p>
            <button id="custom-message-close" class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition">ОК</button>
        </div>
    </div>

    <!-- JavaScript логика -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Устанавливаем режим отладки для Firestore
        setLogLevel('Debug');

        // --- FIREBASE CONFIGURATION & AUTH VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

        // --- FALLBACK: HARDCODED CONFIGURATION (Используется для надежности) ---
        const HARDCODED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70", 
            authDomain: "vsemmebel-90d48.firebaseapp.com",
            projectId: "vsemmebel-90d48", 
            storageBucket: "vsemmebel-90d48.appspot.com", 
            messagingSenderId: "958123504041",
            appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
        };
        // ------------------------------------------

        let firebaseConfig = null;
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        const productCollectionPath = `artifacts/${appId}/public/data/offers`;

        // 1. Инициализация Firebase
        function initializeFirebase() {
            if (firebaseConfigString) {
                try {
                    firebaseConfig = JSON.parse(firebaseConfigString);
                } catch (e) {
                    console.error("ОШИБКА: Не удалось распарсить JSON из переменной хостинга.", e);
                }
            } 

            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "ВАШ_API_KEY") {
                firebaseConfig = HARDCODED_FIREBASE_CONFIG;
                console.warn("ВНИМАНИЕ: Используется хардкодированная конфигурация Firebase.");
            }

            if (firebaseConfig && firebaseConfig.apiKey) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase успешно инициализирован.");
                } catch (e) {
                    console.error("КРИТИЧЕСКАЯ ОШИБКА: Ошибка инициализации Firebase.", e);
                    db = null; 
                }
            } else {
                console.error("КРИТИЧЕСКАЯ ОШИБКА: Конфигурация Firebase недействительна.");
                db = null;
            }
        }

        // 2. Инициализация аутентификации
        async function initializeAuth() {
            if (!auth) {
                userId = crypto.randomUUID();
                return; 
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); 
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Аутентификация успешна. UID:", userId);
                // Запуск загрузки данных после успешной аутентификации
                setupRealtimeOffersListener();
            } catch (error) {
                console.error("Ошибка аутентификации Firebase:", error);
                showCustomMessage("Ошибка аутентификации. Проверьте консоль для деталей.");
            }
        }

        // --- Custom Message Modal (Замена alert/confirm) ---
        const customModal = document.getElementById('custom-message-modal');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageCloseBtn = document.getElementById('custom-message-close');

        function closeCustomMessage() {
            customModal.classList.add('hidden');
        }

        function showCustomMessage(message) {
            customMessageText.textContent = message;
            customModal.classList.remove('hidden');
        }

        customMessageCloseBtn.onclick = closeCustomMessage;

        // --- Admin Login Modal Logic ---
        const adminModal = document.getElementById('admin-modal');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminCloseBtn = document.getElementById('admin-close');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLogin = document.getElementById('admin-login');
        const adminRegister = document.getElementById('admin-register');
        const adminMessageDiv = document.getElementById('admin-message');

        adminLoginBtn.onclick = () => adminModal.classList.remove('hidden');
        adminCloseBtn.onclick = () => adminModal.classList.add('hidden');

        function showAdminMessage(message, isError = false) {
            adminMessageDiv.textContent = message;
            adminMessageDiv.classList.remove('hidden');
            if (isError) {
                adminMessageDiv.className = 'text-sm text-center font-medium my-2 p-2 rounded bg-red-100 text-red-700';
            } else {
                adminMessageDiv.className = 'text-sm text-center font-medium my-2 p-2 rounded bg-green-100 text-green-700';
            }
        }

        adminLogin.onclick = async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            if (!email || !password) return showAdminMessage('Введите email и пароль', true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                adminModal.classList.add('hidden');
                showCustomMessage('Администратор успешно вошел. Перейдите в раздел "Админка" для управления товарами.');
                // В реальном приложении здесь должен быть переход на страницу админки
                console.log("Админ вошел.");
            } catch (error) {
                console.error("Ошибка входа админа:", error);
                showAdminMessage('Ошибка входа. Проверьте данные. Код ошибки: ' + error.code, true);
            }
        };

        adminRegister.onclick = async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            if (!email || !password) return showAdminMessage('Введите email и пароль', true);

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                adminModal.classList.add('hidden');
                showCustomMessage('Администратор успешно зарегистрирован и вошел.');
            } catch (error) {
                console.error("Ошибка регистрации админа:", error);
                showAdminMessage('Ошибка регистрации. Возможно, пользователь уже существует или пароль слишком простой. Код ошибки: ' + error.code, true);
            }
        };


        // --- MAIN APPLICATION LOGIC ---

        // Категории из Админки + "Все товары"
        const CATEGORIES = ["Все товары", "Диваны", "Кровати", "Шкафы", "Столы и Стулья", "Кухни"];

        let currentCategory = "Все товары";
        let allOffers = []; // Будет хранить все загруженные товары
        let searchTerm = "";

        const categoryFilterDiv = document.getElementById('category-filter');
        const offersListDiv = document.getElementById('offers-list');
        const searchInput = document.getElementById('search-input');
        const noOffersDiv = document.getElementById('no-offers');


        // --- Data Loading and Filtering ---

        // 3. Установка слушателя Firestore для получения данных
        function setupRealtimeOffersListener() {
            if (!db) return;

            const offersRef = collection(db, productCollectionPath);
            // Запрашиваем только те товары, у которых есть хотя бы одна активная комбинация
            const q = query(offersRef);

            onSnapshot(q, (snapshot) => {
                const fetchedOffers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const activeCombo = data.combinations?.find(c => c.isActive);
                    
                    // Добавляем только активные товары
                    if (activeCombo) {
                        fetchedOffers.push({
                            id: doc.id,
                            title: data.title || 'Товар без названия',
                            category: data.category || 'Прочее',
                            imageUrl: data.images?.[0] || 'https://placehold.co/400x300/f3f4f6/4b5563?text=Нет+Фото',
                            price: activeCombo.price,
                            discount: activeCombo.discount,
                            originalPrice: activeCombo.price, // Сохраняем начальную цену
                            finalPrice: activeCombo.discount > 0 ? activeCombo.price * (1 - activeCombo.discount / 100) : activeCombo.price
                        });
                    }
                });
                
                allOffers = fetchedOffers;
                console.log(`Загружено ${allOffers.length} активных товаров.`);
                // Перерисовываем при получении новых данных
                renderOffers(); 
            }, (error) => {
                console.error("Ошибка получения товаров из Firestore:", error);
                showCustomMessage("Не удалось загрузить товары. Проверьте подключение к базе данных.");
            });
        }

        // --- Render Functions ---

        function renderCategories() {
            categoryFilterDiv.innerHTML = '';
            CATEGORIES.forEach(category => {
                const button = document.createElement('button');
                button.className = `category-button ${category === currentCategory ? 'active' : ''}`;
                button.textContent = category;
                button.onclick = () => {
                    setActiveCategory(category);
                };
                categoryFilterDiv.appendChild(button);
            });
        }

        function setActiveCategory(category) {
            currentCategory = category;
            renderCategories(); // Обновить стили кнопок
            renderOffers();    // Применить фильтр
        }

        function renderOffers() {
            offersListDiv.innerHTML = '';
            
            // 1. Фильтр по категории
            const filteredByCategory = currentCategory === "Все товары"
                ? allOffers
                : allOffers.filter(offer => offer.category === currentCategory);

            // 2. Фильтр по поисковому запросу
            const filteredBySearch = searchTerm.trim().toLowerCase();
            const finalOffers = filteredByCategory.filter(offer => 
                offer.title.toLowerCase().includes(filteredBySearch) || 
                offer.category.toLowerCase().includes(filteredBySearch)
            );

            if (finalOffers.length === 0) {
                noOffersDiv.classList.remove('hidden');
                return;
            }
            noOffersDiv.classList.add('hidden');

            // 3. Рендеринг карточек
            finalOffers.forEach(offer => {
                const card = document.createElement('div');
                card.className = 'offer-card flex flex-col';

                const priceDisplay = offer.discount > 0 ? 
                    `
                    <p class="text-xl font-extrabold text-red-600">${Math.round(offer.finalPrice)} ₽</p>
                    <p class="text-sm text-gray-400 line-through">${Math.round(offer.originalPrice)} ₽</p>
                    ` : 
                    `<p class="text-xl font-extrabold text-gray-900">${Math.round(offer.finalPrice)} ₽</p>`;

                card.innerHTML = `
                    <div class="h-48 overflow-hidden relative">
                        <!-- Изображение с заглушкой -->
                        <img 
                            src="${offer.imageUrl}" 
                            alt="${offer.title}" 
                            class="w-full h-full object-cover transition duration-500 ease-in-out hover:scale-105"
                            onerror="this.onerror=null; this.src='https://placehold.co/400x300/f3f4f6/4b5563?text=Нет+Фото';"
                        >
                        ${offer.discount > 0 ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">- ${offer.discount}%</div>` : ''}
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <p class="text-sm font-semibold text-orange-600 mb-1">${offer.category}</p>
                        <h4 class="text-lg font-bold text-gray-900 mb-3 flex-grow">${offer.title}</h4>
                        <div class="flex items-end justify-between mt-auto">
                            <div class="flex items-center space-x-2">
                                ${priceDisplay}
                            </div>
                            <button class="card-button text-white text-sm font-bold py-2 px-4 rounded-full transition">
                                Заказать
                            </button>
                        </div>
                    </div>
                `;
                offersListDiv.appendChild(card);
            });
        }


        // --- Event Listeners ---

        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderOffers();
        });


        // --- Initialization ---

        window.onload = () => {
            initializeFirebase();
            initializeAuth(); // Аутентификация -> setupRealtimeOffersListener
            renderCategories(); // Рендерим кнопки категорий сразу
        };

    </script>
</body>
</html>
