<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Стиль для сообщения статуса */
        .status-success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .status-error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        /* Стилизация заголовка и карточки */
        body {
            background-color: #f3f4f6; /* gray-100 */
            font-family: 'Inter', sans-serif;
        }
        .container-card {
            max-width: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container-card mx-auto bg-white p-6 md:p-10 rounded-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">Админ-панель: Добавить Предложение</h1>
        
        <!-- Форма добавления предложения -->
        <form id="addOfferForm" class="space-y-4">
            
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Заголовок предложения</label>
                <input type="text" id="title" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="discount" class="block text-sm font-medium text-gray-700 mb-1">Размер скидки (%)</label>
                <input type="number" id="discount" required min="0" max="100" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 mb-1">URL изображения</label>
                <input type="url" id="image" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                <select id="category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="Все">Все</option>
                    <option value="Мебель">Мебель</option>
                    <option value="Аксессуары">Аксессуары</option>
                    <option value="Услуги">Услуги</option>
                </select>
            </div>
            
            <!-- Кнопка и индикатор загрузки -->
            <button type="submit" id="submitButton" class="w-full btn-primary text-white font-semibold py-2 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                Добавить предложение
            </button>
            
            <p id="statusMessage" class="hidden text-center py-2 rounded-lg font-medium"></p>
            
        </form>

    </div>

    <script type="module">
        // ИМПОРТЫ FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И НАСТРОЙКА FIREBASE ---
        
        // Получение конфигурации из переменных окружения (предоставляемых Canvas/Render)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        
        const form = document.getElementById('addOfferForm');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');

        // Функция для инициализации Firebase
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("FIREBASE ERROR: Configuration not found. Check Environment Variables.");
                statusMessage.textContent = "Ошибка: Конфигурация Firebase не найдена.";
                statusMessage.className = 'status-error py-2 px-4 rounded-lg font-medium';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Аутентификация
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase initialized and authenticated successfully.");
            } catch (e) {
                console.error("FIREBASE ERROR: Initialization or Authentication failed:", e);
                statusMessage.textContent = `Ошибка инициализации: ${e.message}`;
                statusMessage.className = 'status-error py-2 px-4 rounded-lg font-medium';
            }
        }

        initializeFirebase();

        // --- ЛОГИКА ФОРМЫ ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db) {
                console.error("Firestore DB not available.");
                statusMessage.textContent = "Ошибка: База данных не инициализирована.";
                statusMessage.className = 'status-error py-2 px-4 rounded-lg font-medium';
                statusMessage.classList.remove('hidden');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Добавление...';
            statusMessage.classList.add('hidden'); // Скрыть предыдущее сообщение

            try {
                // 1. Сбор данных
                const newOffer = {
                    title: document.getElementById('title').value,
                    discount: Number(document.getElementById('discount').value),
                    image: document.getElementById('image').value,
                    category: document.getElementById('category').value,
                    createdAt: serverTimestamp(),
                    // Используем App ID для создания корректного пути к коллекции
                    // Публичная коллекция: /artifacts/{appId}/public/data/offers
                    // ВАЖНО: Убедитесь, что правила Firebase позволяют запись в этот путь.
                };

                // 2. Добавление документа
                const offersCollectionRef = collection(db, `artifacts/${appId}/public/data/offers`);
                await addDoc(offersCollectionRef, newOffer);

                // 3. Успех
                statusMessage.textContent = '✅ Предложение успешно добавлено!';
                statusMessage.className = 'status-success py-2 px-4 rounded-lg font-medium';
                form.reset(); // Очистить форму

            } catch (error) {
                // 4. Ошибка
                console.error('Ошибка добавления документа:', error);
                statusMessage.textContent = `❌ Ошибка: ${error.message}`;
                statusMessage.className = 'status-error py-2 px-4 rounded-lg font-medium';

            } finally {
                // 5. Завершение
                submitButton.disabled = false;
                submitButton.textContent = 'Добавить предложение';
                statusMessage.classList.remove('hidden'); // Показать статус
            }
        });
    </script>
</body>
</html>
