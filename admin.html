<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Управление Товарами</title>
    <!-- Загрузка Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Установка шрифта Inter и общие стили */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container-card { max-width: 900px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); margin-bottom:2rem; }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .color-box { width: 25px; height: 25px; border: 1px solid #ccc; display: inline-block; margin-right: 5px; vertical-align: middle; border-radius: 4px; }
        .status-success { background-color: #d1fae5; color: #065f46; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .dynamic-field-group { border: 1px dashed #d1d5db; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        /* Фокус на полях ввода */
        input:focus, textarea:focus, select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
            outline: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Ошибка доступа -->
    <div id="accessDenied" class="hidden container-card mx-auto bg-red-100 text-red-700 p-6 rounded-xl text-center font-bold">
        У вас нет прав администратора или произошла ошибка аутентификации.
    </div>

    <!-- Панель -->
    <div id="adminPanel" class="container-card mx-auto bg-white p-6 rounded-xl hidden">
        <!-- Заголовок с ID для динамического изменения при редактировании -->
        <h1 id="formTitle" class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">Админ-панель: Создание Товара</h1>

        <!-- Единая форма для добавления/редактирования товара -->
        <form id="offerForm" class="space-y-4">
            
            <!-- Скрытое поле для ID товара при редактировании -->
            <input type="hidden" id="offerId" name="offerId" value="">

            <!-- Статические поля -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Название товара</label>
                <input type="text" id="title" name="title" class="w-full p-2 border rounded-lg" required>
            </div>

            <!-- Тип товара -->
            <div>
                <label for="itemType" class="block text-sm font-medium text-gray-700 mb-1">Тип товара (определяет доступные опции)</label>
                <select id="itemType" name="itemType" class="w-full p-2 border rounded-lg">
                    <option value="Кухня">Кухня</option>
                    <option value="Диван">Диван</option>
                    <option value="Кресло">Кресло</option>
                    <option value="Мебель">Мебель (другое)</option>
                    <option value="Аксессуары">Аксессуары</option>
                    <option value="Услуги">Услуги</option>
                    <option value="Все">Прочее</option>
                </select>
            </div>
            
            <!-- Категория -->
            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                <select id="category" name="category" class="w-full p-2 border rounded-lg">
                    <option value="Все">Все</option>
                    <option value="Кухни">Кухни</option>
                    <option value="Мягкая мебель">Мягкая мебель</option>
                    <option value="Корпусная мебель">Корпусная мебель</option>
                    <option value="Аксессуары">Аксессуары</option>
                    <option value="Услуги">Услуги</option>
                </select>
            </div>

            <div>
                <label for="discount" class="block text-sm font-medium text-gray-700 mb-1">Скидка (%)</label>
                <input type="number" id="discount" name="discount" min="0" max="100" class="w-full p-2 border rounded-lg" value="0">
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                <textarea id="description" name="description" rows="3" class="w-full p-2 border rounded-lg" required></textarea>
            </div>

            <!-- Динамические поля: Картинки -->
            <div class="dynamic-field-group">
                <label class="block text-sm font-bold text-gray-800 mb-2">Картинки (URL)</label>
                <div id="images-container" class="mb-2 space-y-2"></div>
                <button type="button" id="addImageBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">Добавить картинку</button>
            </div>
            
            <!-- Динамические поля: Фасад / Материал -->
            <div id="facadeOrMaterialGroup" class="dynamic-field-group">
                <label id="facadeOrMaterialLabel" class="block text-sm font-bold text-gray-800 mb-2">Фасады</label>
                <div id="facadeOrMaterialContainer" class="mb-2 space-y-2"></div>
                <button type="button" id="addFacadeOrMaterialBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">Добавить опцию</button>
            </div>

            <!-- Динамические поля: Цвета -->
            <div id="colorsGroup" class="dynamic-field-group">
                <label class="block text-sm font-bold text-gray-800 mb-2">Цвета</label>
                <div id="colors-container" class="mb-2 space-y-2"></div>
                <button type="button" id="addColorBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">Добавить цвет</button>
            </div>

            <!-- Динамические поля: Цены для комбинаций -->
            <div id="pricesGroup" class="dynamic-field-group">
                <label class="block text-sm font-bold text-gray-800 mb-2">Цены для комбинаций (Материал/Фасад + Цвет)</label>
                <div id="prices-container" class="mb-2 space-y-2"></div>
                <button type="button" id="addPriceBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">Добавить цену комбинации</button>
            </div>

            <!-- Кнопка сохранения/обновления -->
            <button type="submit" id="save-btn" class="w-full btn-primary text-white font-semibold py-2 rounded-lg shadow-md hover:shadow-lg">Создать товар</button>
            <p id="statusMessage" class="hidden text-center py-2 rounded-lg font-medium"></p>
        </form>

        <button id="logoutBtn" class="mt-6 w-full bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition">Выйти</button>

        <!-- Существующие товары -->
        <h2 class="text-2xl font-bold mt-8 mb-4 border-t pt-4">Существующие товары</h2>
        <div id="offers-list" class="space-y-3">
            <p class="text-gray-500">Загрузка товаров...</p>
        </div>
    </div>

    <!-- Встроенный JS-модуль с логикой Firebase и CRUD -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. FIREBASE SETUP & GLOBAL STATE ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let offersData = []; // Массив для хранения всех товаров
        
        // UI элементы
        const offerForm = document.getElementById('offerForm');
        const formTitle = document.getElementById('formTitle');
        const saveBtn = document.getElementById('save-btn');
        const statusMessage = document.getElementById('statusMessage');
        const adminPanel = document.getElementById('adminPanel');
        const accessDenied = document.getElementById('accessDenied');
        const offersList = document.getElementById('offers-list');

        let currentOfferId = null; // null для создания, ID для редактирования
        
        // Контейнеры для динамических полей
        const imagesContainer = document.getElementById('images-container');
        const facadeOrMaterialContainer = document.getElementById('facadeOrMaterialContainer');
        const colorsContainer = document.getElementById('colors-container');
        const pricesContainer = document.getElementById('prices-container');
        const itemTypeSelect = document.getElementById('itemType');
        const facadeOrMaterialLabel = document.getElementById('facadeOrMaterialLabel');

        // --- 2. DYNAMIC FIELD GENERATION LOGIC ---

        // Обновление лейбла Фасад/Материал
        itemTypeSelect.addEventListener('change', () => {
            const type = itemTypeSelect.value;
            if (['Диван', 'Кресло', 'Мебель'].includes(type)) {
                facadeOrMaterialLabel.textContent = 'Материалы';
            } else {
                facadeOrMaterialLabel.textContent = 'Фасады';
            }
            // Перегенерация комбо-цен при смене типа, чтобы обновить опции в SELECT
            generatePriceCombinationOptions();
        });

        function createFieldRow(container, name, value = '', type = 'text', placeholder = '', deleteCallback) {
            const uniqueId = `field-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.id = uniqueId;

            let inputHTML = '';

            if (type === 'image') {
                inputHTML = `
                    <input type="url" class="flex-grow p-2 border rounded-lg text-sm" placeholder="URL картинки" value="${value || ''}" data-field-type="url">
                `;
            } else if (type === 'material') {
                 // value = { name: 'МДФ', value: 'mdf' }
                 inputHTML = `
                    <input type="text" class="flex-grow p-2 border rounded-lg text-sm" placeholder="Название опции (например, МДФ)" value="${value.name || ''}" data-field-type="name">
                    <input type="text" class="p-2 border rounded-lg text-sm w-1/4" placeholder="ID (например, mdf)" value="${value.value || ''}" data-field-type="value" title="Уникальный ID опции">
                `;
            } else if (type === 'color') {
                // value = { name: 'Красный', hex: '#FF0000' }
                inputHTML = `
                    <input type="text" class="flex-grow p-2 border rounded-lg text-sm w-1/3" placeholder="Название цвета" value="${value.name || ''}" data-field-type="name">
                    <input type="color" class="p-1 border rounded-lg" value="${value.hex || '#ffffff'}" data-field-type="hex" title="Выберите HEX цвет">
                    <input type="text" class="flex-grow p-2 border rounded-lg text-sm w-1/3" placeholder="HEX (#FF0000)" value="${value.hex || ''}" data-field-type="hex-display" 
                        onchange="this.previousElementSibling.value = this.value; this.previousElementSibling.dispatchEvent(new Event('input'))" 
                        oninput="this.previousElementSibling.value = this.value; this.previousElementSibling.dispatchEvent(new Event('input'))">
                `;
            }

            div.innerHTML = `
                ${inputHTML}
                <button type="button" class="btn-danger text-white py-1 px-2 rounded text-sm" data-id="${uniqueId}">🗑️</button>
            `;

            container.appendChild(div);

            // Обработчик удаления
            div.querySelector('.btn-danger').addEventListener('click', (e) => {
                container.removeChild(div);
                if (deleteCallback) deleteCallback(); // Для перегенерации цен
            });
            
            // Синхронизация HEX display с color picker
            if (type === 'color') {
                const colorPicker = div.querySelector('[data-field-type="hex"]');
                const hexDisplay = div.querySelector('[data-field-type="hex-display"]');

                colorPicker.addEventListener('input', (e) => {
                    hexDisplay.value = e.target.value.toUpperCase();
                    if (deleteCallback) deleteCallback(); 
                });
                hexDisplay.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                         colorPicker.value = e.target.value;
                         if (deleteCallback) deleteCallback(); 
                    }
                });
            }
        }

        // Кнопки для добавления динамических полей
        document.getElementById('addImageBtn').addEventListener('click', () => createFieldRow(imagesContainer, 'images', '', 'image'));
        document.getElementById('addFacadeOrMaterialBtn').addEventListener('click', () => createFieldRow(facadeOrMaterialContainer, 'materials', {name: '', value: ''}, 'material', '', generatePriceCombinationOptions));
        document.getElementById('addColorBtn').addEventListener('click', () => createFieldRow(colorsContainer, 'colors', {name: '', hex: '#ffffff'}, 'color', '', generatePriceCombinationOptions));
        document.getElementById('addPriceBtn').addEventListener('click', () => createPriceCombinationRow());


        // --- 3. PRICE COMBINATION LOGIC ---

        function getDynamicFieldData() {
            // Получаем только валидные материалы/фасады
            const materials = Array.from(facadeOrMaterialContainer.querySelectorAll('.flex-grow[data-field-type="value"]')).map(input => ({
                name: input.closest('.flex.items-center.space-x-2').querySelector('[data-field-type="name"]').value,
                value: input.value,
            })).filter(m => m.value && m.name);

            // Получаем только валидные цвета
            const colors = Array.from(colorsContainer.querySelectorAll('[data-field-type="hex"]')).map(input => ({
                name: input.closest('.flex.items-center.space-x-2').querySelector('[data-field-type="name"]').value,
                hex: input.value.toUpperCase(),
            })).filter(c => c.name && c.hex);

            return { materials, colors };
        }

        function createPriceCombinationRow(priceData = { materialId: '', colorHex: '', price: '' }) {
            const { materials, colors } = getDynamicFieldData();

            if (materials.length === 0 || colors.length === 0) {
                 statusMessage.textContent = '❌ Сначала добавьте Материалы/Фасады и Цвета.';
                 statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                 setTimeout(() => statusMessage.className = 'hidden', 3000);
                 return;
            }

            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded-lg';
            
            // Генерация опций для Материала/Фасада
            const materialOptions = materials.map(m => 
                `<option value="${m.value}" ${m.value === priceData.materialId ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            // Генерация опций для Цвета
            const colorOptions = colors.map(c => 
                `<option value="${c.hex}" ${c.hex === priceData.colorHex ? 'selected' : ''}>${c.name} (${c.hex})</option>`
            ).join('');

            div.innerHTML = `
                <select class="p-2 border rounded-lg flex-grow" data-field-type="materialId" required>
                    <option value="">-- Выберите Материал/Фасад --</option>
                    ${materialOptions}
                </select>
                <select class="p-2 border rounded-lg flex-grow" data-field-type="colorHex" required>
                    <option value="">-- Выберите Цвет --</option>
                    ${colorOptions}
                </select>
                <input type="number" class="p-2 border rounded-lg w-1/4" placeholder="Цена, RUB" value="${priceData.price || ''}" data-field-type="price" min="0" required>
                <button type="button" class="btn-danger text-white py-1 px-2 rounded text-sm">🗑️</button>
            `;

            div.querySelector('.btn-danger').addEventListener('click', () => {
                pricesContainer.removeChild(div);
            });

            pricesContainer.appendChild(div);
        }

        // Обновляет все select-опции в существующих полях цен (вызывается при изменении Материалов/Цветов)
        function generatePriceCombinationOptions() {
            // Сохраняем текущие значения, чтобы восстановить их после перегенерации SELECT'ов
            const currentPrices = getFormPricesData();
            pricesContainer.innerHTML = '';
            
            currentPrices.forEach(price => createPriceCombinationRow(price));

            if (pricesContainer.children.length === 0) {
                // Если цен не было, но есть материалы и цвета, добавляем одну пустую
                const { materials, colors } = getDynamicFieldData();
                if (materials.length > 0 && colors.length > 0) {
                    createPriceCombinationRow();
                }
            }
        }


        // --- 4. DATA EXTRACTION AND LOADING ---

        function getFormPricesData() {
            const priceRows = pricesContainer.querySelectorAll('.flex.items-center.space-x-2');
            const prices = [];
            priceRows.forEach(row => {
                const materialId = row.querySelector('[data-field-type="materialId"]').value;
                const colorHex = row.querySelector('[data-field-type="colorHex"]').value;
                const priceValue = parseFloat(row.querySelector('[data-field-type="price"]').value);
                
                prices.push({
                    materialId: materialId,
                    colorHex: colorHex,
                    price: isNaN(priceValue) ? 0 : priceValue,
                });
            });
            return prices;
        }

        function collectFormData() {
            const formData = {
                title: document.getElementById('title').value,
                itemType: itemTypeSelect.value,
                category: document.getElementById('category').value,
                discount: parseInt(document.getElementById('discount').value) || 0,
                description: document.getElementById('description').value,
            };

            // Динамические поля: Images
            formData.images = Array.from(imagesContainer.querySelectorAll('[data-field-type="url"]'))
                                .map(input => ({ url: input.value }))
                                .filter(item => item.url);

            // Динамические поля: Materials/Facades
            const materialInputs = facadeOrMaterialContainer.querySelectorAll('.flex.items-center.space-x-2');
            formData.facadesOrMaterials = Array.from(materialInputs).map(row => ({
                name: row.querySelector('[data-field-type="name"]').value,
                value: row.querySelector('[data-field-type="value"]').value,
            })).filter(item => item.name && item.value);

            // Динамические поля: Colors
            const colorInputs = colorsContainer.querySelectorAll('.flex.items-center.space-x-2');
            formData.colors = Array.from(colorInputs).map(row => ({
                name: row.querySelector('[data-field-type="name"]').value,
                // Используем значение из color picker, которое гарантированно является валидным HEX
                hex: row.querySelector('[data-field-type="hex"]').value.toUpperCase(), 
            })).filter(item => item.name);

            // Динамические поля: Prices
            formData.prices = getFormPricesData();

            return formData;
        }

        function clearForm() {
            offerForm.reset();
            currentOfferId = null;
            document.getElementById('offerId').value = '';
            imagesContainer.innerHTML = '';
            facadeOrMaterialContainer.innerHTML = '';
            colorsContainer.innerHTML = '';
            pricesContainer.innerHTML = '';
            
            // Сброс UI
            formTitle.textContent = 'Админ-панель: Создание Товара';
            saveBtn.textContent = 'Создать товар';
            saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.add('btn-primary');
            statusMessage.className = 'hidden';
            
            // Добавляем по одному пустому полю для начала
            createFieldRow(imagesContainer, 'images', '', 'image');
            itemTypeSelect.dispatchEvent(new Event('change')); // Обновить лейбл
        }

        function loadOfferForEdit(offerId, data) {
            clearForm(); // Сначала очистить
            currentOfferId = offerId;
            document.getElementById('offerId').value = offerId;
            
            // Заполнение статических полей
            document.getElementById('title').value = data.title || '';
            document.getElementById('itemType').value = data.itemType || 'Все';
            document.getElementById('category').value = data.category || 'Все';
            document.getElementById('discount').value = data.discount || 0;
            document.getElementById('description').value = data.description || '';

            // Обновление лейбла и инициализация опций цен
            itemTypeSelect.dispatchEvent(new Event('change'));

            // Заполнение динамических полей: Images
            (data.images || []).forEach(img => createFieldRow(imagesContainer, 'images', img.url, 'image'));

            // Заполнение динамических полей: Materials/Facades
            // Передаем callback для перегенерации цен после того, как все опции загружены
            const materialsLoaded = (data.facadesOrMaterials || []).map(mat => 
                createFieldRow(facadeOrMaterialContainer, 'materials', mat, 'material', '', generatePriceCombinationOptions)
            );

            // Заполнение динамических полей: Colors
            (data.colors || []).forEach(col => createFieldRow(colorsContainer, 'colors', col, 'color', '', generatePriceCombinationOptions));

            // Заполнение динамических полей: Prices (должно идти после Materials и Colors)
            (data.prices || []).forEach(price => createPriceCombinationRow(price));

            // Если не было изображений, добавим пустую строку
            if (imagesContainer.children.length === 0) {
                 createFieldRow(imagesContainer, 'images', '', 'image');
            }

            // Обновление UI
            formTitle.textContent = `Админ-панель: Редактирование Товара (ID: ${offerId})`;
            saveBtn.textContent = 'Сохранить изменения';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');

            // Прокрутка к форме
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- 5. FIREBASE INTERACTION ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config is missing.");
                 accessDenied.classList.remove('hidden');
                 return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Аутентификация
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Установка слушателя изменений состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        adminPanel.classList.remove('hidden');
                        accessDenied.classList.add('hidden');
                        setupListeners(); // Запуск слушателей после аутентификации
                        clearForm(); // Инициализация формы в режиме создания
                    } else {
                        userId = null;
                        adminPanel.classList.add('hidden');
                        accessDenied.classList.remove('hidden');
                        console.log("User logged out or not authorized.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                accessDenied.classList.remove('hidden');
            }
        }

        function setupListeners() {
            // 1. Слушатель списка товаров
            const offersColRef = collection(db, `artifacts/${appId}/public/data/offers`);
            onSnapshot(offersColRef, (snapshot) => {
                offersData = [];
                offersList.innerHTML = '';
                if (snapshot.empty) {
                    offersList.innerHTML = '<p class="text-gray-500">Товары не найдены. Создайте первый товар.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const offerId = doc.id;
                    offersData.push({ id: offerId, ...data });
                    renderOfferItem(offerId, data);
                });
            }, (error) => {
                console.error("Error fetching offers:", error);
                offersList.innerHTML = `<p class="text-red-500">Ошибка загрузки товаров: ${error.message}</p>`;
            });
        }
        
        function renderOfferItem(offerId, data) {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm';
            item.innerHTML = `
                <span class="font-medium text-gray-700 truncate">${data.title}</span>
                <div>
                    <button type="button" data-id="${offerId}" class="edit-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium mr-3">Редактировать</button>
                    <button type="button" data-id="${offerId}" class="delete-btn text-red-600 hover:text-red-800 text-sm font-medium">Удалить</button>
                </div>
            `;
            offersList.appendChild(item);
        }
        
        // Обработчик нажатия кнопок в списке
        offersList.addEventListener('click', async (e) => {
            const offerId = e.target.dataset.id;
            if (!offerId) return;

            if (e.target.classList.contains('edit-btn')) {
                const offer = offersData.find(o => o.id === offerId);
                if (offer) {
                    loadOfferForEdit(offerId, offer);
                } else {
                    console.error("Offer data not found locally:", offerId);
                }
            } else if (e.target.classList.contains('delete-btn')) {
                // Заменяем alert/confirm на кастомное сообщение или просто лог
                if (confirm(`Вы уверены, что хотите удалить товар "${offersData.find(o => o.id === offerId)?.title || offerId}"?`)) {
                    await deleteOffer(offerId);
                }
            }
        });

        async function deleteOffer(offerId) {
            statusMessage.className = 'status-success text-center py-2 rounded-lg font-medium';
            statusMessage.textContent = '...Удаление товара...';
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/offers`, offerId));
                statusMessage.className = 'status-success text-center py-2 rounded-lg font-medium';
                statusMessage.textContent = '✅ Товар успешно удален!';
            } catch (error) {
                console.error("Error deleting offer:", error);
                statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                statusMessage.textContent = `❌ Ошибка удаления: ${error.message}`;
            }
            setTimeout(() => statusMessage.className = 'hidden', 3000);
        }

        // --- 6. FORM SUBMISSION ---
        
        offerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = collectFormData();
            
            // Валидация наличия опций (минимальная)
            if (data.facadesOrMaterials.length === 0 || data.colors.length === 0) {
                 statusMessage.textContent = '❌ Необходимы хотя бы один Фасад/Материал и один Цвет.';
                 statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                 setTimeout(() => statusMessage.className = 'hidden', 4000);
                 return;
            }
            if (data.prices.length === 0) {
                 statusMessage.textContent = '❌ Добавьте хотя бы одну Ценовую Комбинацию.';
                 statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                 setTimeout(() => statusMessage.className = 'hidden', 4000);
                 return;
            }

            // Показываем сообщение о процессе
            statusMessage.className = 'status-success text-center py-2 rounded-lg font-medium';
            statusMessage.textContent = '...Сохранение данных...';
            
            try {
                if (currentOfferId) {
                    // РЕЖИМ РЕДАКТИРОВАНИЯ
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/offers`, currentOfferId), data);
                    statusMessage.textContent = '✅ Изменения успешно сохранены!';
                } else {
                    // РЕЖИМ СОЗДАНИЯ
                    await addDoc(collection(db, `artifacts/${appId}/public/data/offers`), data);
                    statusMessage.textContent = '✅ Товар успешно создан!';
                    clearForm(); // Очищаем после создания
                }
            } catch (error) {
                console.error("Error saving offer:", error);
                statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                statusMessage.textContent = `❌ Ошибка сохранения: ${error.message}`;
            }
            
            setTimeout(() => statusMessage.className = 'hidden', 3000);
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("Signed out successfully.");
            }).catch((error) => {
                console.error("Sign out error:", error);
            });
        });

        // --- INITIALIZATION ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
