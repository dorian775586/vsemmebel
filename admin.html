<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админка Mebel.by</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans', sans-serif; background:#f7f7f7; }
        .input-field { border:2px solid #ddd; padding:0.5rem; border-radius:0.5rem; width:100%; transition: border-color 0.2s; }
        .input-field:focus { border-color: #f97316; outline: none; }
        .section { background:white; padding:1.5rem; border-radius:1rem; margin-bottom:1.5rem; box-shadow:0 6px 15px rgba(0,0,0,0.08); }
        .btn { padding:0.6rem 1.2rem; border-radius:0.5rem; font-weight:600; cursor:pointer; transition:0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; }
        .btn-save { background:#f97316;color:white; }
        .btn-save:hover:not(:disabled) { background:#ea580c; box-shadow: 0 4px 6px rgba(234,88,12,0.3); }
        .btn-save:disabled { background:#fcd34d; cursor: not-allowed; } 
        .btn-delete { background:#ef4444;color:white; }
        .btn-delete:hover { background:#b91c1c; box-shadow: 0 4px 6px rgba(239,68,68,0.3); }
        .option-btn { border:2px solid #f97316; background:#ffedd5; padding:0.3rem 0.8rem; margin-right:0.3rem; margin-bottom:0.3rem; border-radius:0.5rem; cursor:pointer; transition:0.2s; white-space: nowrap; display: inline-flex; align-items: center; }
        .option-btn:hover { background: #f97316; color: white; }
        .thumbnail { width:60px;height:60px;object-fit:cover;border:2px solid #ddd;border-radius:0.5rem;flex-shrink: 0;}
        .thumbnail img { width:100%; height:100%; object-fit:cover; border-radius:0.3rem; }
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        /* Select arrow styles */
        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 011.414 0L10 10.586l3.293-3.293a1 1 011.414 1.414l-4 4a1 1 01-1.414 0l-4-4a1 1 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .images-list-item { display:flex; gap:0.75rem; align-items:center; background:#fff; padding:0.5rem; border-radius:0.75rem; border:1px solid #eee; }
        .images-list-item .meta { display:flex; gap:0.5rem; align-items:center; width:100%; }
        .images-list-item .meta select { max-width:220px; }
        .images-list-item .meta .url { flex:1; font-size:13px; color:#374151; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .small-btn { padding:0.3rem 0.6rem; font-size:13px; border-radius:0.5rem; }
    </style>
</head>
<body class="p-4 sm:p-6">

<h1 class="text-3xl font-bold mb-6 text-gray-800">Админка Mebel.by</h1>

<div class="section">
    <h2 class="text-xl font-bold mb-4 text-gray-700">Создание / Редактирование товара</h2>
    
    <div class="mb-4">
        <label class="font-semibold text-gray-600">ID Пользователя</label>
        <div id="user-id-display" class="p-2 bg-gray-100 rounded-lg text-sm truncate">...</div>
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">Название</label>
        <input id="title" class="input-field" type="text" placeholder="Название товара">
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">Категория</label>
        <select id="category" class="input-field">
            <option value="" disabled selected>-- Выберите категорию --</option>
            <option value="Диваны">Диваны</option>
            <option value="Кровати">Кровати</option>
            <option value="Шкафы">Шкафы</option>
            <option value="Столы">Столы и Стулья</option>
            <option value="Кухни">Кухни</option>
        </select>
    </div>
    
    <!-- БЛОК ИЗОБРАЖЕНИЙ -->
    <div class="mb-4">
        <label class="font-semibold text-gray-600">Изображения (URL) — можно привязать изображение к цвету</label>
        <div id="images-container" class="space-y-2"></div>
        
        <div id="image-url-input-area" class="flex gap-2 mt-2 hidden">
            <input id="image-url-input" class="input-field" type="url" placeholder="Вставьте URL изображения (http://...)">
            <select id="image-url-color-select" class="input-field w-48">
                <option value="">— Без привязки к цвету —</option>
            </select>
            <button id="image-url-ok-btn" class="btn btn-save text-sm px-4">ОК</button>
            <button id="image-url-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">Отмена</button>
        </div>
        <button id="add-image-btn" class="btn mt-2 btn-save">Добавить URL изображения</button>
        <p class="text-xs text-gray-500 mt-2">Привязав изображение к цвету, на странице товара при выборе цвета можно показывать связанное изображение.</p>
    </div>

    <!-- БЛОК УПРАВЛЕНИЯ ФАСАДАМИ -->
    <div class="mb-4">
        <label class="font-semibold text-gray-600">Фасады</label>
        <div id="facades-container" class="flex gap-2 flex-wrap mt-2 mb-2"></div>
        
        <div id="facade-dynamic-input-area" class="flex gap-2 mt-2 hidden">
            <input id="facade-input" class="input-field" placeholder="Новый фасад (например, Глянец)">
            <button id="facade-ok-btn" class="btn btn-save text-sm px-4">ОК</button>
            <button id="facade-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">Отмена</button>
        </div>
        <button id="add-facade-btn" class="btn btn-save mt-2">Добавить фасад</button>
    </div>
    
    <!-- БЛОК УПРАВЛЕНИЯ МАТЕРИАЛАМИ -->
    <div class="mb-4">
        <label class="font-semibold text-gray-600">Материалы</label>
        <div id="materials-container" class="flex gap-2 flex-wrap mt-2 mb-2"></div>

        <div id="material-dynamic-input-area" class="flex gap-2 mt-2 hidden">
            <input id="material-input" class="input-field" placeholder="Новый материал (например, МДФ)">
            <button id="material-ok-btn" class="btn btn-save text-sm px-4">ОК</button>
            <button id="material-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">Отмена</button>
        </div>
        <button id="add-material-btn" class="btn btn-save mt-2">Добавить материал</button>
    </div>

    <!-- БЛОК УПРАВЛЕНИЯ ЦВЕТАМИ -->
    <div class="mb-4">
        <label class="font-semibold text-gray-600">Цвета</label>
        <div id="colors-container" class="flex gap-2 flex-wrap mt-2 mb-2"></div>

        <div id="color-dynamic-input-area" class="flex flex-col sm:flex-row gap-2 mt-2 hidden p-3 border border-gray-100 rounded-lg bg-gray-50">
            <input id="color-name" class="input-field" placeholder="Название цвета">
            <input id="color-hex" class="w-full sm:w-16 h-10 border-2 border-gray-300 rounded-lg p-0" type="color" value="#f97316">
            <div class="flex gap-2 justify-end w-full sm:w-auto">
                <button id="color-ok-btn" class="btn btn-save text-sm px-4">ОК</button>
                <button id="color-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">Отмена</button>
            </div>
        </div>
        
        <button id="add-color-btn" class="btn btn-save mt-2">Добавить цвет</button>
    </div>

    <!-- БЛОК УПРАВЛЕНИЯ КОМБИНАЦИЯМИ -->
    <div class="mb-4">
        <label class="font-semibold text-gray-600">Варианты товара (Комбинации Материал - Фасад - Цвет)</label>
        <div id="combinations-container"></div>
        <button id="add-combo-btn" class="btn btn-save mt-2">Добавить комбинацию</button>
    </div>

    <div class="flex gap-3 pt-4 border-t border-gray-100">
        <button id="save-product-btn" class="btn btn-save">Сохранить товар</button>
        <button id="clear-product-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">Очистить форму</button>
    </div>
</div>

<h2 class="text-xl font-bold mb-4 text-gray-700">Существующие товары</h2>
<div id="existing-products" class="space-y-3"></div>

<!-- Custom Message Modal -->
<div id="custom-modal" class="modal-overlay hidden" onclick="if(event.target.id === 'custom-modal') closeModal()">
    <div class="modal-content" id="modal-content" onclick="event.stopPropagation()">
        <p id="modal-message" class="text-gray-700 mb-4"></p>
        <div id="modal-buttons" class="flex justify-end gap-3">
            <button id="modal-btn-cancel" class="btn px-4 bg-gray-200 text-gray-700 hover:bg-gray-300">Отмена</button>
            <button id="modal-btn-confirm" class="btn btn-save">OK</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, getDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

setLogLevel('Debug');

// --- FIREBASE CONFIGURATION & AUTH VARIABLES ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
const HARDCODED_FIREBASE_CONFIG = {
    apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70", 
    authDomain: "vsemmebel-90d48.firebaseapp.com",
    projectId: "vsemmebel-90d48", 
    storageBucket: "vsemmebel-90d48.appspot.com", 
    messagingSenderId: "958123504041",
    appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};

let firebaseConfig = null, app = null, db = null, auth = null, userId = null;
const productCollectionPath = `artifacts/${appId}/public/data/offers`;

// 1. Инициализация Firebase
function initializeFirebase() {
    if (firebaseConfigString) {
        try { firebaseConfig = JSON.parse(firebaseConfigString); } catch (e) {
            console.error("ОШИБКА: Не удалось распарсить JSON из переменной хостинга.", e);
        }
    } 
    if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "ВАШ_API_KEY") {
        firebaseConfig = HARDCODED_FIREBASE_CONFIG;
        console.warn("ВНИМАНИЕ: Используется хардкодированная конфигурация Firebase.");
    }
    if (firebaseConfig && firebaseConfig.apiKey) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("КРИТИЧЕСКАЯ ОШИБКА: Ошибка инициализации Firebase.", e);
            db = null; 
        }
    } else {
        console.error("КРИТИЧЕСКАЯ ОШИБКА: Конфигурация Firebase недействительна.");
        db = null;
    }
}

// 2. Инициализация аутентификации
async function initializeAuth() {
    if (!auth) { userId = crypto.randomUUID(); return; }
    try {
        if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
        else { await signInAnonymously(auth); }
        userId = auth.currentUser?.uid || crypto.randomUUID();
        document.getElementById('user-id-display').textContent = userId;
        console.log("Аутентификация успешна. UID:", userId);
        loadExistingProducts();
    } catch (error) {
        console.error("Ошибка аутентификации Firebase:", error);
        if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
            showMessage("Критическая ошибка: Включите 'Анонимную аутентификацию' в консоли Firebase (Authentication -> Sign-in method).");
        } else {
            showMessage("Ошибка аутентификации. Проверьте консоль для деталей.");
        }
    }
}

// --- CUSTOM MODAL IMPLEMENTATION (Replaces alert/confirm) ---
const modalOverlay = document.getElementById('custom-modal');
const modalMessage = document.getElementById('modal-message');
const modalConfirmBtn = document.getElementById('modal-btn-confirm');
const modalCancelBtn = document.getElementById('modal-btn-cancel');
function closeModal() {
    modalOverlay.classList.add('hidden');
    modalConfirmBtn.onclick = null;
    modalCancelBtn.onclick = null;
}
function showMessage(message) {
    modalMessage.textContent = message;
    modalCancelBtn.classList.add('hidden');
    modalConfirmBtn.textContent = 'ОК';
    modalConfirmBtn.onclick = closeModal;
    modalOverlay.classList.remove('hidden');
}
function showConfirm(message, onConfirm) {
    modalMessage.textContent = message;
    modalCancelBtn.classList.remove('hidden');
    modalConfirmBtn.textContent = 'Подтвердить';
    modalConfirmBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
    modalCancelBtn.onclick = closeModal;
    modalOverlay.classList.remove('hidden');
}

// --- GLOBAL STATE ---
let productId = null, images = [], imagesMeta = [], facades = [], materials = [], colors = [], combinations = []; 
// images: array of url strings (legacy + display)
// imagesMeta: array of objects { url, color } - used to map image -> color

// --- DOM ELEMENTS (Привязка элементов) ---
const titleInput = document.getElementById('title'), categoryInput = document.getElementById('category');
const imagesContainer = document.getElementById('images-container'), addImageBtn = document.getElementById('add-image-btn');
const imageUrlInputArea = document.getElementById('image-url-input-area'), imageUrlInput = document.getElementById('image-url-input');
const imageUrlColorSelect = document.getElementById('image-url-color-select');
const imageUrlOkBtn = document.getElementById('image-url-ok-btn'), imageUrlCancelBtn = document.getElementById('image-url-cancel-btn');
const facadesContainer = document.getElementById('facades-container'), addFacadeBtn = document.getElementById('add-facade-btn');
const facadeDynamicArea = document.getElementById('facade-dynamic-input-area'), facadeInput = document.getElementById('facade-input');
const facadeOkBtn = document.getElementById('facade-ok-btn'), facadeCancelBtn = document.getElementById('facade-cancel-btn');
const materialsContainer = document.getElementById('materials-container'), addMaterialBtn = document.getElementById('add-material-btn');
const materialDynamicArea = document.getElementById('material-dynamic-input-area'), materialInput = document.getElementById('material-input');
const materialOkBtn = document.getElementById('material-ok-btn'), materialCancelBtn = document.getElementById('material-cancel-btn');
const colorsContainer = document.getElementById('colors-container'), addColorBtn = document.getElementById('add-color-btn');
const colorDynamicArea = document.getElementById('color-dynamic-input-area'), colorNameInput = document.getElementById('color-name');
const colorHexInput = document.getElementById('color-hex');
const colorOkBtn = document.getElementById('color-ok-btn'), colorCancelBtn = document.getElementById('color-cancel-btn');
const combinationsContainer = document.getElementById('combinations-container'), addComboBtn = document.getElementById('add-combo-btn');
const saveBtn = document.getElementById('save-product-btn'), clearBtn = document.getElementById('clear-product-btn');
const existingProductsDiv = document.getElementById('existing-products');


// --- Render Functions ---

function renderImages(){
    imagesContainer.innerHTML = images.length === 0 ? '<p class="text-sm text-gray-500">Нет загруженных изображений.</p>' : "";
    images.forEach((url, i) => {
        const meta = imagesMeta.find(m => m.url === url) || { url, color: '' };
        const div = document.createElement('div');
        div.className = "images-list-item";
        div.innerHTML = `
            <div class="thumbnail"><img src="${url}" onerror="this.src='https://placehold.co/60x60/cccccc/333333?text=Нет'" alt="Превью"></div>
            <div class="meta">
                <div class="url">${url}</div>
                <select class="input-field image-color-select">
                    <option value="">— Без привязки к цвету —</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-delete small-btn">Удалить</button>
            </div>
        `;
        // populate color select
        const select = div.querySelector('.image-color-select');
        colors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            if (c.name === meta.color) opt.selected = true;
            select.appendChild(opt);
        });
        select.onchange = e => {
            const selected = e.target.value || '';
            // update imagesMeta
            const idx = imagesMeta.findIndex(m => m.url === url);
            if (idx >= 0) imagesMeta[idx].color = selected;
            else imagesMeta.push({ url, color: selected });
        };

        div.querySelector('.btn-delete').onclick = () => {
            // remove from images and imagesMeta
            images.splice(i, 1);
            const metaIdx = imagesMeta.findIndex(m => m.url === url);
            if (metaIdx >= 0) imagesMeta.splice(metaIdx, 1);
            renderImages();
        };
        imagesContainer.appendChild(div);
    });
    // update the quick add color select
    populateImageUrlColorSelect();
}

function populateImageUrlColorSelect(){
    // fill imageUrlColorSelect with current colors
    imageUrlColorSelect.innerHTML = `<option value="">— Без привязки к цвету —</option>`;
    colors.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        imageUrlColorSelect.appendChild(opt);
    });
}

function createOptionBtn(text, index, list, renderFunction) {
    const btn=document.createElement('button');
    btn.className="option-btn";
    btn.textContent=text;
    btn.onclick=()=>{ 
        list.splice(index,1); 
        renderFunction(); 
        renderCombinations(); 
        // when a color is removed, remove associations in imagesMeta
        if (renderFunction === renderColors) {
            imagesMeta.forEach(m => { if (m.color === text) m.color = ''; });
            renderImages();
        }
    };
    return btn;
}

function renderFacades(){
    facadesContainer.innerHTML="";
    facades.forEach((f,i)=>{
        facadesContainer.appendChild(createOptionBtn(f, i, facades, renderFacades));
    });
}

function renderMaterials(){
    materialsContainer.innerHTML="";
    materials.forEach((m,i)=>{
        materialsContainer.appendChild(createOptionBtn(m, i, materials, renderMaterials));
    });
}

function renderColors(){
    colorsContainer.innerHTML="";
    colors.forEach((c,i)=>{
        const btn=document.createElement('button');
        btn.className="option-btn text-gray-800"; 
        btn.innerHTML = `<span style="background-color: ${c.hex}; width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc; display: inline-block; margin-right: 6px;"></span> ${c.name}`;
        
        btn.onclick=()=>{ 
            colors.splice(i,1); 
            renderColors(); 
            renderCombinations(); 
            // when color removed, clear image associations
            imagesMeta.forEach(m => { if (m.color === c.name) m.color = ''; });
            renderImages();
        };
        colorsContainer.appendChild(btn);
    });
    populateImageUrlColorSelect();
    // also update selects in existing image items
    const selects = document.querySelectorAll('.image-color-select');
    selects.forEach(sel => {
        // rebuild options keeping current selection
        const current = sel.value;
        sel.innerHTML = `<option value="">— Без привязки к цвету —</option>`;
        colors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            if (c.name === current) opt.selected = true;
            sel.appendChild(opt);
        });
    });
}

function renderCombinations() {
    combinationsContainer.innerHTML = "";
    const colorNames = colors.map(c => c.name);

    combinations.forEach((combo, i) => {
        // Нормализуем поля (если кто-то сохранил старые ключи)
        combo.material = combo.material || combo["материал"] || "";
        combo.facade = combo.facade || combo["фасад"] || "";
        combo.color = combo.color || combo["цвет"] || "";
        delete combo["материал"];
        delete combo["фасад"];
        delete combo["цвет"];

        const div = document.createElement("div");
        div.className = "flex flex-col sm:flex-row gap-2 mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg items-start sm:items-center";

        const createSelect = (label, options, key) => {
            const select = document.createElement("select");
            select.className = "input-field flex-grow";
            select.innerHTML = `<option value="">-- ${label} --</option>`;
            options.forEach(opt => {
                select.innerHTML += `<option value="${opt}" ${opt === combo[key] ? "selected" : ""}>${opt}</option>`;
            });
            select.onchange = e => combo[key] = e.target.value;
            return select;
        };

        const selectsDiv = document.createElement("div");
        selectsDiv.className = "flex w-full sm:w-8/12 gap-2 flex-wrap sm:flex-nowrap";
        selectsDiv.appendChild(createSelect("Материал", materials, "material"));
        selectsDiv.appendChild(createSelect("Фасад", facades, "facade"));
        selectsDiv.appendChild(createSelect("Цвет", colorNames, "color"));

        const controlsDiv = document.createElement("div");
        controlsDiv.className = "flex w-full sm:w-4/12 gap-2 items-center";

        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.className = "input-field w-24";
        priceInput.value = combo.price || 0;
        priceInput.placeholder = "Цена";
        priceInput.oninput = e => combo.price = parseFloat(e.target.value) || 0;

        const discountInput = document.createElement("input");
        discountInput.type = "number";
        discountInput.className = "input-field w-20";
        discountInput.value = combo.discount || 0;
        discountInput.placeholder = "Скидка %";
        discountInput.oninput = e => combo.discount = parseFloat(e.target.value) || 0;

        const activeLabel = document.createElement("label");
        activeLabel.className = "flex items-center gap-1 text-sm text-gray-600";
        const activeCheckbox = document.createElement("input");
        activeCheckbox.type = "checkbox";
        activeCheckbox.checked = combo.isActive || false;
        activeCheckbox.onchange = e => combo.isActive = e.target.checked;
        activeLabel.append(activeCheckbox, "Активно");

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-delete py-2 px-3 text-sm flex-shrink-0";
        deleteBtn.textContent = "X";
        deleteBtn.onclick = () => {
            combinations.splice(i, 1);
            renderCombinations();
        };

        controlsDiv.append(priceInput, discountInput, activeLabel, deleteBtn);
        div.append(selectsDiv, controlsDiv);
        combinationsContainer.appendChild(div);
    });
}

// --- Existing Products ---
function loadExistingProducts(){
    if (!db) return;

    onSnapshot(collection(db, productCollectionPath), snapshot=>{
        existingProductsDiv.innerHTML='';
        snapshot.docs.forEach(docSnap=>{
            const data=docSnap.data();
            const overallActive = data.combinations ? data.combinations.some(c => c.isActive) : false;

            const div=document.createElement('div');
            div.className="flex justify-between items-center bg-white p-3 rounded-xl shadow-md border-l-4" + (overallActive ? ' border-green-500' : ' border-red-500');
            
            const titleStatus = `
                <div class="flex items-center">
                    <span class="font-semibold text-gray-800 mr-3">${data.title||"Без названия"}</span>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${overallActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${overallActive ? 'Активен' : 'Неактивен'}
                    </span>
                </div>
            `;
            
            div.innerHTML=`${titleStatus}
                                <div class="flex gap-2 flex-shrink-0">
                                    <button class="btn btn-save py-2 px-3 text-sm">Редактировать</button>
                                    <button class="btn btn-delete py-2 px-3 text-sm">Удалить</button>
                                </div>`;
            
            div.querySelectorAll('button')[0].onclick=()=>editProduct(docSnap.id);
            div.querySelectorAll('button')[1].onclick=()=>{ 
                showConfirm('Вы уверены, что хотите удалить товар: ' + (data.title || 'Без названия') + '?', async () => {
                    try {
                        if (db) await deleteDoc(doc(db, productCollectionPath, docSnap.id));
                        showMessage("Товар успешно удалён.");
                    } catch (e) {
                        console.error("Ошибка удаления:", e);
                        showMessage("Ошибка при удалении товара.");
                    }
                });
            };
            existingProductsDiv.appendChild(div);
        });
    });
}

async function editProduct(id){
    if (!db) return showMessage("Ошибка: База данных не инициализирована.");
    try {
        const docSnap=await getDoc(doc(db, productCollectionPath, id));
        if(!docSnap.exists()) return showMessage("Товар не найден!");
        
        const data=docSnap.data();
        productId=id;
        titleInput.value=data.title||'';
        categoryInput.value=data.category||'';
        
        // images may be stored as array of strings (legacy) and/or image_color_map
        images = data.images ? [...data.images] : [];
        imagesMeta = [];
        if (Array.isArray(data.image_color_map)) {
            imagesMeta = data.image_color_map.map(m => ({ url: m.url, color: m.color || '' }));
            // ensure images list includes mapped urls
            imagesMeta.forEach(m => { if (!images.includes(m.url)) images.push(m.url); });
        } else {
            // build empty meta for existing images
            images.forEach(u => imagesMeta.push({ url: u, color: '' }));
        }
        renderImages();

        facades = data.facades ? [...data.facades] : [];
        materials = data.materials ? [...data.materials] : [];
        colors = data.colors ? [...data.colors] : []; // expected items {name,hex}
        combinations = data.combinations ? [...data.combinations] : [];

        renderFacades();
        renderMaterials(); 
        renderColors();
        renderCombinations();
        
        document.querySelectorAll('[id$="-dynamic-input-area"]').forEach(el => el.classList.add('hidden'));
        [addFacadeBtn, addMaterialBtn, addColorBtn, addImageBtn].forEach(btn => btn.disabled = false);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
        console.error("Ошибка при загрузке товара для редактирования:", e);
        showMessage("Не удалось загрузить данные товара.");
    }
}


// --- Event Handlers for Dynamic Inputs ---

function finishInput(dynamicArea, addButton, renderFunc) {
    dynamicArea.classList.add('hidden');
    addButton.disabled = false; 
    renderFunc();
    renderCombinations(); 
}

// --- ФАСАДЫ ---
function setupFacadeHandlers() {
    if (!addFacadeBtn) return; 

    addFacadeBtn.onclick = () => {
        facadeDynamicArea.classList.remove('hidden');
        addFacadeBtn.disabled = true; 
        facadeInput.value = '';
        facadeInput.focus();
    };
    facadeOkBtn.onclick = () => {
        const val = facadeInput.value.trim();
        if (val && !facades.includes(val)) { facades.push(val); }
        finishInput(facadeDynamicArea, addFacadeBtn, renderFacades);
    };
    facadeCancelBtn.onclick = () => {
        finishInput(facadeDynamicArea, addFacadeBtn, renderFacades);
    };
}

// --- МАТЕРИАЛЫ ---
function setupMaterialHandlers() {
    if (!addMaterialBtn) return; 

    addMaterialBtn.onclick = () => {
        materialDynamicArea.classList.remove('hidden');
        addMaterialBtn.disabled = true;
        materialInput.value = '';
        materialInput.focus();
    };
    materialOkBtn.onclick = () => {
        const val = materialInput.value.trim();
        if (val && !materials.includes(val)) { materials.push(val); }
        finishInput(materialDynamicArea, addMaterialBtn, renderMaterials);
    };
    materialCancelBtn.onclick = () => {
        finishInput(materialDynamicArea, addMaterialBtn, renderMaterials);
    };
}

// --- ЦВЕТА ---
function setupColorHandlers() {
    if (!addColorBtn) return; 

    addColorBtn.onclick = () => {
        colorDynamicArea.classList.remove('hidden');
        addColorBtn.disabled = true;
        colorNameInput.value = '';
        colorHexInput.value = '#f97316';
        colorNameInput.focus();
    };
    colorOkBtn.onclick = () => {
        const name = colorNameInput.value.trim();
        const hex = colorHexInput.value;
        if (name && hex) { 
            const isDuplicate = colors.some(c => c.name.toLowerCase() === name.toLowerCase());
            if (!isDuplicate) {
                colors.push({ name, hex }); 
            } else {
                showMessage(`Цвет с именем "${name}" уже существует.`);
            }
        }
        finishInput(colorDynamicArea, addColorBtn, renderColors);
    };
    colorCancelBtn.onclick = () => {
        finishInput(colorDynamicArea, addColorBtn, renderColors);
    };
}

// --- Общие Хендлеры ---
function setupGeneralHandlers() {
    // 1. Добавление URL изображения
    addImageBtn.onclick = () => {
        imageUrlInputArea.classList.remove('hidden');
        addImageBtn.disabled = true;
        imageUrlInput.value = '';
        imageUrlColorSelect.value = '';
        imageUrlInput.focus();
    };
    imageUrlOkBtn.onclick = () => {
        const url = imageUrlInput.value.trim();
        const chosenColor = imageUrlColorSelect.value || '';
        if (url && url.startsWith('http')) {
            if (!images.includes(url)) {
                images.push(url);
                imagesMeta.push({ url, color: chosenColor });
            } else {
                // update meta if exists
                const idx = imagesMeta.findIndex(m => m.url === url);
                if (idx >= 0) imagesMeta[idx].color = chosenColor;
                showMessage("Этот URL уже добавлен — обновлена привязка к цвету.");
            }
        } else if (url) {
            showMessage("Пожалуйста, введите корректный URL, начинающийся с 'http'.");
        }
        imageUrlInputArea.classList.add('hidden');
        addImageBtn.disabled = false;
        renderImages();
    };
    imageUrlCancelBtn.onclick = () => {
        imageUrlInputArea.classList.add('hidden');
        addImageBtn.disabled = false;
        imageUrlInput.value = '';
    };


    addComboBtn.onclick=()=>{ 
        combinations.push({
            material: materials[0] || '', 
            facade: facades[0] || '',
            color: colors.length > 0 ? colors[0].name : '',
            price: 0,
            isActive: true,
            discount: 0
        }); 
        renderCombinations(); 
    };

    saveBtn.onclick=async()=>{
        if (!db) { return showMessage("Ошибка: База данных не инициализирована. Проверьте конфигурацию Firebase."); }
        
        const data={
            title:titleInput.value.trim(),
            category:categoryInput.value.trim(),
            images: images.filter(url => url.trim() !== ''), // legacy arrays of urls
            facades: facades.filter(f => f.trim() !== ''),
            materials: materials.filter(m => m.trim() !== ''),
            colors,
            // сохраняем карту изображений отдельно, чтобы фронтенд мог её использовать
            image_color_map: imagesMeta.map(m => ({ url: m.url, color: m.color || "" })).filter(m => m.url),
            // Фильтруем комбинации, чтобы не сохранять пустые
            combinations: combinations
                .map(c => ({
                    material: c.material || "",
                    facade: c.facade || "",
                    color: c.color || "",
                    price: Number(c.price) || 0,
                    discount: Number(c.discount) || 0,
                    isActive: !!c.isActive
                }))
                .filter(c => c.material || c.facade || c.color)
        };

        if(!data.title){ return showMessage("Введите название товара!"); }
        if(!data.category){ return showMessage("Выберите категорию товара!"); }

        try {
            if(productId){
                await setDoc(doc(db, productCollectionPath, productId), data);
                showMessage("Товар успешно обновлён!");
            }else{
                const docRef=await addDoc(collection(db, productCollectionPath), data);
                productId=docRef.id;
                showMessage("Товар успешно создан!");
            }
        } catch(e) {
            console.error("Ошибка сохранения товара:", e);
            showMessage("Ошибка при сохранении данных. Проверьте консоль.");
        }
    };

    clearBtn.onclick=()=>{
        productId=null; 
        titleInput.value=''; 
        categoryInput.value='';
        images=[], imagesMeta=[], facades=[], materials=[], colors=[], combinations=[];
        renderImages(); renderFacades(); renderMaterials(); renderColors(); renderCombinations();
        showMessage("Форма очищена. Вы готовы к созданию нового товара.");
    };
}


// --- RUNTIME INITIATION ---
window.onload = () => {
    initializeFirebase();
    initializeAuth(); 
    
    setupFacadeHandlers();
    setupMaterialHandlers();
    setupColorHandlers();
    setupGeneralHandlers();
    
    // initial empty renders
    renderImages();
    renderFacades();
    renderMaterials();
    renderColors();
    renderCombinations();
};
</script>
</body>
</html>