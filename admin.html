<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∫–∞ Mebel.by</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans', sans-serif; background:#f7f7f7; }
        .input-field { border:2px solid #ddd; padding:0.5rem; border-radius:0.5rem; width:100%; transition: border-color 0.2s; }
        .input-field:focus { border-color: #f97316; outline: none; }
        .section { background:white; padding:1.5rem; border-radius:1rem; margin-bottom:1.5rem; box-shadow:0 6px 15px rgba(0,0,0,0.08); }
        .btn { padding:0.6rem 1.2rem; border-radius:0.5rem; font-weight:600; cursor:pointer; transition:0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; }
        .btn-save { background:#f97316;color:white; }
        .btn-save:hover:not(:disabled) { background:#ea580c; box-shadow: 0 4px 6px rgba(234,88,12,0.3); }
        .btn-save:disabled { background:#fcd34d; cursor: not-allowed; } 
        .btn-delete { background:#ef4444;color:white; }
        .btn-delete:hover { background:#b91c1c; box-shadow: 0 4px 6px rgba(239,68,68,0.3); }
        .option-btn { border:2px solid #f97316; background:#ffedd5; padding:0.3rem 0.8rem; margin-right:0.3rem; margin-bottom:0.3rem; border-radius:0.5rem; cursor:pointer; transition:0.2s; white-space: nowrap; display: inline-flex; align-items: center; }
        .option-btn:hover { background: #f97316; color: white; }
        .thumbnail { width:60px;height:60px;object-fit:cover;border:2px solid #ddd;border-radius:0.5rem;flex-shrink: 0;}
        .thumbnail img { width:100%; height:100%; object-fit:cover; border-radius:0.3rem; }
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        /* Select arrow styles */
        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 011.414 0L10 10.586l3.293-3.293a1 1 011.414 1.414l-4 4a1 1 01-1.414 0l-4-4a1 1 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
                #carousel-banner {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 1.5rem;
        }
        @media (min-width: 1024px) {
            #carousel-banner { height: 380px; }
        }
        @media (min-width: 640px) and (max-width: 1023px) {
            #carousel-banner { height: 260px; }
        }
        @media (max-width: 639px) {
            #carousel-banner { height: 200px; }
        }
        #carousel-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .images-list-item { display:flex; gap:0.75rem; align-items:center; background:#fff; padding:0.5rem; border-radius:0.75rem; border:1px solid #eee; }
        .images-list-item .meta { display:flex; gap:0.5rem; align-items:center; width:100%; }
        .images-list-item .meta select { max-width:220px; }
        .images-list-item .meta .url { flex:1; font-size:13px; color:#374151; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .small-btn { padding:0.3rem 0.6rem; font-size:13px; border-radius:0.5rem; }
    </style>
</head>
<body class="p-4 sm:p-6">

<h1 class="text-3xl font-bold mb-6 text-gray-800">–ê–¥–º–∏–Ω–∫–∞ Mebel.by</h1>

<div class="section">
    <h2 class="text-xl font-bold mb-4 text-gray-700">–°–æ–∑–¥–∞–Ω–∏–µ / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
    
    <div class="mb-4">
        <label class="font-semibold text-gray-600">ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <div id="user-id-display" class="p-2 bg-gray-100 rounded-lg text-sm truncate">...</div>
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="title" class="input-field" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="category" class="input-field">
            <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
            <option value="–î–∏–≤–∞–Ω—ã">–î–∏–≤–∞–Ω—ã</option>
            <option value="–ö—Ä–æ–≤–∞—Ç–∏">–ö—Ä–æ–≤–∞—Ç–∏</option>
            <option value="–®–∫–∞—Ñ—ã">–®–∫–∞—Ñ—ã</option>
            <option value="–°—Ç–æ–ª—ã">–°—Ç–æ–ª—ã –∏ –°—Ç—É–ª—å—è</option>
            <option value="–ö—É—Ö–Ω–∏">–ö—É—Ö–Ω–∏</option>
        </select>
    
    </div>

 <div class="mb-4">
    <label class="font-semibold text-gray-600">–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –º–∞–≥–∞–∑–∏–Ω—É</label>
    <select id="shop-select" class="input-field">
        <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>
        </select>
</div>

    <div class="mb-4">
    <label class="font-semibold text-gray-600">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
    <textarea id="description" class="input-field h-24 resize-none" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
    </div>

    
    <div class="mb-4">
        <label class="font-semibold text-gray-600">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (URL) ‚Äî –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ —Ü–≤–µ—Ç—É</label>
        <div id="images-container" class="space-y-2"></div>
        
        <div id="image-url-input-area" class="flex gap-2 mt-2 hidden">
            <input id="image-url-input" class="input-field" type="url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (http://...)">
            <select id="image-url-color-select" class="input-field w-48">
                <option value="">‚Äî –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ü–≤–µ—Ç—É ‚Äî</option>
            </select>
            <button id="image-url-ok-btn" class="btn btn-save text-sm px-4">–û–ö</button>
            <button id="image-url-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <button id="add-image-btn" class="btn mt-2 btn-save">–î–æ–±–∞–≤–∏—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
        <p class="text-xs text-gray-500 mt-2">–ü—Ä–∏–≤—è–∑–∞–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ —Ü–≤–µ—Ç—É, –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ü–≤–µ—Ç–∞ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</p>
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">–§–∞—Å–∞–¥—ã</label>
        <div id="facades-container" class="flex gap-2 flex-wrap mt-2 mb-2"></div>
        
        <div id="facade-dynamic-input-area" class="flex gap-2 mt-2 hidden">
            <input id="facade-input" class="input-field" placeholder="–ù–æ–≤—ã–π —Ñ–∞—Å–∞–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ì–ª—è–Ω–µ—Ü)">
            <button id="facade-ok-btn" class="btn btn-save text-sm px-4">–û–ö</button>
            <button id="facade-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <button id="add-facade-btn" class="btn btn-save mt-2">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞—Å–∞–¥</button>
    </div>
    
    <div class="mb-4">
        <label class="font-semibold text-gray-600">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</label>
        <div id="materials-container" class="flex gap-2 flex-wrap mt-2 mb-2"></div>

        <div id="material-dynamic-input-area" class="flex gap-2 mt-2 hidden">
            <input id="material-input" class="input-field" placeholder="–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–î–§)">
            <button id="material-ok-btn" class="btn btn-save text-sm px-4">–û–ö</button>
            <button id="material-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <button id="add-material-btn" class="btn btn-save mt-2">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">–¶–≤–µ—Ç–∞</label>
        <div id="colors-container" class="flex gap-2 flex-wrap mt-2 mb-2"></div>

        <div id="color-dynamic-input-area" class="flex flex-col sm:flex-row gap-2 mt-2 hidden p-3 border border-gray-100 rounded-lg bg-gray-50">
            <input id="color-name" class="input-field" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞">
            <input id="color-hex" class="w-full sm:w-16 h-10 border-2 border-gray-300 rounded-lg p-0" type="color" value="#f97316">
            <div class="flex gap-2 justify-end w-full sm:w-auto">
                <button id="color-ok-btn" class="btn btn-save text-sm px-4">–û–ö</button>
                <button id="color-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        
        <button id="add-color-btn" class="btn btn-save mt-2">–î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç</button>
    </div>

    <div class="mb-4">
        <label class="font-semibold text-gray-600">–í–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–≤–∞—Ä–∞ (–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ú–∞—Ç–µ—Ä–∏–∞–ª - –§–∞—Å–∞–¥ - –¶–≤–µ—Ç)</label>
        <div id="combinations-container"></div>
        <button id="add-combo-btn" class="btn btn-save mt-2">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é</button>
    </div>

    <div class="flex gap-3 pt-4 border-t border-gray-100">
        <button id="save-product-btn" class="btn btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        <button id="clear-product-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
    </div>
</div>

<div class="section">
    <h2 class="text-xl font-bold mb-4 text-gray-700">–ö–∞—Ä—É—Å–µ–ª—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ</h2>

    <div id="carousel-container" class="space-y-2"></div>

    <div id="carousel-url-input-area" class="flex gap-2 mt-2 hidden">
        <input id="carousel-url-input" class="input-field" type="url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (http://...)">
        <button id="carousel-url-ok-btn" class="btn btn-save text-sm px-4">–û–ö</button>
        <button id="carousel-url-cancel-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 text-sm px-4">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div class="flex gap-2 mt-2">
        <button id="add-carousel-btn" class="btn btn-save">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–∞—Ä—É—Å–µ–ª—å</button>
        <button id="save-carousel-btn" class="btn bg-green-500 text-white hover:bg-green-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <p class="text-xs text-gray-500 mt-2">–ú–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞—Ä—É—Å–µ–ª–∏.</p>
</div>

<h2 class="text-xl font-bold mb-4 text-gray-700">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã</h2>
<div id="existing-products" class="space-y-3"></div>

<div id="custom-modal" class="modal-overlay hidden" onclick="if(event.target.id === 'custom-modal') closeModal()">
    <div class="modal-content" id="modal-content" onclick="event.stopPropagation()">
        <p id="modal-message" class="text-gray-700 mb-4"></p>
        <div id="modal-buttons" class="flex justify-end gap-3">
            <button id="modal-btn-cancel" class="btn px-4 bg-gray-200 text-gray-700 hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
            <button id="modal-btn-confirm" class="btn btn-save">OK</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, getDoc, deleteDoc, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

setLogLevel('Debug');

// --- FIREBASE CONFIGURATION & AUTH VARIABLES ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
const HARDCODED_FIREBASE_CONFIG = {
    apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70", 
    authDomain: "vsemmebel-90d48.firebaseapp.com",
    projectId: "vsemmebel-90d48", 
    storageBucket: "vsemmebel-90d48.appspot.com", 
    messagingSenderId: "958123504041",
    appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};

let firebaseConfig = null, app = null, db = null, auth = null, userId = null;
const productCollectionPath = `artifacts/${appId}/public/data/offers`;
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –û–±—ä—è–≤–ª–µ–Ω–∏–µ shopsCollectionPath –≤—ã–Ω–µ—Å–µ–Ω–æ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
const shopsCollectionPath = `artifacts/${appId}/public/data/shops`;

// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
function initializeFirebase() {
    if (firebaseConfigString) {
        try { firebaseConfig = JSON.parse(firebaseConfigString); } catch (e) {
            console.error("–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Ö–æ—Å—Ç–∏–Ω–≥–∞.", e);
        }
    } 
    if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "–í–ê–®_API_KEY") {
        firebaseConfig = HARDCODED_FIREBASE_CONFIG;
        console.warn("–í–ù–ò–ú–ê–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase.");
    }
    if (firebaseConfig && firebaseConfig.apiKey) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase.", e);
            db = null; 
        }
    } else {
        console.error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞.");
        db = null;
    }
}

// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
async function initializeAuth() {
    if (!auth) { userId = crypto.randomUUID(); return; }
    try {
        if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
        else { await signInAnonymously(auth); }
        userId = auth.currentUser?.uid || crypto.randomUUID();
        document.getElementById('user-id-display').textContent = userId;
        console.log("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. UID:", userId);
        loadExistingProducts();
        loadShops(); // –í—ã–∑—ã–≤–∞–µ–º loadShops –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Firebase:", error);
        if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
            showMessage("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –í–∫–ª—é—á–∏—Ç–µ '–ê–Ω–æ–Ω–∏–º–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é' –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase (Authentication -> Sign-in method).");
        } else {
            showMessage("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
        }
    }
}

// --- CUSTOM MODAL IMPLEMENTATION (Replaces alert/confirm) ---
const modalOverlay = document.getElementById('custom-modal');
const modalMessage = document.getElementById('modal-message');
const modalConfirmBtn = document.getElementById('modal-btn-confirm');
const modalCancelBtn = document.getElementById('modal-btn-cancel');
function closeModal() {
    modalOverlay.classList.add('hidden');
    modalConfirmBtn.onclick = null;
    modalCancelBtn.onclick = null;
}
function showMessage(message) {
    modalMessage.textContent = message;
    modalCancelBtn.classList.add('hidden');
    modalConfirmBtn.textContent = '–û–ö';
    modalConfirmBtn.onclick = closeModal;
    modalOverlay.classList.remove('hidden');
}
function showConfirm(message, onConfirm) {
    modalMessage.textContent = message;
    modalCancelBtn.classList.remove('hidden');
    modalConfirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    modalConfirmBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
    modalCancelBtn.onclick = closeModal;
    modalOverlay.classList.remove('hidden');
}

// --- GLOBAL STATE ---
let productId = null, images = [], imagesMeta = [], facades = [], materials = [], colors = [], combinations = [], carouselImages = [];
// images: array of url strings (legacy + display)
// imagesMeta: array of objects { url, color } - used to map image -> color

// --- DOM ELEMENTS (–ü—Ä–∏–≤—è–∑–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤) ---
const titleInput = document.getElementById('title'), categoryInput = document.getElementById('category');
const imagesContainer = document.getElementById('images-container'), addImageBtn = document.getElementById('add-image-btn');
const imageUrlInputArea = document.getElementById('image-url-input-area'), imageUrlInput = document.getElementById('image-url-input');
const imageUrlColorSelect = document.getElementById('image-url-color-select');
const imageUrlOkBtn = document.getElementById('image-url-ok-btn'), imageUrlCancelBtn = document.getElementById('image-url-cancel-btn');
const facadesContainer = document.getElementById('facades-container'), addFacadeBtn = document.getElementById('add-facade-btn');
const facadeDynamicArea = document.getElementById('facade-dynamic-input-area'), facadeInput = document.getElementById('facade-input');
const facadeOkBtn = document.getElementById('facade-ok-btn'), facadeCancelBtn = document.getElementById('facade-cancel-btn');
const materialsContainer = document.getElementById('materials-container'), addMaterialBtn = document.getElementById('add-material-btn');
const materialDynamicArea = document.getElementById('material-dynamic-input-area'), materialInput = document.getElementById('material-input');
const materialOkBtn = document.getElementById('material-ok-btn'), materialCancelBtn = document.getElementById('material-cancel-btn');
const colorsContainer = document.getElementById('colors-container'), addColorBtn = document.getElementById('add-color-btn');
const colorDynamicArea = document.getElementById('color-dynamic-input-area'), colorNameInput = document.getElementById('color-name');
const colorHexInput = document.getElementById('color-hex');
const colorOkBtn = document.getElementById('color-ok-btn'), colorCancelBtn = document.getElementById('color-cancel-btn');
const combinationsContainer = document.getElementById('combinations-container'), addComboBtn = document.getElementById('add-combo-btn');
const saveBtn = document.getElementById('save-product-btn'), clearBtn = document.getElementById('clear-product-btn');
const existingProductsDiv = document.getElementById('existing-products');
const descriptionInput = document.getElementById('description');
const shopSelect = document.getElementById('shop-select');
const addCarouselBtn = document.getElementById('add-carousel-btn');
const carouselUrlInputArea = document.getElementById('carousel-url-input-area');
const carouselUrlInput = document.getElementById('carousel-url-input');
const carouselUrlOkBtn = document.getElementById('carousel-url-ok-btn');
const carouselUrlCancelBtn = document.getElementById('carousel-url-cancel-btn');

// --- Render Functions ---

function renderImages(){
    imagesContainer.innerHTML = images.length === 0 ? '<p class="text-sm text-gray-500">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</p>' : "";
    images.forEach((url, i) => {
        const meta = imagesMeta.find(m => m.url === url) || { url, color: '' };
        const div = document.createElement('div');
        div.className = "images-list-item";
        div.innerHTML = `
            <div class="thumbnail"><img src="${url}" onerror="this.src='https://placehold.co/60x60/cccccc/333333?text=–ù–µ—Ç'" alt="–ü—Ä–µ–≤—å—é"></div>
            <div class="meta">
                <div class="url">${url}</div>
                <select class="input-field image-color-select">
                    <option value="">‚Äî –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ü–≤–µ—Ç—É ‚Äî</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-delete small-btn">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;
        // populate color select
        const select = div.querySelector('.image-color-select');
        colors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            if (c.name === meta.color) opt.selected = true;
            select.appendChild(opt);
        });
        select.onchange = e => {
            const selected = e.target.value || '';
            // update imagesMeta
            const idx = imagesMeta.findIndex(m => m.url === url);
            if (idx >= 0) imagesMeta[idx].color = selected;
            else imagesMeta.push({ url, color: selected });
        };

        div.querySelector('.btn-delete').onclick = () => {
            // remove from images and imagesMeta
            images.splice(i, 1);
            const metaIdx = imagesMeta.findIndex(m => m.url === url);
            if (metaIdx >= 0) imagesMeta.splice(metaIdx, 1);
            renderImages();
        };
        imagesContainer.appendChild(div);
    });
    // update the quick add color select
    populateImageUrlColorSelect();
}

function populateImageUrlColorSelect(){
    // fill imageUrlColorSelect with current colors
    imageUrlColorSelect.innerHTML = `<option value="">‚Äî –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ü–≤–µ—Ç—É ‚Äî</option>`;
    colors.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        imageUrlColorSelect.appendChild(opt);
    });
}

function createOptionBtn(text, index, list, renderFunction) {
    const btn=document.createElement('button');
    btn.className="option-btn";
    btn.textContent=text;
    btn.onclick=()=>{ 
        list.splice(index,1); 
        renderFunction(); 
        renderCombinations(); 
        // when a color is removed, remove associations in imagesMeta
        if (renderFunction === renderColors) {
            imagesMeta.forEach(m => { if (m.color === text) m.color = ''; });
            renderImages();
        }
    };
    return btn;
}

function renderFacades(){
    facadesContainer.innerHTML="";
    facades.forEach((f,i)=>{
        facadesContainer.appendChild(createOptionBtn(f, i, facades, renderFacades));
    });
}

function renderMaterials(){
    materialsContainer.innerHTML="";
    materials.forEach((m,i)=>{
        materialsContainer.appendChild(createOptionBtn(m, i, materials, renderMaterials));
    });
}

function renderColors(){
    colorsContainer.innerHTML="";
    colors.forEach((c,i)=>{
        const btn=document.createElement('button');
        btn.className="option-btn text-gray-800"; 
        btn.innerHTML = `<span style="background-color: ${c.hex}; width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc; display: inline-block; margin-right: 6px;"></span> ${c.name}`;
        
        btn.onclick=()=>{ 
            colors.splice(i,1); 
            renderColors(); 
            renderCombinations(); 
            // when color removed, clear image associations
            imagesMeta.forEach(m => { if (m.color === c.name) m.color = ''; });
            renderImages();
        };
        colorsContainer.appendChild(btn);
    });
    populateImageUrlColorSelect();
    // also update selects in existing image items
    const selects = document.querySelectorAll('.image-color-select');
    selects.forEach(sel => {
        // rebuild options keeping current selection
        const current = sel.value;
        sel.innerHTML = `<option value="">‚Äî –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ü–≤–µ—Ç—É ‚Äî</option>`;
        colors.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            if (c.name === current) opt.selected = true;
            sel.appendChild(opt);
        });
    });
}

function renderCombinations() {
    combinationsContainer.innerHTML = "";
    const colorNames = colors.map(c => c.name);

    combinations.forEach((combo, i) => {
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–ª—è (–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏)
        combo.material = combo.material || combo["–º–∞—Ç–µ—Ä–∏–∞–ª"] || "";
        combo.facade = combo.facade || combo["—Ñ–∞—Å–∞–¥"] || "";
        combo.color = combo.color || combo["—Ü–≤–µ—Ç"] || "";
        delete combo["–º–∞—Ç–µ—Ä–∏–∞–ª"];
        delete combo["—Ñ–∞—Å–∞–¥"];
        delete combo["—Ü–≤–µ—Ç"];

        const div = document.createElement("div");
        div.className = "flex flex-col sm:flex-row gap-2 mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg items-start sm:items-center";

        const createSelect = (label, options, key) => {
            const select = document.createElement("select");
            select.className = "input-field flex-grow";
            select.innerHTML = `<option value="">-- ${label} --</option>`;
            options.forEach(opt => {
                select.innerHTML += `<option value="${opt}" ${opt === combo[key] ? "selected" : ""}>${opt}</option>`;
            });
            select.onchange = e => combo[key] = e.target.value;
            return select;
        };

        const selectsDiv = document.createElement("div");
        selectsDiv.className = "flex w-full sm:w-8/12 gap-2 flex-wrap sm:flex-nowrap";
        selectsDiv.appendChild(createSelect("–ú–∞—Ç–µ—Ä–∏–∞–ª", materials, "material"));
        selectsDiv.appendChild(createSelect("–§–∞—Å–∞–¥", facades, "facade"));
        selectsDiv.appendChild(createSelect("–¶–≤–µ—Ç", colorNames, "color"));

        const controlsDiv = document.createElement("div");
        controlsDiv.className = "flex w-full sm:w-4/12 gap-2 items-center";

        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.className = "input-field w-24";
        priceInput.value = combo.price || 0;
        priceInput.placeholder = "–¶–µ–Ω–∞";
        priceInput.oninput = e => combo.price = parseFloat(e.target.value) || 0;

        const discountInput = document.createElement("input");
        discountInput.type = "number";
        discountInput.className = "input-field w-20";
        discountInput.value = combo.discount || 0;
        discountInput.placeholder = "–°–∫–∏–¥–∫–∞ %";
        discountInput.oninput = e => combo.discount = parseFloat(e.target.value) || 0;

        const activeLabel = document.createElement("label");
        activeLabel.className = "flex items-center gap-1 text-sm text-gray-600";
        const activeCheckbox = document.createElement("input");
        activeCheckbox.type = "checkbox";
        activeCheckbox.checked = combo.isActive || false;
        activeCheckbox.onchange = e => combo.isActive = e.target.checked;
        activeLabel.append(activeCheckbox, "–ê–∫—Ç–∏–≤–Ω–æ");

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-delete py-2 px-3 text-sm flex-shrink-0";
        deleteBtn.textContent = "X";
        deleteBtn.onclick = () => {
            combinations.splice(i, 1);
            renderCombinations();
        };

        controlsDiv.append(priceInput, discountInput, activeLabel, deleteBtn);
        div.append(selectsDiv, controlsDiv);
        combinationsContainer.appendChild(div);
    });
}

function renderCarouselImages() { 
    const container = document.getElementById('carousel-container');
    container.innerHTML = carouselImages.length === 0 ? '<p class="text-sm text-gray-500">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</p>' : '';
    carouselImages.forEach((url, i) => {
        const div = document.createElement('div');
        div.className = "images-list-item";
        div.innerHTML = `
            <div class="thumbnail"><img src="${url}" onerror="this.src='https://placehold.co/60x60/cccccc/333333?text=–ù–µ—Ç'" alt="–ü—Ä–µ–≤—å—é"></div>
            <div class="flex gap-2">
                <button class="btn btn-delete small-btn">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;
        div.querySelector('.btn-delete').onclick = () => {
            carouselImages.splice(i, 1);
            renderCarouselImages();
        };
        container.appendChild(div);
    });
}

// --- Existing Products ---
function loadExistingProducts(){
    if (!db) return;

    onSnapshot(collection(db, productCollectionPath), snapshot=>{
        existingProductsDiv.innerHTML='';
        snapshot.docs.forEach(docSnap=>{
            const data=docSnap.data();
            const overallActive = data.combinations ? data.combinations.some(c => c.isActive) : false;

            const div=document.createElement('div');
            div.className="flex justify-between items-center bg-white p-3 rounded-xl shadow-md border-l-4" + (overallActive ? ' border-green-500' : ' border-red-500');
            
            const titleStatus = `
                <div class="flex items-center">
                    <span class="font-semibold text-gray-800 mr-3">${data.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</span>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${overallActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${overallActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                    </span>
                </div>
            `;
            
            div.innerHTML=`${titleStatus}
                                <div class="flex gap-2 flex-shrink-0">
                                    <button class="btn btn-save py-2 px-3 text-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    <button class="btn btn-delete py-2 px-3 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>`;
            
            div.querySelectorAll('button')[0].onclick=()=>editProduct(docSnap.id);
            div.querySelectorAll('button')[1].onclick=()=>{ 
                showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä: ' + (data.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') + '?', async () => {
                    try {
                        if (db) await deleteDoc(doc(db, productCollectionPath, docSnap.id));
                        showMessage("–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.");
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", e);
                        showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.");
                    }
                });
            };
            existingProductsDiv.appendChild(div);
        });
    });
}

async function editProduct(id){
    if (!db) return showMessage("–û—à–∏–±–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");
    try {
        const docSnap=await getDoc(doc(db, productCollectionPath, id));
        if(!docSnap.exists()) return showMessage("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        
        const data=docSnap.data();
        productId=id;
        titleInput.value=data.title||'';
        descriptionInput.value = data.description || '';
        shopSelect.value = data.shopId || "";
        categoryInput.value=data.category||'';
        
        // images may be stored as array of strings (legacy) and/or image_color_map
        images = data.images ? [...data.images] : [];
        imagesMeta = [];
        if (Array.isArray(data.image_color_map)) {
            imagesMeta = data.image_color_map.map(m => ({ url: m.url, color: m.color || '' }));
            // ensure images list includes mapped urls
            imagesMeta.forEach(m => { if (!images.includes(m.url)) images.push(m.url); });
        } else {
            // build empty meta for existing images
            images.forEach(u => imagesMeta.push({ url: u, color: '' }));
        }
        renderImages();

        facades = data.facades ? [...data.facades] : [];
        materials = data.materials ? [...data.materials] : [];
        colors = data.colors ? [...data.colors] : []; // expected items {name,hex}
        combinations = data.combinations ? [...data.combinations] : [];

        renderFacades();
        renderMaterials(); 
        renderColors();
        renderCombinations();
        
        document.querySelectorAll('[id$="-dynamic-input-area"]').forEach(el => el.classList.add('hidden'));
        [addFacadeBtn, addMaterialBtn, addColorBtn, addImageBtn].forEach(btn => btn.disabled = false);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", e);
        showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞.");
    }
}


// --- Event Handlers for Dynamic Inputs ---

function finishInput(dynamicArea, addButton, renderFunc) {
    dynamicArea.classList.add('hidden');
    addButton.disabled = false; 
    renderFunc();
    renderCombinations(); 
}

// --- –§–ê–°–ê–î–´ ---
function setupFacadeHandlers() {
    if (!addFacadeBtn) return; 

    addFacadeBtn.onclick = () => {
        facadeDynamicArea.classList.remove('hidden');
        addFacadeBtn.disabled = true; 
        facadeInput.value = '';
        facadeInput.focus();
    };
    facadeOkBtn.onclick = () => {
        const val = facadeInput.value.trim();
        if (val && !facades.includes(val)) { facades.push(val); }
        finishInput(facadeDynamicArea, addFacadeBtn, renderFacades);
    };
    facadeCancelBtn.onclick = () => {
        finishInput(facadeDynamicArea, addFacadeBtn, renderFacades);
    };
}

// --- –ú–ê–¢–ï–†–ò–ê–õ–´ ---
function setupMaterialHandlers() {
    if (!addMaterialBtn) return; 

    addMaterialBtn.onclick = () => {
        materialDynamicArea.classList.remove('hidden');
        addMaterialBtn.disabled = true;
        materialInput.value = '';
        materialInput.focus();
    };
    materialOkBtn.onclick = () => {
        const val = materialInput.value.trim();
        if (val && !materials.includes(val)) { materials.push(val); }
        finishInput(materialDynamicArea, addMaterialBtn, renderMaterials);
    };
    materialCancelBtn.onclick = () => {
        finishInput(materialDynamicArea, addMaterialBtn, renderMaterials);
    };
}

// --- –¶–í–ï–¢–ê ---
function setupColorHandlers() {
    if (!addColorBtn) return; 

    addColorBtn.onclick = () => {
        colorDynamicArea.classList.remove('hidden');
        addColorBtn.disabled = true;
        colorNameInput.value = '';
        colorHexInput.value = '#f97316';
        colorNameInput.focus();
    };
    colorOkBtn.onclick = () => {
        const name = colorNameInput.value.trim();
        const hex = colorHexInput.value;
        if (name && hex) { 
            const isDuplicate = colors.some(c => c.name.toLowerCase() === name.toLowerCase());
            if (!isDuplicate) {
                colors.push({ name, hex }); 
            } else {
                showMessage(`–¶–≤–µ—Ç —Å –∏–º–µ–Ω–µ–º "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.`);
            }
        }
        finishInput(colorDynamicArea, addColorBtn, renderColors);
    };
    colorCancelBtn.onclick = () => {
        finishInput(colorDynamicArea, addColorBtn, renderColors);
    };
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –§—É–Ω–∫—Ü–∏—è loadShops –≤—ã–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
async function loadShops() {
    if (!db) return;
    try {
        const snapshot = await getDocs(collection(db, shopsCollectionPath));
        shopSelect.innerHTML = `<option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>`;
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const opt = document.createElement('option');
            opt.value = docSnap.id; // id –º–∞–≥–∞–∑–∏–Ω–∞
            opt.textContent = data.shopName || `(–ú–∞–≥–∞–∑–∏–Ω ${docSnap.id})`;
            shopSelect.appendChild(opt);
        });
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤:", e);
        showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤.");
    }
}


// --- –û–±—â–∏–µ –•–µ–Ω–¥–ª–µ—Ä—ã ---
function setupGeneralHandlers() {
    // 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    addImageBtn.onclick = () => {
        imageUrlInputArea.classList.remove('hidden');
        addImageBtn.disabled = true;
        imageUrlInput.value = '';
        imageUrlColorSelect.value = '';
        imageUrlInput.focus();
    };
    imageUrlOkBtn.onclick = () => {
        const url = imageUrlInput.value.trim();
        const chosenColor = imageUrlColorSelect.value || '';
        if (url && url.startsWith('http')) {
            if (!images.includes(url)) {
                images.push(url);
                imagesMeta.push({ url, color: chosenColor });
            } else {
                // update meta if exists
                const idx = imagesMeta.findIndex(m => m.url === url);
                if (idx >= 0) imagesMeta[idx].color = chosenColor;
                showMessage("–≠—Ç–æ—Ç URL —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ü–≤–µ—Ç—É.");
            }
        } else if (url) {
            showMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å 'http'.");
        }
        imageUrlInputArea.classList.add('hidden');
        addImageBtn.disabled = false;
        renderImages();
    };
    imageUrlCancelBtn.onclick = () => {
        imageUrlInputArea.classList.add('hidden');
        addImageBtn.disabled = false;
        imageUrlInput.value = '';
    };


    addComboBtn.onclick=()=>{ 
        combinations.push({
            material: materials[0] || '', 
            facade: facades[0] || '',
            color: colors.length > 0 ? colors[0].name : '',
            price: 0,
            isActive: true,
            discount: 0
        }); 
        renderCombinations(); 
    };

    saveBtn.onclick=async()=>{
        if (!db) { return showMessage("–û—à–∏–±–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase."); }
        
        const data={
            title:titleInput.value.trim(),
            category:categoryInput.value.trim(),
            description: descriptionInput.value.trim(),
            facades: facades.filter(f => f.trim() !== ''),
            materials: materials.filter(m => m.trim() !== ''),
            colors,
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–≥ –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
            image_color_map: imagesMeta.map(m => ({ url: m.url, color: m.color || "" })).filter(m => m.url),
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—É—Å—Ç—ã–µ
            combinations: combinations
                .map(c => ({
                    material: c.material || "",
                    facade: c.facade || "",
                    color: c.color || "",
                    price: Number(c.price) || 0,
                    discount: Number(c.discount) || 0,
                    isActive: !!c.isActive
                }))
                .filter(c => c.material || c.facade || c.color),
            images: images.filter(url => url.trim() !== ''), // legacy arrays of urls
            carouselImages: carouselImages.filter(url => url.trim() !== ''),
            shopId: shopSelect.value || null // –ü—Ä–∏–≤—è–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
        };

        if(!data.title){ return showMessage("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞!"); }
        if(!data.category){ return showMessage("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞!"); }

        try {
            if(productId){
                await setDoc(doc(db, productCollectionPath, productId), data);
                showMessage("–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!");
            }else{
                const docRef=await addDoc(collection(db, productCollectionPath), data);
                productId=docRef.id;
                showMessage("–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
            }
        } catch(e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:", e);
            showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
        }
    };
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –±–ª–æ–∫ data = {} –ø–æ—Å–ª–µ saveBtn.onclick
    
    clearBtn.onclick=()=>{
        productId=null; 
        titleInput.value=''; 
        categoryInput.value='';
        descriptionInput.value = '';
        shopSelect.value = "";
        images=[], imagesMeta=[], facades=[], materials=[], colors=[], combinations=[];
        renderImages(); renderFacades(); renderMaterials(); renderColors(); renderCombinations();
        showMessage("–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞. –í—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.");
    };
}

// --- –ö–∞—Ä—É—Å–µ–ª—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π ---
// --- –ö–∞—Ä—É—Å–µ–ª—å ---
addCarouselBtn.onclick = ()=>{ if(carouselImages.length>=5)return showMessage("–ú–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!"); carouselUrlInputArea.classList.remove('hidden'); addCarouselBtn.disabled=true; carouselUrlInput.value=''; carouselUrlInput.focus(); };
carouselUrlOkBtn.onclick = ()=>{ const url=carouselUrlInput.value.trim(); if(!url||!url.startsWith('http'))return showMessage("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL!"); if(carouselImages.length>=5)return showMessage("–ú–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!"); carouselImages.push(url); carouselUrlInputArea.classList.add('hidden'); addCarouselBtn.disabled=false; renderCarouselImages(); };
carouselUrlCancelBtn.onclick = ()=>{ carouselUrlInputArea.classList.add('hidden'); addCarouselBtn.disabled=false; };
const saveCarouselBtn = document.getElementById('save-carousel-btn');

saveCarouselBtn.onclick = async () => {
    if (!db) return showMessage("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");
    
    const url = carouselUrlInput.value.trim();
    if (!url || !url.startsWith('http')) return showMessage("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL!");

    try {
        const carouselRef = collection(db, `artifacts/${appId}/public/data/carousel`);
        await addDoc(carouselRef, { url, createdAt: new Date().toISOString() });
        showMessage("URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∫–∞—Ä—É—Å–µ–ª–∏!");
        // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–∏—Ç—å –≤ –º–∞—Å—Å–∏–≤ –∏ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å
        if (!carouselImages.includes(url)) {
            carouselImages.push(url);
            renderCarouselImages();
        }
        // –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
        carouselUrlInput.value = '';
        carouselUrlInputArea.classList.add('hidden');
        addCarouselBtn.disabled = false;
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏:", e);
        showMessage("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–∞—Ä—É—Å–µ–ª–∏.");
    }
};


// --- RUNTIME INITIATION ---
window.onload = () => {
    initializeFirebase();
    initializeAuth();
    
    // loadShops() —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ initializeAuth()
    
    setupFacadeHandlers();
    setupMaterialHandlers();
    setupColorHandlers();
    setupGeneralHandlers();
    
    // initial empty renders
    renderImages();
    renderFacades();
    renderMaterials();
    renderColors();
    renderCombinations();
};

// --- –õ–û–ì–ò–ö–ê –ë–û–ö–û–í–û–ì–û –ú–ï–ù–Æ ---
const menuToggle = document.getElementById('menu-toggle');
const sideMenu = document.getElementById('side-menu');
const menuOverlay = document.getElementById('menu-overlay');
const sideMenuClose = document.getElementById('side-menu-close');
const sideMenuContent = document.getElementById('side-menu-content');
const sideMenuTitle = document.getElementById('side-menu-title');

// –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è
function openMenu() {
  sideMenu.classList.remove('-translate-x-full');
  menuOverlay.classList.remove('hidden');
  menuToggle.classList.add('active');
}
function closeMenu() {
  sideMenu.classList.add('-translate-x-full');
  menuOverlay.classList.add('hidden');
  menuToggle.classList.remove('active');
}

menuToggle.addEventListener('click', openMenu);
sideMenuClose.addEventListener('click', closeMenu);
menuOverlay.addEventListener('click', closeMenu);

// –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
function renderMainMenu() {
  sideMenuTitle.textContent = '–ú–µ–Ω—é';
  sideMenuContent.innerHTML = `
    <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-orange-100 font-semibold text-gray-700" onclick="showCatalogMenu()">üìÅ –ö–∞—Ç–∞–ª–æ–≥</button>
    <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-orange-100 font-semibold text-gray-700" onclick="showStoresMenu()">üè¨ –ú–∞–≥–∞–∑–∏–Ω—ã</button>
    <button class="w-full text-left py-3 px-4 rounded-lg hover:bg-orange-100 font-semibold text-gray-700" onclick="showDiscountsMenu()">üí∏ –°–∫–∏–¥–∫–∏</button>
  `;
}
renderMainMenu();

// –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
function backButtonHTML() {
  return `<button onclick="renderMainMenu()" class="flex items-center text-gray-600 hover:text-orange-500 mb-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    –ù–∞–∑–∞–¥
  </button>`;
}

// –ö–∞—Ç–∞–ª–æ–≥
function showCatalogMenu() {
  sideMenuTitle.textContent = '–ö–∞—Ç–∞–ª–æ–≥';
  let html = backButtonHTML();
  CATEGORIES.forEach(cat => {
    html += `<button class="block w-full text-left py-2 px-4 rounded-lg hover:bg-orange-100 text-gray-800" 
              onclick="selectCategoryFromMenu('${cat}')">${cat}</button>`;
  });
  sideMenuContent.innerHTML = html;
}
function selectCategoryFromMenu(category) {
  closeMenu();
  setActiveCategory(category);
  window.scrollTo(0, 0);
}

// –ú–∞–≥–∞–∑–∏–Ω—ã
function showStoresMenu() {
  sideMenuTitle.textContent = '–ú–∞–≥–∞–∑–∏–Ω—ã';
  let html = backButtonHTML() + `<p class="text-gray-500 text-sm mb-2">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤...</p>`;
  sideMenuContent.innerHTML = html;

  const storesRef = collection(db, `artifacts/${appId}/public/data/stores`);
  getDocs(storesRef).then(snapshot => {
    let html = backButtonHTML();
    if (snapshot.empty) {
      html += `<p class="text-gray-500 text-center mt-6">–ú–∞–≥–∞–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
    } else {
      snapshot.forEach(doc => {
        const store = doc.data();
        html += `<button class="block w-full text-left py-2 px-4 rounded-lg hover:bg-orange-100 text-gray-800" 
                  onclick="filterByStore('${store.name}')">${store.name}</button>`;
      });
    }
    sideMenuContent.innerHTML = html;
  });
}
function filterByStore(storeName) {
  closeMenu();
  currentCategory = "–í—Å–µ —Ç–æ–≤–∞—Ä—ã";
  searchTerm = "";
  renderCategories();
  const filtered = allOffers.filter(o => o.storeName === storeName);
  offersListDiv.innerHTML = '';
  if (filtered.length === 0) {
    offersListDiv.innerHTML = `<div class='col-span-full text-center text-gray-500 p-8'>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞ ${storeName}.</div>`;
  } else {
    filtered.forEach(offer => offersListDiv.appendChild(createOfferCard(offer)));
  }
}

// –°–∫–∏–¥–∫–∏
function showDiscountsMenu() {
  sideMenuTitle.textContent = '–°–∫–∏–¥–∫–∏';
  let html = backButtonHTML();
  sideMenuContent.innerHTML = html;
  closeMenu();
  const discounted = allOffers.filter(o => o.discount > 0);
  offersListDiv.innerHTML = '';
  if (discounted.length === 0) {
    offersListDiv.innerHTML = `<div class='col-span-full text-center text-gray-500 p-8'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∫–∏–¥–æ–∫.</div>`;
  } else {
    discounted.forEach(offer => offersListDiv.appendChild(createOfferCard(offer)));
  }
}

// –•–µ–ª–ø–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ –≤–µ—Ä—Å—Ç–∫—É)
function createOfferCard(offer) {
  const card = document.createElement('div');
  card.className = 'offer-card flex flex-col cursor-pointer';
  card.onclick = () => showProductDetails(offer.id);
  const activeCombo = offer.combinations?.find(c => c.isActive) || offer.combinations?.[0] || { price: 0 };
  const price = activeCombo.price || 0;
  const finalPrice = price * (1 - (offer.discount || 0) / 100);
  const image = offer.images?.[0] || `https://placehold.co/400x300?text=${encodeURIComponent(offer.title || '')}`;
  const priceHTML = offer.discount > 0
    ? `<p class="text-xl font-extrabold text-red-600">${Math.round(finalPrice)} BYN</p><p class="text-sm text-gray-400 line-through">${Math.round(price)} BYN</p>`
    : `<p class="text-xl font-extrabold text-gray-900">${Math.round(finalPrice)} BYN</p>`;
  card.innerHTML = `
    <div class="h-48 overflow-hidden relative">
      <img src="${image}" class="w-full h-full object-cover" alt="">
      ${offer.discount > 0 ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">- ${offer.discount}%</div>` : ''}
    </div>
    <div class="p-5 flex flex-col flex-grow">
      <p class="text-sm font-semibold text-orange-600 mb-1">${offer.category || '–ü—Ä–æ—á–µ–µ'}</p>
      <h4 class="text-lg font-bold text-gray-900 mb-3 flex-grow">${offer.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h4>
      <div class="flex items-end justify-between mt-auto">
        <div>${priceHTML}</div>
      </div>
    </div>`;
  return card;
}

</script>
</body>
</html>