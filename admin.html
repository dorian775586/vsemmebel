<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–æ–≤–∞—Ä–∞–º–∏</title>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –∏ –æ–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container-card { max-width: 900px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); margin-bottom:2rem; }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover { background-color: #dc2626; }
        .color-box { width: 25px; height: 25px; border: 1px solid #ccc; display: inline-block; margin-right: 5px; vertical-align: middle; border-radius: 4px; }
        .status-success { background-color: #d1fae5; color: #065f46; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .dynamic-field-group { border: 1px dashed #d1d5db; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        /* –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ */
        input:focus, textarea:focus, select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
            outline: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ -->
    <div id="accessDenied" class="hidden container-card mx-auto bg-red-100 text-red-700 p-6 rounded-xl text-center font-bold">
        –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    </div>

    <!-- –ü–∞–Ω–µ–ª—å -->
    <div id="adminPanel" class="container-card mx-auto bg-white p-6 rounded-xl hidden">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å ID –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
        <h1 id="formTitle" class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –°–æ–∑–¥–∞–Ω–∏–µ –¢–æ–≤–∞—Ä–∞</h1>

        <!-- –ï–¥–∏–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
        <form id="offerForm" class="space-y-4">
            
            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
            <input type="hidden" id="offerId" name="offerId" value="">

            <!-- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                <input type="text" id="title" name="title" class="w-full p-2 border rounded-lg" required>
            </div>

            <!-- –¢–∏–ø —Ç–æ–≤–∞—Ä–∞ -->
            <div>
                <label for="itemType" class="block text-sm font-medium text-gray-700 mb-1">–¢–∏–ø —Ç–æ–≤–∞—Ä–∞ (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏)</label>
                <select id="itemType" name="itemType" class="w-full p-2 border rounded-lg">
                    <option value="–ö—É—Ö–Ω—è">–ö—É—Ö–Ω—è</option>
                    <option value="–î–∏–≤–∞–Ω">–î–∏–≤–∞–Ω</option>
                    <option value="–ö—Ä–µ—Å–ª–æ">–ö—Ä–µ—Å–ª–æ</option>
                    <option value="–ú–µ–±–µ–ª—å">–ú–µ–±–µ–ª—å (–¥—Ä—É–≥–æ–µ)</option>
                    <option value="–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
                    <option value="–£—Å–ª—É–≥–∏">–£—Å–ª—É–≥–∏</option>
                    <option value="–í—Å–µ">–ü—Ä–æ—á–µ–µ</option>
                </select>
            </div>
            
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="category" name="category" class="w-full p-2 border rounded-lg">
                    <option value="–í—Å–µ">–í—Å–µ</option>
                    <option value="–ö—É—Ö–Ω–∏">–ö—É—Ö–Ω–∏</option>
                    <option value="–ú—è–≥–∫–∞—è –º–µ–±–µ–ª—å">–ú—è–≥–∫–∞—è –º–µ–±–µ–ª—å</option>
                    <option value="–ö–æ—Ä–ø—É—Å–Ω–∞—è –º–µ–±–µ–ª—å">–ö–æ—Ä–ø—É—Å–Ω–∞—è –º–µ–±–µ–ª—å</option>
                    <option value="–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
                    <option value="–£—Å–ª—É–≥–∏">–£—Å–ª—É–≥–∏</option>
                </select>
            </div>

            <div>
                <label for="discount" class="block text-sm font-medium text-gray-700 mb-1">–°–∫–∏–¥–∫–∞ (%)</label>
                <input type="number" id="discount" name="discount" min="0" max="100" class="w-full p-2 border rounded-lg" value="0">
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" name="description" rows="3" class="w-full p-2 border rounded-lg" required></textarea>
            </div>

            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: –ö–∞—Ä—Ç–∏–Ω–∫–∏ -->
            <div class="dynamic-field-group">
                <label class="block text-sm font-bold text-gray-800 mb-2">–ö–∞—Ä—Ç–∏–Ω–∫–∏ (URL)</label>
                <div id="images-container" class="mb-2 space-y-2"></div>
                <button type="button" id="addImageBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
            </div>
            
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: –§–∞—Å–∞–¥ / –ú–∞—Ç–µ—Ä–∏–∞–ª -->
            <div id="facadeOrMaterialGroup" class="dynamic-field-group">
                <label id="facadeOrMaterialLabel" class="block text-sm font-bold text-gray-800 mb-2">–§–∞—Å–∞–¥—ã</label>
                <div id="facadeOrMaterialContainer" class="mb-2 space-y-2"></div>
                <button type="button" id="addFacadeOrMaterialBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é</button>
            </div>

            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: –¶–≤–µ—Ç–∞ -->
            <div id="colorsGroup" class="dynamic-field-group">
                <label class="block text-sm font-bold text-gray-800 mb-2">–¶–≤–µ—Ç–∞</label>
                <div id="colors-container" class="mb-2 space-y-2"></div>
                <button type="button" id="addColorBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">–î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç</button>
            </div>

            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: –¶–µ–Ω—ã –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–π -->
            <div id="pricesGroup" class="dynamic-field-group">
                <label class="block text-sm font-bold text-gray-800 mb-2">–¶–µ–Ω—ã –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–π (–ú–∞—Ç–µ—Ä–∏–∞–ª/–§–∞—Å–∞–¥ + –¶–≤–µ—Ç)</label>
                <div id="prices-container" class="mb-2 space-y-2"></div>
                <button type="button" id="addPriceBtn" class="btn-primary text-white py-1 px-3 rounded text-sm">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—É –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏</button>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
            <button type="submit" id="save-btn" class="w-full btn-primary text-white font-semibold py-2 rounded-lg shadow-md hover:shadow-lg">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            <p id="statusMessage" class="hidden text-center py-2 rounded-lg font-medium"></p>
        </form>

        <button id="logoutBtn" class="mt-6 w-full bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition">–í—ã–π—Ç–∏</button>

        <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã -->
        <h2 class="text-2xl font-bold mt-8 mb-4 border-t pt-4">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã</h2>
        <div id="offers-list" class="space-y-3">
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>
        </div>
    </div>

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JS-–º–æ–¥—É–ª—å —Å –ª–æ–≥–∏–∫–æ–π Firebase –∏ CRUD -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. FIREBASE SETUP & GLOBAL STATE ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let offersData = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
        
        // UI —ç–ª–µ–º–µ–Ω—Ç—ã
        const offerForm = document.getElementById('offerForm');
        const formTitle = document.getElementById('formTitle');
        const saveBtn = document.getElementById('save-btn');
        const statusMessage = document.getElementById('statusMessage');
        const adminPanel = document.getElementById('adminPanel');
        const accessDenied = document.getElementById('accessDenied');
        const offersList = document.getElementById('offers-list');

        let currentOfferId = null; // null –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, ID –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
        const imagesContainer = document.getElementById('images-container');
        const facadeOrMaterialContainer = document.getElementById('facadeOrMaterialContainer');
        const colorsContainer = document.getElementById('colors-container');
        const pricesContainer = document.getElementById('prices-container');
        const itemTypeSelect = document.getElementById('itemType');
        const facadeOrMaterialLabel = document.getElementById('facadeOrMaterialLabel');

        // --- 2. DYNAMIC FIELD GENERATION LOGIC ---

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–π–±–ª–∞ –§–∞—Å–∞–¥/–ú–∞—Ç–µ—Ä–∏–∞–ª
        itemTypeSelect.addEventListener('change', () => {
            const type = itemTypeSelect.value;
            if (['–î–∏–≤–∞–Ω', '–ö—Ä–µ—Å–ª–æ', '–ú–µ–±–µ–ª—å'].includes(type)) {
                facadeOrMaterialLabel.textContent = '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã';
            } else {
                facadeOrMaterialLabel.textContent = '–§–∞—Å–∞–¥—ã';
            }
            // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–±–æ-—Ü–µ–Ω –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø—Ü–∏–∏ –≤ SELECT
            generatePriceCombinationOptions();
        });

        function createFieldRow(container, name, value = '', type = 'text', placeholder = '', deleteCallback) {
            const uniqueId = `field-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.id = uniqueId;

            let inputHTML = '';

            if (type === 'image') {
                inputHTML = `
                    <input type="url" class="flex-grow p-2 border rounded-lg text-sm" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏" value="${value || ''}" data-field-type="url">
                `;
            } else if (type === 'material') {
                 // value = { name: '–ú–î–§', value: 'mdf' }
                 inputHTML = `
                    <input type="text" class="flex-grow p-2 border rounded-lg text-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–î–§)" value="${value.name || ''}" data-field-type="name">
                    <input type="text" class="p-2 border rounded-lg text-sm w-1/4" placeholder="ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, mdf)" value="${value.value || ''}" data-field-type="value" title="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –æ–ø—Ü–∏–∏">
                `;
            } else if (type === 'color') {
                // value = { name: '–ö—Ä–∞—Å–Ω—ã–π', hex: '#FF0000' }
                inputHTML = `
                    <input type="text" class="flex-grow p-2 border rounded-lg text-sm w-1/3" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞" value="${value.name || ''}" data-field-type="name">
                    <input type="color" class="p-1 border rounded-lg" value="${value.hex || '#ffffff'}" data-field-type="hex" title="–í—ã–±–µ—Ä–∏—Ç–µ HEX —Ü–≤–µ—Ç">
                    <input type="text" class="flex-grow p-2 border rounded-lg text-sm w-1/3" placeholder="HEX (#FF0000)" value="${value.hex || ''}" data-field-type="hex-display" 
                        onchange="this.previousElementSibling.value = this.value; this.previousElementSibling.dispatchEvent(new Event('input'))" 
                        oninput="this.previousElementSibling.value = this.value; this.previousElementSibling.dispatchEvent(new Event('input'))">
                `;
            }

            div.innerHTML = `
                ${inputHTML}
                <button type="button" class="btn-danger text-white py-1 px-2 rounded text-sm" data-id="${uniqueId}">üóëÔ∏è</button>
            `;

            container.appendChild(div);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
            div.querySelector('.btn-danger').addEventListener('click', (e) => {
                container.removeChild(div);
                if (deleteCallback) deleteCallback(); // –î–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–Ω
            });
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è HEX display —Å color picker
            if (type === 'color') {
                const colorPicker = div.querySelector('[data-field-type="hex"]');
                const hexDisplay = div.querySelector('[data-field-type="hex-display"]');

                colorPicker.addEventListener('input', (e) => {
                    hexDisplay.value = e.target.value.toUpperCase();
                    if (deleteCallback) deleteCallback(); 
                });
                hexDisplay.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                         colorPicker.value = e.target.value;
                         if (deleteCallback) deleteCallback(); 
                    }
                });
            }
        }

        // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
        document.getElementById('addImageBtn').addEventListener('click', () => createFieldRow(imagesContainer, 'images', '', 'image'));
        document.getElementById('addFacadeOrMaterialBtn').addEventListener('click', () => createFieldRow(facadeOrMaterialContainer, 'materials', {name: '', value: ''}, 'material', '', generatePriceCombinationOptions));
        document.getElementById('addColorBtn').addEventListener('click', () => createFieldRow(colorsContainer, 'colors', {name: '', hex: '#ffffff'}, 'color', '', generatePriceCombinationOptions));
        document.getElementById('addPriceBtn').addEventListener('click', () => createPriceCombinationRow());


        // --- 3. PRICE COMBINATION LOGIC ---

        function getDynamicFieldData() {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—Ñ–∞—Å–∞–¥—ã
            const materials = Array.from(facadeOrMaterialContainer.querySelectorAll('.flex-grow[data-field-type="value"]')).map(input => ({
                name: input.closest('.flex.items-center.space-x-2').querySelector('[data-field-type="name"]').value,
                value: input.value,
            })).filter(m => m.value && m.name);

            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ü–≤–µ—Ç–∞
            const colors = Array.from(colorsContainer.querySelectorAll('[data-field-type="hex"]')).map(input => ({
                name: input.closest('.flex.items-center.space-x-2').querySelector('[data-field-type="name"]').value,
                hex: input.value.toUpperCase(),
            })).filter(c => c.name && c.hex);

            return { materials, colors };
        }

        function createPriceCombinationRow(priceData = { materialId: '', colorHex: '', price: '' }) {
            const { materials, colors } = getDynamicFieldData();

            if (materials.length === 0 || colors.length === 0) {
                 statusMessage.textContent = '‚ùå –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã/–§–∞—Å–∞–¥—ã –∏ –¶–≤–µ—Ç–∞.';
                 statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                 setTimeout(() => statusMessage.className = 'hidden', 3000);
                 return;
            }

            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded-lg';
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ü–∏–π –¥–ª—è –ú–∞—Ç–µ—Ä–∏–∞–ª–∞/–§–∞—Å–∞–¥–∞
            const materialOptions = materials.map(m => 
                `<option value="${m.value}" ${m.value === priceData.materialId ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ü–∏–π –¥–ª—è –¶–≤–µ—Ç–∞
            const colorOptions = colors.map(c => 
                `<option value="${c.hex}" ${c.hex === priceData.colorHex ? 'selected' : ''}>${c.name} (${c.hex})</option>`
            ).join('');

            div.innerHTML = `
                <select class="p-2 border rounded-lg flex-grow" data-field-type="materialId" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ú–∞—Ç–µ—Ä–∏–∞–ª/–§–∞—Å–∞–¥ --</option>
                    ${materialOptions}
                </select>
                <select class="p-2 border rounded-lg flex-grow" data-field-type="colorHex" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¶–≤–µ—Ç --</option>
                    ${colorOptions}
                </select>
                <input type="number" class="p-2 border rounded-lg w-1/4" placeholder="–¶–µ–Ω–∞, RUB" value="${priceData.price || ''}" data-field-type="price" min="0" required>
                <button type="button" class="btn-danger text-white py-1 px-2 rounded text-sm">üóëÔ∏è</button>
            `;

            div.querySelector('.btn-danger').addEventListener('click', () => {
                pricesContainer.removeChild(div);
            });

            pricesContainer.appendChild(div);
        }

        // –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ select-–æ–ø—Ü–∏–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—è—Ö —Ü–µ–Ω (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤/–¶–≤–µ—Ç–æ–≤)
        function generatePriceCombinationOptions() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö –ø–æ—Å–ª–µ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SELECT'–æ–≤
            const currentPrices = getFormPricesData();
            pricesContainer.innerHTML = '';
            
            currentPrices.forEach(price => createPriceCombinationRow(price));

            if (pricesContainer.children.length === 0) {
                // –ï—Å–ª–∏ —Ü–µ–Ω –Ω–µ –±—ã–ª–æ, –Ω–æ –µ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ü–≤–µ—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –ø—É—Å—Ç—É—é
                const { materials, colors } = getDynamicFieldData();
                if (materials.length > 0 && colors.length > 0) {
                    createPriceCombinationRow();
                }
            }
        }


        // --- 4. DATA EXTRACTION AND LOADING ---

        function getFormPricesData() {
            const priceRows = pricesContainer.querySelectorAll('.flex.items-center.space-x-2');
            const prices = [];
            priceRows.forEach(row => {
                const materialId = row.querySelector('[data-field-type="materialId"]').value;
                const colorHex = row.querySelector('[data-field-type="colorHex"]').value;
                const priceValue = parseFloat(row.querySelector('[data-field-type="price"]').value);
                
                prices.push({
                    materialId: materialId,
                    colorHex: colorHex,
                    price: isNaN(priceValue) ? 0 : priceValue,
                });
            });
            return prices;
        }

        function collectFormData() {
            const formData = {
                title: document.getElementById('title').value,
                itemType: itemTypeSelect.value,
                category: document.getElementById('category').value,
                discount: parseInt(document.getElementById('discount').value) || 0,
                description: document.getElementById('description').value,
            };

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: Images
            formData.images = Array.from(imagesContainer.querySelectorAll('[data-field-type="url"]'))
                                .map(input => ({ url: input.value }))
                                .filter(item => item.url);

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: Materials/Facades
            const materialInputs = facadeOrMaterialContainer.querySelectorAll('.flex.items-center.space-x-2');
            formData.facadesOrMaterials = Array.from(materialInputs).map(row => ({
                name: row.querySelector('[data-field-type="name"]').value,
                value: row.querySelector('[data-field-type="value"]').value,
            })).filter(item => item.name && item.value);

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: Colors
            const colorInputs = colorsContainer.querySelectorAll('.flex.items-center.space-x-2');
            formData.colors = Array.from(colorInputs).map(row => ({
                name: row.querySelector('[data-field-type="name"]').value,
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ color picker, –∫–æ—Ç–æ—Ä–æ–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º HEX
                hex: row.querySelector('[data-field-type="hex"]').value.toUpperCase(), 
            })).filter(item => item.name);

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è: Prices
            formData.prices = getFormPricesData();

            return formData;
        }

        function clearForm() {
            offerForm.reset();
            currentOfferId = null;
            document.getElementById('offerId').value = '';
            imagesContainer.innerHTML = '';
            facadeOrMaterialContainer.innerHTML = '';
            colorsContainer.innerHTML = '';
            pricesContainer.innerHTML = '';
            
            // –°–±—Ä–æ—Å UI
            formTitle.textContent = '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –°–æ–∑–¥–∞–Ω–∏–µ –¢–æ–≤–∞—Ä–∞';
            saveBtn.textContent = '–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
            saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.add('btn-primary');
            statusMessage.className = 'hidden';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É –ø—É—Å—Ç–æ–º—É –ø–æ–ª—é –¥–ª—è –Ω–∞—á–∞–ª–∞
            createFieldRow(imagesContainer, 'images', '', 'image');
            itemTypeSelect.dispatchEvent(new Event('change')); // –û–±–Ω–æ–≤–∏—Ç—å –ª–µ–π–±–ª
        }

        function loadOfferForEdit(offerId, data) {
            clearForm(); // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏—Ç—å
            currentOfferId = offerId;
            document.getElementById('offerId').value = offerId;
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
            document.getElementById('title').value = data.title || '';
            document.getElementById('itemType').value = data.itemType || '–í—Å–µ';
            document.getElementById('category').value = data.category || '–í—Å–µ';
            document.getElementById('discount').value = data.discount || 0;
            document.getElementById('description').value = data.description || '';

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–π–±–ª–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ü–∏–π —Ü–µ–Ω
            itemTypeSelect.dispatchEvent(new Event('change'));

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π: Images
            (data.images || []).forEach(img => createFieldRow(imagesContainer, 'images', img.url, 'image'));

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π: Materials/Facades
            // –ü–µ—Ä–µ–¥–∞–µ–º callback –¥–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–Ω –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –æ–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            const materialsLoaded = (data.facadesOrMaterials || []).map(mat => 
                createFieldRow(facadeOrMaterialContainer, 'materials', mat, 'material', '', generatePriceCombinationOptions)
            );

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π: Colors
            (data.colors || []).forEach(col => createFieldRow(colorsContainer, 'colors', col, 'color', '', generatePriceCombinationOptions));

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π: Prices (–¥–æ–ª–∂–Ω–æ –∏–¥—Ç–∏ –ø–æ—Å–ª–µ Materials –∏ Colors)
            (data.prices || []).forEach(price => createPriceCombinationRow(price));

            // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –¥–æ–±–∞–≤–∏–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            if (imagesContainer.children.length === 0) {
                 createFieldRow(imagesContainer, 'images', '', 'image');
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            formTitle.textContent = `–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–æ–≤–∞—Ä–∞ (ID: ${offerId})`;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- 5. FIREBASE INTERACTION ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config is missing.");
                 accessDenied.classList.remove('hidden');
                 return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        adminPanel.classList.remove('hidden');
                        accessDenied.classList.add('hidden');
                        setupListeners(); // –ó–∞–ø—É—Å–∫ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                        clearForm(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤ —Ä–µ–∂–∏–º–µ —Å–æ–∑–¥–∞–Ω–∏—è
                    } else {
                        userId = null;
                        adminPanel.classList.add('hidden');
                        accessDenied.classList.remove('hidden');
                        console.log("User logged out or not authorized.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                accessDenied.classList.remove('hidden');
            }
        }

        function setupListeners() {
            // 1. –°–ª—É—à–∞—Ç–µ–ª—å —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            const offersColRef = collection(db, `artifacts/${appId}/public/data/offers`);
            onSnapshot(offersColRef, (snapshot) => {
                offersData = [];
                offersList.innerHTML = '';
                if (snapshot.empty) {
                    offersList.innerHTML = '<p class="text-gray-500">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const offerId = doc.id;
                    offersData.push({ id: offerId, ...data });
                    renderOfferItem(offerId, data);
                });
            }, (error) => {
                console.error("Error fetching offers:", error);
                offersList.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ${error.message}</p>`;
            });
        }
        
        function renderOfferItem(offerId, data) {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm';
            item.innerHTML = `
                <span class="font-medium text-gray-700 truncate">${data.title}</span>
                <div>
                    <button type="button" data-id="${offerId}" class="edit-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium mr-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button type="button" data-id="${offerId}" class="delete-btn text-red-600 hover:text-red-800 text-sm font-medium">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            offersList.appendChild(item);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –≤ —Å–ø–∏—Å–∫–µ
        offersList.addEventListener('click', async (e) => {
            const offerId = e.target.dataset.id;
            if (!offerId) return;

            if (e.target.classList.contains('edit-btn')) {
                const offer = offersData.find(o => o.id === offerId);
                if (offer) {
                    loadOfferForEdit(offerId, offer);
                } else {
                    console.error("Offer data not found locally:", offerId);
                }
            } else if (e.target.classList.contains('delete-btn')) {
                // –ó–∞–º–µ–Ω—è–µ–º alert/confirm –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${offersData.find(o => o.id === offerId)?.title || offerId}"?`)) {
                    await deleteOffer(offerId);
                }
            }
        });

        async function deleteOffer(offerId) {
            statusMessage.className = 'status-success text-center py-2 rounded-lg font-medium';
            statusMessage.textContent = '...–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...';
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/offers`, offerId));
                statusMessage.className = 'status-success text-center py-2 rounded-lg font-medium';
                statusMessage.textContent = '‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!';
            } catch (error) {
                console.error("Error deleting offer:", error);
                statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                statusMessage.textContent = `‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`;
            }
            setTimeout(() => statusMessage.className = 'hidden', 3000);
        }

        // --- 6. FORM SUBMISSION ---
        
        offerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = collectFormData();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–∏—á–∏—è –æ–ø—Ü–∏–π (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è)
            if (data.facadesOrMaterials.length === 0 || data.colors.length === 0) {
                 statusMessage.textContent = '‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º—ã —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –§–∞—Å–∞–¥/–ú–∞—Ç–µ—Ä–∏–∞–ª –∏ –æ–¥–∏–Ω –¶–≤–µ—Ç.';
                 statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                 setTimeout(() => statusMessage.className = 'hidden', 4000);
                 return;
            }
            if (data.prices.length === 0) {
                 statusMessage.textContent = '‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¶–µ–Ω–æ–≤—É—é –ö–æ–º–±–∏–Ω–∞—Ü–∏—é.';
                 statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                 setTimeout(() => statusMessage.className = 'hidden', 4000);
                 return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
            statusMessage.className = 'status-success text-center py-2 rounded-lg font-medium';
            statusMessage.textContent = '...–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...';
            
            try {
                if (currentOfferId) {
                    // –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/offers`, currentOfferId), data);
                    statusMessage.textContent = '‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                } else {
                    // –†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø
                    await addDoc(collection(db, `artifacts/${appId}/public/data/offers`), data);
                    statusMessage.textContent = '‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!';
                    clearForm(); // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                }
            } catch (error) {
                console.error("Error saving offer:", error);
                statusMessage.className = 'status-error text-center py-2 rounded-lg font-medium';
                statusMessage.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`;
            }
            
            setTimeout(() => statusMessage.className = 'hidden', 3000);
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("Signed out successfully.");
            }).catch((error) => {
                console.error("Sign out error:", error);
            });
        });

        // --- INITIALIZATION ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
