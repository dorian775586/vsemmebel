<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Мои товары - Mebel.by</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Noto Sans', sans-serif; background:#f7f7f7; }
.section { background:white; padding:1.5rem; border-radius:1rem; margin-bottom:1.5rem; box-shadow:0 6px 15px rgba(0,0,0,0.08); }
.input-field { width: 100%; padding:0.5rem; margin-bottom:0.5rem; border:1px solid #ccc; border-radius:0.5rem; }
.btn { padding:0.5rem 1rem; border:none; border-radius:0.5rem; cursor:pointer; }
.btn-save { background:#3b82f6; color:white; }
.btn-save:hover { background:#2563eb; }
</style>
</head>
<body class="p-4 sm:p-6">

<h1 class="text-3xl font-bold mb-2 text-gray-800" id="shop-title">Мой магазин</h1>

<div id="login-section" class="section max-w-md mx-auto">
<h2 class="text-xl font-semibold mb-4">Вход в магазин</h2>
<input id="shop-email" type="email" placeholder="Email" class="input-field mb-2">
<input id="shop-password" type="password" placeholder="Пароль" class="input-field mb-2">
<button id="login-btn" class="btn btn-save w-full">Войти</button>
<p id="login-message" class="text-sm text-red-600 mt-2"></p>
</div>

<div id="shop-dashboard" class="hidden">
  <div class="section">
    <h2 class="text-2xl font-semibold mb-4">Мои товары</h2>
    <div id="my-products" class="space-y-2"></div>
  </div>

  <div class="section">
    <h2 class="text-2xl font-semibold mb-4">Мои заказы</h2>
    <div id="my-orders" class="space-y-2"></div>
  </div>

  <button id="logout-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400 mt-4">Выйти</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginSection = document.getElementById('login-section');
const dashboard = document.getElementById('shop-dashboard');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginMessage = document.getElementById('login-message');
const shopTitle = document.getElementById('shop-title');

const appId = 'default-app-id';
const productCollectionPath = `artifacts/${appId}/public/data/offers`;

loginSection.classList.remove('hidden');
dashboard.classList.add('hidden');

loginBtn.addEventListener('click', async () => {
  loginMessage.textContent = '';
  const email = document.getElementById('shop-email').value.trim();
  const password = document.getElementById('shop-password').value;
  if(!email || !password){
    loginMessage.textContent = 'Введите email и пароль';
    return;
  }

  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const uid = userCredential.user.uid;

    const shopDoc = await db.collection('shops').doc(uid).get();
    if(!shopDoc.exists){
      loginMessage.textContent = 'Магазин не найден';
      auth.signOut();
      return;
    }

    const shopData = shopDoc.data();
    shopTitle.textContent = shopData.shopName || 'Мой магазин';

    loginSection.classList.add('hidden');
    dashboard.classList.remove('hidden');

    loadProducts(uid);
    loadOrders(uid);

  } catch(err) {
    loginMessage.textContent = err.message;
  }
});

logoutBtn.addEventListener('click', async () => {
  await auth.signOut();
  loginSection.classList.remove('hidden');
  dashboard.classList.add('hidden');
  document.getElementById('shop-email').value = '';
  document.getElementById('shop-password').value = '';
  shopTitle.textContent = 'Мой магазин';
});

async function loadProducts(uid){
  const container = document.getElementById('my-products');
  container.innerHTML = 'Загрузка...';
  const snapshot = await db.collection(productCollectionPath).where('shopId', '==', uid).get();
  if(snapshot.empty){
    container.innerHTML = '<p class="text-gray-500">Нет товаров</p>';
    return;
  }
  container.innerHTML = '';
  snapshot.forEach(doc => {
    const p = doc.data();
    const div = document.createElement('div');
    div.className = 'p-3 border rounded-lg bg-gray-50';
    div.innerHTML = `<strong>${p.title}</strong> — ${p.category || 'Без категории'}`;
    container.appendChild(div);
  });
}

async function loadOrders(uid){
  const container = document.getElementById('my-orders');
  container.innerHTML = 'Загрузка...';
  // ищем заказы, где shopId совпадает с UID магазина
  const snapshot = await db.collection('orders').where('shopId','==',uid).get();
  if(snapshot.empty){
    container.innerHTML = '<p class="text-gray-500">Нет заказов</p>';
    return;
  }
  container.innerHTML = '';
  snapshot.forEach(doc => {
    const o = doc.data();
    const div = document.createElement('div');
    div.className = 'p-3 border rounded-lg bg-gray-50';
    div.innerHTML = `
      <strong>${o.name}</strong> заказал ${o.items.length} товаров <br>
      Сумма: ${o.total} BYN <br>
      Email: ${o.email || '-'} <br>
      Телефон: ${o.phone} <br>
      Адрес: ${o.address} <br>
      Оплата: ${o.payment} <br>
      Статус: ${o.status} <br>
      <details class="mt-2"><summary>Товары</summary>
        <ul class="list-disc ml-5 mt-1">
          ${o.items.map(i => `<li>${i.title} — ${i.price} BYN × ${i.quantity || 1}</li>`).join('')}
        </ul>
      </details>
    `;
    container.appendChild(div);
  });
}
</script>
</body>
</html>
