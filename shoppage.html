<!DOCTYPE html> 
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Мои товары — Mebel.by</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter', sans-serif; background:#f5f5f5; }
.section { background:white; padding:1.5rem; border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
.btn { padding:0.5rem 1rem; border:none; border-radius:0.5rem; cursor:pointer; font-weight:600; transition:0.2s; color:white; }
.status-new { background:#6b7280; }
.status-processing { background:#3b82f6; }
.status-shipping { background:#facc15; color:black; }
.status-done { background:#22c55e; }
.status-cancel { background:#dc2626; }
.btn:hover { opacity:0.9; }

/* Цветовые фоны карточек заказов */
.bg-new { background-color: #f3f4f6; }
.bg-processing { background-color: #dbeafe; }
.bg-shipping { background-color: #fef9c3; }
.bg-done { background-color: #dcfce7; }
.bg-cancel { background-color: #fee2e2; }

/* Toast уведомления */
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}
.toast {
  background: #16a34a;
  color: white;
  padding: 12px 18px;
  margin-top: 10px;
  border-radius: 8px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.4s ease;
}
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body class="p-4 sm:p-6">

<!-- === TOAST === -->
<div id="toast-container"></div>

<h1 class="text-3xl font-bold mb-4 text-gray-800" id="shop-title">Мой магазин</h1>

<!-- === LOGIN === -->
<div id="login-section" class="section max-w-md mx-auto mt-6">
  <h2 class="text-xl font-semibold mb-4">Вход в магазин</h2>
  <input id="shop-email" type="email" placeholder="Email" class="w-full border p-2 rounded mb-3">
  <input id="shop-password" type="password" placeholder="Пароль" class="w-full border p-2 rounded mb-3">
  <button id="login-btn" class="btn bg-blue-600 text-white w-full">Войти</button>
  <p id="login-message" class="text-sm text-red-600 mt-2"></p>
</div>

<!-- === DASHBOARD === -->
<div id="shop-dashboard" class="hidden">

  <div class="section mb-6">
    <h2 class="text-2xl font-semibold mb-4">Мои товары</h2>
    <div id="my-products" class="space-y-3"></div>
  </div>

  <div class="section mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold">Мои заказы</h2>
      <select id="status-filter" class="border rounded-lg p-2">
        <option value="all">Все</option>
        <option value="Новый">Новый</option>
        <option value="В обработке">В обработке</option>
        <option value="В пути">В пути</option>
        <option value="Выполнено">Выполнено</option>
        <option value="Отменён">Отменён</option>
      </select>
    </div>
    <div id="my-orders" class="space-y-4"></div>
  </div>

  <button id="logout-btn" class="btn bg-gray-300 text-gray-700 hover:bg-gray-400">Выйти</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginSection = document.getElementById('login-section');
const dashboard = document.getElementById('shop-dashboard');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginMessage = document.getElementById('login-message');
const shopTitle = document.getElementById('shop-title');
const filterSelect = document.getElementById('status-filter');
const appId = 'default-app-id';

// === Вход в систему ===
loginBtn.addEventListener('click', async () => {
  loginMessage.textContent = '';
  const email = document.getElementById('shop-email').value.trim();
  const password = document.getElementById('shop-password').value.trim();
  if(!email || !password){
    loginMessage.textContent = 'Введите email и пароль';
    return;
  }

  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const uid = userCredential.user.uid;

    const shopDoc = await db.collection('artifacts').doc(appId)
                            .collection('public').doc('data')
                            .collection('shops').doc(uid).get();

    if(!shopDoc.exists){
      loginMessage.textContent = 'Магазин не найден';
      await auth.signOut();
      return;
    }

    const shopData = shopDoc.data();
    shopTitle.textContent = shopData.shopName || 'Мой магазин';

    loginSection.classList.add('hidden');
    dashboard.classList.remove('hidden');

    loadProducts(uid);
    loadOrders(uid);

    filterSelect.addEventListener('change', () => loadOrders(uid, filterSelect.value));

  } catch(err) {
    loginMessage.textContent = err.message;
  }
});

logoutBtn.addEventListener('click', async () => {
  await auth.signOut();
  loginSection.classList.remove('hidden');
  dashboard.classList.add('hidden');
  document.getElementById('shop-email').value = '';
  document.getElementById('shop-password').value = '';
  shopTitle.textContent = 'Мой магазин';
});

// === Загрузка товаров ===
async function loadProducts(uid){
  const container = document.getElementById('my-products');
  container.innerHTML = 'Загрузка...';

  const snapshot = await db.collection('artifacts').doc(appId)
                           .collection('public').doc('data')
                           .collection('offers')
                           .where('shopId', '==', uid)
                           .get();

  if(snapshot.empty){
    container.innerHTML = '<p class="text-gray-500">Нет товаров</p>';
    return;
  }

  container.innerHTML = '';
  snapshot.forEach(doc => {
    const p = doc.data();
    const div = document.createElement('div');
    div.className = 'p-3 border rounded-lg bg-gray-50';
    div.innerHTML = `<strong>${p.title}</strong> — ${p.category || 'Без категории'}`;
    container.appendChild(div);
  });
}

// === Загрузка заказов ===
async function loadOrders(uid, statusFilter = 'all'){
  const container = document.getElementById('my-orders');
  container.innerHTML = 'Загрузка...';

  let query = db.collection('orders').where('shopId','==',uid);
  if(statusFilter !== 'all') query = query.where('status', '==', statusFilter);
  const snapshot = await query.get();

  if(snapshot.empty){
    container.innerHTML = '<p class="text-gray-500">Нет заказов</p>';
    return;
  }

  container.innerHTML = '';
  snapshot.forEach(doc => {
    const o = doc.data();
    const orderId = doc.id;
    const date = new Date(o.date).toLocaleString('ru-RU');
    const colorClass = o.status === 'В обработке' ? 'status-processing' :
                       o.status === 'В пути' ? 'status-shipping' :
                       o.status === 'Выполнено' ? 'status-done' :
                       o.status === 'Отменён' ? 'status-cancel' : 'status-new';
    const bgClass = o.status === 'В обработке' ? 'bg-processing' :
                    o.status === 'В пути' ? 'bg-shipping' :
                    o.status === 'Выполнено' ? 'bg-done' :
                    o.status === 'Отменён' ? 'bg-cancel' : 'bg-new';

    const orderNum = o.orderNumber ? `#${o.orderNumber}` : `ID: ${orderId}`;

    const div = document.createElement('div');
    div.className = `p-4 border rounded-xl shadow-sm ${bgClass}`;
    div.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold text-lg">Заказ ${orderNum} от ${o.name}</h3>
        <span class="px-3 py-1 rounded-full text-sm ${colorClass}">${o.status}</span>
      </div>
      <p><strong>Телефон:</strong> ${o.phone}</p>
      <p><strong>Email:</strong> ${o.email || '-'}</p>
      <p><strong>Адрес:</strong> ${o.address}</p>
      <p><strong>Дата:</strong> ${date}</p>
      <p><strong>Оплата:</strong> ${o.payment}</p>
      <p><strong>Сумма:</strong> <span class="text-orange-600 font-bold">${o.total} BYN</span></p>
      <details class="mt-2">
        <summary class="cursor-pointer text-blue-600 hover:underline">Показать товары</summary>
        <ul class="list-disc ml-6 mt-1 space-y-1">
          ${o.items.map(i => `
            <li>
              <strong>${i.title}</strong> — ${i.price} BYN<br>
              ${i.material || ''} ${i.color || ''}<br>
              <img src="${i.image}" class="w-24 h-16 object-cover rounded mt-1">
            </li>
          `).join('')}
        </ul>
      </details>

      <div class="flex gap-2 mt-4 flex-wrap">
        <button class="btn status-processing" onclick="updateStatus('${orderId}','В обработке')">В обработке</button>
        <button class="btn status-shipping" onclick="updateStatus('${orderId}','В пути')">В пути</button>
        <button class="btn status-done" onclick="updateStatus('${orderId}','Выполнено')">Выполнено</button>
        <button class="btn status-cancel" onclick="updateStatus('${orderId}','Отменён')">Отмена</button>
      </div>
    `;
    container.appendChild(div);
  });
}

// === Изменение статуса ===
async function updateStatus(orderId, newStatus){
  await db.collection('orders').doc(orderId).update({ status: newStatus });
  showToast(`Статус обновлён на "${newStatus}"`);
  loadOrders(auth.currentUser.uid, filterSelect.value);
}

// === Toast уведомление ===
function showToast(message){
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 50);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}
</script>
</body>
</html>