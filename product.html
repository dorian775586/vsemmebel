<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Страница товара</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; min-height: 100vh; transition: background 0.3s; }
.header-bg { background-color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
.orange-accent { background-color: #f97316; color:white; font-weight:700; transition:0.3s; }
.orange-accent:hover:not(:disabled) { background-color: #ea580c; }
.orange-accent:disabled { background-color: #fca5a5; cursor: not-allowed; } 
.option-button-style { 
    border:2px solid #f97316; 
    background:#ffedd5; 
    color:#f97316; 
    font-weight:600; 
    transition:0.3s; 
    padding: 0.5rem 1rem; 
    border-radius: 0.5rem; 
    cursor:pointer; 
    min-width: 80px; 
    text-align: center;
    box-shadow: 0 0 0 rgba(249,115,22,0);
}
.option-button-style:hover { box-shadow: 0 4px 8px rgba(249,115,22,0.3); }
.option-button-style.active { background:#f97316; color:white; box-shadow:0 4px 12px rgba(249,115,22,0.4); border-color: #f97316;}
.thumbnail { width:60px; height:60px; border:2px solid transparent; cursor:pointer; border-radius:0.5rem; transition:0.2s; object-fit: cover;}
.thumbnail:hover { transform: scale(1.05); box-shadow:0 2px 5px rgba(249,115,22,0.3);}
.thumbnail.active { border-color:#f97316; box-shadow:0 4px 12px rgba(249,115,22,0.4);}
#main-product-image { transition: opacity 0.3s ease-in-out; }
#message-box { position: fixed; top: 20px; right: 20px; z-index: 1000; min-width: 300px; padding: 1rem; background-color: #10b981; color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(-10px); }
#message-box.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body class="pb-20">

<header class="sticky top-0 header-bg z-20">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <a href="/" class="text-3xl font-black text-gray-900 tracking-tight">Mebel.by</a>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 mt-6">
  <div class="mb-6 text-sm text-gray-500">
    <a href="/" class="hover:text-orange-500 transition">Главная</a>
    <span class="mx-2">/</span>
    <a href="#" class="hover:text-orange-500 transition" id="breadcrumb-category">Категория</a>
    <span class="mx-2">/</span>
    <span class="text-gray-900 font-medium" id="breadcrumb-title">Товар</span>
  </div>

  <div class="lg:grid lg:grid-cols-2 lg:gap-10">
    <div class="mb-8 lg:mb-0">
      <div id="thumbnail-gallery" class="flex gap-3 mb-3"></div>
      <img id="main-product-image" src="https://placehold.co/800x600?text=Нет+изображения" class="w-full h-auto rounded-3xl object-cover" style="max-height: 600px;">
    </div>

    <div class="p-6 bg-white rounded-3xl shadow-2xl sticky top-20 h-fit">
      <h1 class="text-4xl font-black text-gray-900 mb-2" id="product-title">Товар</h1>
      <p class="text-lg font-medium text-orange-600 uppercase mb-4" id="product-category">Категория</p>

      <div class="mb-5 flex items-end">
        <span id="old-price" class="line-through text-xl text-gray-400 mr-3 transition duration-300 ease-in-out">0 BYN</span>
        <span id="new-price" class="text-4xl font-black text-orange-600 transition duration-300 ease-in-out">0 BYN</span>
      </div>

      <p class="text-gray-600 mb-6" id="product-description">Загрузка описания...</p>

      <div class="mb-5" id="facade-section">
        <p class="font-bold text-gray-800 mb-3">Фасад:</p>
        <div class="flex flex-wrap gap-3" id="facade-options"></div>
      </div>

      <div class="mb-5" id="material-section">
        <p class="font-bold text-gray-800 mb-3">Материал:</p>
        <div class="flex flex-wrap gap-3" id="material-options"></div>
      </div>

      <div class="mb-8" id="color-section">
        <p class="font-bold text-gray-800 mb-3">Цвет/Текстура:</p>
        <div class="flex flex-wrap gap-3" id="color-options"></div>
      </div>

      <div class="flex flex-col space-y-4">
        <button id="buy-button" class="orange-accent text-white font-black text-lg py-4 rounded-xl uppercase">Купить</button>
      </div>

      <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm hidden" id="error-message">
        <p>Эта комбинация опций недоступна.</p>
      </div>
    </div>
  </div>
</main>

<div id="message-box" role="alert"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, getDoc, collection, query, getDocs, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

let productData = null;
let selectedFacade = null;
let selectedMaterial = null;
let selectedColor = null;

const urlParams = new URLSearchParams(window.location.search);
let productId = urlParams.get('id');

const HARDCODED_FIREBASE_CONFIG = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let firebaseConfig = {};
try {
  const parsedConfig = JSON.parse(firebaseConfigString);
  firebaseConfig = parsedConfig?.projectId ? parsedConfig : HARDCODED_FIREBASE_CONFIG;
} catch {
  firebaseConfig = HARDCODED_FIREBASE_CONFIG;
}

const COLLECTION_PATH = `/artifacts/${appId}/public/data/offers`;
let app, db, auth, isAuthReady = false;

async function initializeAuthAndFirestore() {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
  setLogLevel('Debug');
  try {
    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
    else await signInAnonymously(auth);
    isAuthReady = true;
    if (!productId) findFirstAvailableProduct();
    else loadProduct(productId);
  } catch {
    showMessage("Ошибка авторизации. Данные могут быть недоступны.", true);
  }
}

async function findFirstAvailableProduct() {
  if (!isAuthReady) return;
  const q = query(collection(db, COLLECTION_PATH), limit(1));
  const querySnapshot = await getDocs(q);
  if (!querySnapshot.empty) {
    const firstDoc = querySnapshot.docs[0];
    productId = firstDoc.id;
    window.history.pushState({}, '', `?id=${productId}`);
    loadProduct(productId);
  } else showMessage(`Ошибка: коллекция '${COLLECTION_PATH}' пуста.`, true);
}

async function loadProduct(id) {
  if (!isAuthReady) return;
  const docRef = doc(db, COLLECTION_PATH, id);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) {
    productData = docSnap.data();
    showMessage(`Товар "${productData.title || 'загружен'}" успешно загружен.`, false);
    initializeProductView(productData);
  } else findFirstAvailableProduct();
}

function renderGallery(images) {
  const gallery = document.getElementById("thumbnail-gallery");
  gallery.innerHTML = "";
  images.forEach((img, i) => {
    const thumb = document.createElement("img");
    thumb.src = img;
    thumb.className = "thumbnail" + (i === 0 ? " active" : "");
    thumb.onerror = () => thumb.src = "https://placehold.co/60x60?text=IMG";
    thumb.onclick = () => {
      const mainImage = document.getElementById("main-product-image");
      mainImage.style.opacity = 0;
      setTimeout(() => { mainImage.src = img; mainImage.style.opacity = 1; }, 200);
      gallery.querySelectorAll("img").forEach(t => t.classList.remove("active"));
      thumb.classList.add("active");
    };
    gallery.appendChild(thumb);
  });
  const mainImage = document.getElementById("main-product-image");
  mainImage.src = images[0] || "https://placehold.co/800x600?text=Нет+изображения";
}

function activateOption(containerId, value) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.querySelectorAll("button").forEach(b => {
    b.classList.remove("active");
    if (b.textContent.trim() === value?.trim()) b.classList.add("active");
  });
}

function renderOptions(containerId, options, clickHandler) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  (options || []).forEach(o => {
    const btn = document.createElement("button");
    btn.textContent = o;
    btn.className = "option-button-style";
    btn.onclick = () => {
      clickHandler(o);
      container.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    };
    container.appendChild(btn);
  });
}

function renderColorOptions(containerId, colors, clickHandler) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  (colors || []).forEach(c => {
    const btn = document.createElement("button");
    btn.textContent = c.name;
    btn.className = "option-button-style";
    btn.style.background = "white";
    btn.style.color = "#f97316";
    btn.style.borderColor = "#f97316";
    btn.onmouseenter = () => btn.style.background = "#fff7ed";
    btn.onmouseleave = () => { if (!btn.classList.contains("active")) btn.style.background = "white"; };
    btn.onclick = () => {
      clickHandler(c.name);
      container.querySelectorAll("button").forEach(b => { b.classList.remove("active"); b.style.background = "white"; });
      btn.classList.add("active");
      btn.style.background = "#f97316";
      btn.style.color = "white";
    };
    container.appendChild(btn);
  });
}

function findCombination(autoCorrect = true) {
  if (!productData || !productData.combinations) return null;
  let combo = productData.combinations.find(c =>
    c.material === selectedMaterial &&
    c.facade === selectedFacade &&
    c.color === selectedColor
  );
  if (combo) return combo;

  if (!autoCorrect) return null;
  combo = productData.combinations.find(c =>
    c.color === selectedColor || c.facade === selectedFacade || c.material === selectedMaterial
  );

  if (combo) {
    selectedMaterial = combo.material;
    selectedFacade = combo.facade;
    selectedColor = combo.color;
    activateOption("material-options", selectedMaterial);
    activateOption("facade-options", selectedFacade);
    activateOption("color-options", selectedColor);
  }
  return combo || null;
}

function initializeProductView(data) {
  document.getElementById("product-title").textContent = data.title || "Без названия";
  document.getElementById("breadcrumb-title").textContent = data.title || "Без названия";
  document.getElementById("breadcrumb-category").textContent = data.category || "-";
  document.getElementById("product-description").textContent = data.description || "Подробное описание товара отсутствует.";

  renderGallery(data.images || [data.image].filter(Boolean));
  renderOptions("facade-options", data.facades, v => { selectedFacade = v; updateProductView(); });
  renderOptions("material-options", data.materials, v => { selectedMaterial = v; updateProductView(); });
  renderColorOptions("color-options", data.colors, v => { selectedColor = v; updateProductView(); });

  const combo = data.combinations?.[0];
  selectedMaterial = combo?.material || data.materials?.[0] || null;
  selectedFacade = combo?.facade || data.facades?.[0] || null;
  selectedColor = combo?.color || data.colors?.[0]?.name || null;

  activateOption("material-options", selectedMaterial);
  activateOption("facade-options", selectedFacade);
  activateOption("color-options", selectedColor);
  updateProductView();
}

function updateProductView() {
  if (!productData) return;
  const combo = findCombination(true);
  const buyButton = document.getElementById("buy-button");
  const errorMessage = document.getElementById("error-message");

  let basePrice = combo?.price || productData.price || 0;
  const discount = productData.discount || 0;
  const comboImage = combo?.colorImage || null;

  const isCombinationAvailable = !!combo;
  errorMessage.classList.toggle("hidden", isCombinationAvailable);

  const oldPriceEl = document.getElementById("old-price");
  const newPriceEl = document.getElementById("new-price");
  oldPriceEl.textContent = formatPrice(basePrice);
  newPriceEl.textContent = formatPrice(Math.round(basePrice * (1 - discount / 100)));
  oldPriceEl.style.display = discount > 0 ? "inline" : "none";

  const mainImage = document.getElementById("main-product-image");
  mainImage.style.opacity = 0;
  setTimeout(() => {
    mainImage.src = comboImage || productData.images?.[0] || "https://placehold.co/800x600?text=Нет+изображения";
    mainImage.style.opacity = 1;
  }, 150);

  buyButton.disabled = !isCombinationAvailable;
  buyButton.textContent = isCombinationAvailable ? "Купить" : "Комбинация недоступна";
}

function formatPrice(price) {
  return isNaN(price) ? "N/A" : price.toLocaleString("ru-RU", { style: "currency", currency: "BYN", maximumFractionDigits: 0 });
}

document.getElementById("buy-button").onclick = () => {
  if (document.getElementById("buy-button").disabled) return;
  const comboText = `Материал: ${selectedMaterial||'-'}, Фасад: ${selectedFacade||'-'}, Цвет: ${selectedColor||'-'}`;
  const priceText = document.getElementById("new-price").textContent;
  showMessage(`✅ Вы оформили заказ:<br><strong>${productData.title}</strong><br>Опции: ${comboText}<br>Итоговая цена: ${priceText}`, false);
};

function showMessage(text, isError) {
  const msgBox = document.getElementById("message-box");
  msgBox.innerHTML = text;
  msgBox.className = "show";
  msgBox.style.backgroundColor = isError ? "#ef4444" : "#10b981";
  setTimeout(() => msgBox.classList.remove("show"), 5000);
}

window.onload = initializeAuthAndFirestore;
</script>
</body>
</html>
