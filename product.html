<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; min-height: 100vh; transition: background 0.3s; }
.header-bg { background-color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
.orange-accent { background-color: #f97316; color:white; font-weight:700; transition:0.3s; }
.orange-accent:hover:not(:disabled) { background-color: #ea580c; }
.orange-accent:disabled { background-color: #fca5a5; cursor: not-allowed; } 

.option-button-style { 
    border:2px solid #f97316; 
    background:#ffedd5; 
    color:#f97316; 
    font-weight:600; 
    transition:0.2s; 
    padding: 0.5rem 1rem; 
    border-radius: 0.5rem; 
    cursor:pointer; 
    min-width: 80px; 
    text-align: center;
}
.option-button-style:hover { 
    background:#f97316; 
    color:#fff; 
}
.option-button-style.active { 
    background:#fff; 
    color:#f97316; 
    border:3px solid #f97316; 
    box-shadow:0 0 0 3px rgba(249,115,22,0.4);
}

.thumbnail { width:60px; height:60px; border:2px solid transparent; cursor:pointer; border-radius:0.5rem; transition:0.2s; object-fit: cover; }
.thumbnail:hover { transform: scale(1.05); box-shadow:0 2px 5px rgba(249,115,22,0.3); } 
.thumbnail.active { border-color:#f97316; box-shadow:0 4px 12px rgba(249,115,22,0.4); } 

#main-product-image { transition: opacity 0.3s ease-in-out; } 
#message-box { position: fixed; top: 20px; right: 20px; z-index: 1000; min-width: 300px; padding: 1rem; background-color: #10b981; color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(-10px); } 
#message-box.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body class="pb-20">

<header class="sticky top-0 header-bg z-20">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <a href="/" class="text-3xl font-black text-gray-900 tracking-tight">
      Mebel.by
    </a>

    <!-- –ö–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ –∫–æ—Ä–∑–∏–Ω—ã -->
    <div class="flex items-center gap-6 text-2xl">
      <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
      <a href="favorites.html" 
         class="text-gray-700 hover:text-orange-500 transition" 
         title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
        ‚ù§Ô∏è
      </a>

      <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
      <a href="order.html" 
         class="text-gray-700 hover:text-orange-500 transition" 
         title="–ö–æ—Ä–∑–∏–Ω–∞">
        üõçÔ∏è
      </a>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 mt-6">
  <div class="mb-6 text-sm text-gray-500">
    <a href="/" class="hover:text-orange-500 transition">–ì–ª–∞–≤–Ω–∞—è</a>
    <span class="mx-2">/</span>
    <a href="#" class="hover:text-orange-500 transition" id="breadcrumb-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</a>
    <span class="mx-2">/</span>
    <span class="text-gray-900 font-medium" id="breadcrumb-title">–¢–æ–≤–∞—Ä</span>
  </div>

  <div class="lg:grid lg:grid-cols-2 lg:gap-10">
    <div class="mb-8 lg:mb-0">
      <div id="thumbnail-gallery" class="flex gap-3 mb-3"></div>
      <img id="main-product-image" src="https://placehold.co/800x600?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" class="w-full h-auto rounded-3xl object-cover" style="max-height: 600px;">
    </div>

    <div class="p-6 bg-white rounded-3xl shadow-2xl sticky top-20 h-fit">
      <h1 class="text-4xl font-black text-gray-900 mb-2" id="product-title">–¢–æ–≤–∞—Ä</h1>
      <p class="text-lg font-medium text-orange-600 uppercase mb-4" id="product-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>

      <div class="mb-5 flex items-end">
        <span id="old-price" class="line-through text-xl text-gray-400 mr-3 transition duration-300 ease-in-out">0 BYN</span>
        <span id="new-price" class="text-4xl font-black text-orange-600 transition duration-300 ease-in-out">0 BYN</span>
      </div>

      <p class="text-gray-600 mb-6" id="product-description">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è...</p>

      <div class="mb-5 hidden" id="facade-section">
        <p class="font-bold text-gray-800 mb-3">–§–∞—Å–∞–¥:</p>
        <div class="flex flex-wrap gap-3" id="facade-options"></div>
      </div>

      <div class="mb-5 hidden" id="material-section">
        <p class="font-bold text-gray-800 mb-3">–ú–∞—Ç–µ—Ä–∏–∞–ª:</p>
        <div class="flex flex-wrap gap-3" id="material-options"></div>
      </div>

      <div class="mb-8 hidden" id="color-section">
        <p class="font-bold text-gray-800 mb-3">–¶–≤–µ—Ç/–¢–µ–∫—Å—Ç—É—Ä–∞:</p>
        <div class="flex flex-wrap gap-3" id="color-options"></div>
      </div>

      <div class="flex flex-col space-y-4">
        <button id="buy-button" class="orange-accent text-white font-black text-lg py-4 rounded-xl uppercase">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        <button id="favorite-button" class="border-2 border-orange-500 text-orange-500 font-bold text-lg py-3 rounded-xl uppercase hover:bg-orange-50 transition">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚ù§Ô∏è</button>
      </div>

      <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm hidden" id="error-message">
        <p>–≠—Ç–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –æ–ø—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</p>
      </div>
    </div>
  </div>
</main>

<div id="message-box" role="alert"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, getDoc, collection, query, getDocs, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

let productData = null;
let selectedFacade = null;
let selectedMaterial = null;
let selectedColor = null;

const urlParams = new URLSearchParams(window.location.search);
let productId = urlParams.get('id');

const HARDCODED_FIREBASE_CONFIG = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let firebaseConfig = {};
try {
  const parsedConfig = JSON.parse(firebaseConfigString);
  firebaseConfig = parsedConfig?.projectId ? parsedConfig : HARDCODED_FIREBASE_CONFIG;
} catch {
  firebaseConfig = HARDCODED_FIREBASE_CONFIG;
}

const COLLECTION_PATH = `/artifacts/${appId}/public/data/offers`;
let app, db, auth, isAuthReady = false;

// ==========================
// Firebase –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
// ==========================
async function initializeAuthAndFirestore() {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
  setLogLevel('Debug');
  try {
    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
    else await signInAnonymously(auth);
    isAuthReady = true;
    if (!productId) findFirstAvailableProduct();
    else loadProduct(productId);
  } catch {
    showMessage("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.", true);
  }
}

async function findFirstAvailableProduct() {
  if (!isAuthReady) return;
  const q = query(collection(db, COLLECTION_PATH), limit(1));
  const querySnapshot = await getDocs(q);
  if (!querySnapshot.empty) {
    const firstDoc = querySnapshot.docs[0];
    productId = firstDoc.id;
    window.history.pushState({}, '', `?id=${productId}`);
    loadProduct(productId);
  } else showMessage(`–û—à–∏–±–∫–∞: –∫–æ–ª–ª–µ–∫—Ü–∏—è '${COLLECTION_PATH}' –ø—É—Å—Ç–∞.`, true);
}

async function loadProduct(id) {
  if (!isAuthReady) return;
  const docRef = doc(db, COLLECTION_PATH, id);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) {
    productData = docSnap.data();
    if (productData.combinations && productData.image_color_map) {
      productData.combinations.forEach(combo => {
        const colorName = combo.color;
        const imageObj = productData.image_color_map.find(m => m.color === colorName);
        combo.colorImage = imageObj?.url || null;
      });
    }
    initializeProductView(productData);
  } else {
    findFirstAvailableProduct();
  }
}

// ==========================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
// ==========================
function renderGallery(images) {
  const gallery = document.getElementById("thumbnail-gallery");
  gallery.innerHTML = "";
  images.forEach((img, i) => {
    const thumb = document.createElement("img");
    thumb.src = img;
    thumb.className = "thumbnail" + (i === 0 ? " active" : "");
    thumb.onerror = () => thumb.src = "https://placehold.co/60x60?text=IMG";
    thumb.onclick = () => {
      const mainImage = document.getElementById("main-product-image");
      mainImage.style.opacity = 0;
      setTimeout(() => { mainImage.src = img; mainImage.style.opacity = 1; }, 200);
      gallery.querySelectorAll("img").forEach(t => t.classList.remove("active"));
      thumb.classList.add("active");
    };
    gallery.appendChild(thumb);
  });
  const mainImage = document.getElementById("main-product-image");
  mainImage.src = images[0] || "https://placehold.co/800x600?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
}

function renderOptions(containerId, options, clickHandler) {
  const container = document.getElementById(containerId);
  if (!options || options.length === 0) {
    container.parentElement.classList.add("hidden");
    return;
  }
  container.parentElement.classList.remove("hidden");
  container.innerHTML = "";
  options.forEach(o => {
    const btn = document.createElement("button");
    btn.textContent = o;
    btn.dataset.value = o;
    btn.className = "option-button-style";
    btn.onclick = () => {
      clickHandler(o);
      updateProductView();
      saveSelectedOptions();
    };
    container.appendChild(btn);
  });
}

function renderColorOptions(containerId, colors, clickHandler) {
  const container = document.getElementById(containerId);
  if (!colors || colors.length === 0) {
    container.parentElement.classList.add("hidden");
    return;
  }
  container.parentElement.classList.remove("hidden");
  container.innerHTML = "";
  colors.forEach(c => {
    const btn = document.createElement("button");
    btn.textContent = c.name;
    btn.dataset.value = c.name;
    btn.className = "option-button-style";
    btn.style.background = c.hex;
    btn.style.color = getTextColorForBackground(c.hex);
    btn.style.borderColor = c.hex;
    btn.onclick = () => {
      clickHandler(c.name);
      updateProductView();
      saveSelectedOptions();
    };
    container.appendChild(btn);
  });
}

function getTextColorForBackground(bgColor) {
  if (!bgColor) return "#f97316";
  const c = bgColor.charAt(0) === '#' ? bgColor.substring(1,7) : bgColor;
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  const brightness = (r*299 + g*587 + b*114)/1000;
  return brightness > 150 ? "#000" : "#fff";
}

function findCombination() {
  if (!productData || !productData.combinations) return null;
  let combo = productData.combinations.find(c =>
    c.material === selectedMaterial &&
    c.facade === selectedFacade &&
    c.color === selectedColor
  );
  if (combo) return combo;
  combo = productData.combinations.find(c => true);
  selectedMaterial = combo.material;
  selectedFacade = combo.facade;
  selectedColor = combo.color;
  return combo;
}

// ==========================
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
// ==========================
function initializeProductView(data) {
  document.getElementById("product-title").textContent = data.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
  document.getElementById("breadcrumb-title").textContent = data.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
  document.getElementById("breadcrumb-category").textContent = data.category || "-";
  document.getElementById("product-category").textContent = data.category || "-";
  document.getElementById("product-description").textContent = data.description || "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.";

  renderGallery(data.images || [data.image].filter(Boolean));
  renderOptions("facade-options", data.facades, v => selectedFacade = v);
  renderOptions("material-options", data.materials, v => selectedMaterial = v);
  renderColorOptions("color-options", data.colors, v => selectedColor = v);

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π –∏–∑ localStorage
  const savedOptions = JSON.parse(localStorage.getItem(`selected-options-${productId}`) || '{}');
  selectedFacade = savedOptions.facade || data.combinations?.[0]?.facade || data.facades?.[0];
  selectedMaterial = savedOptions.material || data.combinations?.[0]?.material || data.materials?.[0];
  selectedColor = savedOptions.color || data.combinations?.[0]?.color || data.colors?.[0]?.name;

  updateProductView();
}

// ==========================
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
// ==========================
function updateProductView() {
  if (!productData) return;

  const combo = findCombination();
  if (!combo) return;

  updateOptionButtons("material-options", selectedMaterial);
  updateOptionButtons("facade-options", selectedFacade);
  updateOptionButtons("color-options", selectedColor);

  const buyButton = document.getElementById("buy-button");
  const errorMessage = document.getElementById("error-message");

  errorMessage.classList.add("hidden");

  const basePrice = combo.price || 0;
  const discount = combo.discount || 0;
  const oldPriceEl = document.getElementById("old-price");
  const newPriceEl = document.getElementById("new-price");
  oldPriceEl.textContent = formatPrice(basePrice);
  newPriceEl.textContent = formatPrice(Math.round(basePrice * (1 - discount / 100)));
  oldPriceEl.style.display = discount > 0 ? "inline" : "none";

  const mainImage = document.getElementById("main-product-image");
  mainImage.style.opacity = 0;
  setTimeout(() => {
      mainImage.src = combo.colorImage || productData.images?.[0] || "https://placehold.co/800x600?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
      mainImage.style.opacity = 1;
  }, 150);

  buyButton.disabled = false;
  buyButton.textContent = "–í –∫–æ—Ä–∑–∏–Ω—É";
}

function updateOptionButtons(containerId, value) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.querySelectorAll("button").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.value === value);
  });
}

function formatPrice(price){return isNaN(price)?"N/A":price.toLocaleString("ru-RU",{style:"currency",currency:"BYN",maximumFractionDigits:0});}

// ==========================
// –ö–æ—Ä–∑–∏–Ω–∞ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
// ==========================
function addToCart(item) {
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  if (!cart.some(i => i.id === item.id && i.material===item.material && i.facade===item.facade && i.color===item.color)) {
    cart.push(item);
    localStorage.setItem("cart", JSON.stringify(cart));
  }
}

function addToFavorites(item) {
  let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
  if (!favorites.some(i => i.id === item.id)) {
    favorites.push(item);
    localStorage.setItem("favorites", JSON.stringify(favorites));
  }
}

function saveSelectedOptions() {
  localStorage.setItem(`selected-options-${productId}`, JSON.stringify({
    facade: selectedFacade,
    material: selectedMaterial,
    color: selectedColor
  }));
}

// ==========================
// –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
// ==========================
document.getElementById("buy-button").addEventListener("click", () => {
  const comboText = `–ú–∞—Ç–µ—Ä–∏–∞–ª: ${selectedMaterial||'-'}, –§–∞—Å–∞–¥: ${selectedFacade||'-'}, –¶–≤–µ—Ç: ${selectedColor||'-'}`;
  const price = productData.combinations.find(c => c.material===selectedMaterial && c.facade===selectedFacade && c.color===selectedColor)?.price || 0;
  addToCart({
    id: productId,
    title: productData.title,
    image: productData.images?.[0],
    price: price,
    material: selectedMaterial,
    facade: selectedFacade,
    shopId: productData.shopId,
    color: selectedColor
  });
  saveSelectedOptions();
  showMessage(`üõí –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É.<br>${comboText}<br>–¶–µ–Ω–∞: ${formatPrice(price)}`, false);
});

document.getElementById("favorite-button").addEventListener("click", () => {
  const price = productData.combinations.find(c => c.material===selectedMaterial && c.facade===selectedFacade && c.color===selectedColor)?.price || 0;
  addToFavorites({
    id: productId,
    title: productData.title,
    image: productData.images?.[0],
    price: price,
    material: selectedMaterial,
    facade: selectedFacade,
    shopId: productData.shopId,
    color: selectedColor
  });
  saveSelectedOptions();
  showMessage(`‚ù§Ô∏è –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ`, false);
});

// ==========================
// –°–æ–æ–±—â–µ–Ω–∏—è
// ==========================
function showMessage(text,isError){
  const msgBox=document.getElementById("message-box");
  msgBox.innerHTML=text;
  msgBox.className="show";
  msgBox.style.backgroundColor=isError?"#ef4444":"#10b981";
  setTimeout(()=>msgBox.classList.remove("show"),5000);
}

window.onload=initializeAuthAndFirestore;
</script>
</body>
</html>
