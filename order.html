<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; }
.orange-btn { background:#f97316; color:white; font-weight:700; transition:0.3s; }
.orange-btn:hover { background:#ea580c; }
</style>
</head>
<body class="pb-20">

<header class="sticky top-0 bg-white shadow z-10">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <a href="/" class="text-3xl font-black text-gray-900 tracking-tight">Mebel.by</a>
    <a href="favorites.html" class="text-orange-500 font-medium hover:underline">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 mt-8 grid lg:grid-cols-3 gap-10">
  <!-- üõí –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <section class="lg:col-span-2 bg-white p-6 rounded-3xl shadow">
    <h1 class="text-3xl font-black mb-6">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>
    <div id="cart-items" class="space-y-4"></div>
    <p id="empty-cart" class="text-gray-500 text-center mt-10 hidden">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî</p>
  </section>

  <!-- üßæ –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
  <aside class="bg-white p-6 rounded-3xl shadow h-fit sticky top-20">
    <h2 class="text-2xl font-bold mb-4">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
    <form id="order-form" class="space-y-4">
      <div>
        <label class="block font-medium mb-1">–ò–º—è</label>
        <input type="text" id="name" class="w-full border rounded-lg p-3" required>
      </div>
      <div>
        <label class="block font-medium mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" class="w-full border rounded-lg p-3" placeholder="+375 (XX) XXX-XX-XX" required>
      </div>
      <div>
        <label class="block font-medium mb-1">Email</label>
        <input type="email" id="email" class="w-full border rounded-lg p-3">
      </div>
      <div>
        <label class="block font-medium mb-1">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
        <textarea id="address" class="w-full border rounded-lg p-3" rows="3" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" required></textarea>
      </div>
      <div>
        <label class="block font-medium mb-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
        <div class="flex gap-4">
          <label class="flex items-center gap-2">
            <input type="radio" name="payment" value="–ù–∞–ª–∏—á–Ω—ã–π" checked> –ù–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="payment" value="–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π"> –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç
          </label>
        </div>
      </div>

      <div class="border-t pt-4 mt-4">
        <p class="text-lg font-semibold flex justify-between">
          <span>–ò—Ç–æ–≥–æ:</span>
          <span id="total-price" class="text-orange-600 text-2xl font-black">0 BYN</span>
        </p>
      </div>

      <button type="submit" class="orange-btn w-full py-4 rounded-xl text-lg uppercase">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </form>
  </aside>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// === FIREBASE INIT ===
const firebaseConfig = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
await signInAnonymously(auth);

// === LOAD CART FROM LOCALSTORAGE ===
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

// –ó–¥–µ—Å—å –º—ã –¥–æ–±–∞–≤–ª—è–µ–º shopId –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É
// –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≥–¥–µ –µ—Å—Ç—å info –æ –º–∞–≥–∞–∑–∏–Ω–µ
cart = cart.map(item => ({
    ...item,
    shopId: item.shopId || "default-shop" // –≤—Ä–µ–º–µ–Ω–Ω—ã–π shopId, –∑–∞–º–µ–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–º
}));

const cartItemsContainer = document.getElementById("cart-items");
const totalPriceEl = document.getElementById("total-price");
const emptyCartMsg = document.getElementById("empty-cart");

function renderCart() {
  cartItemsContainer.innerHTML = "";
  if (cart.length === 0) {
    emptyCartMsg.classList.remove("hidden");
    totalPriceEl.textContent = "0 BYN";
    return;
  }
  emptyCartMsg.classList.add("hidden");

  let total = 0;
  cart.forEach((item, index) => {
    const itemEl = document.createElement("div");
    itemEl.className = "flex items-center justify-between border-b pb-4";
    const price = Math.round(item.price * (1 - (item.discount || 0) / 100));
    total += price;

    itemEl.innerHTML = `
      <div class="flex items-center gap-4">
        <img src="${item.image}" class="w-20 h-20 rounded-lg object-cover">
        <div>
          <p class="font-bold text-lg">${item.title}</p>
          <p class="text-sm text-gray-600">${item.material || ''} ${item.color || ''}</p>
          <p class="text-orange-600 font-semibold">${price} BYN</p>
        </div>
      </div>
      <button class="text-red-500 font-bold" data-index="${index}">‚úï</button>
    `;
    cartItemsContainer.appendChild(itemEl);
  });

  totalPriceEl.textContent = `${total.toLocaleString("ru-RU")} BYN`;

  cartItemsContainer.querySelectorAll("button").forEach(btn => {
    btn.onclick = () => {
      const i = parseInt(btn.dataset.index);
      cart.splice(i, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    };
  });
}
renderCart();

// === SUBMIT ORDER ===
document.getElementById("order-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");

  // --- –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ shopId –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ (–µ—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤) ---
  const groupedByShop = {};
  cart.forEach(item => {
    const shopId = item.shopId || "default-shop";
    if (!groupedByShop[shopId]) groupedByShop[shopId] = [];
    groupedByShop[shopId].push(item);
  });

  try {
    // –°–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
    for (const shopId in groupedByShop) {
      const orderData = {
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        email: document.getElementById("email").value.trim(),
        address: document.getElementById("address").value.trim(),
        payment: document.querySelector('input[name="payment"]:checked').value,
        items: groupedByShop[shopId],
        total: groupedByShop[shopId].reduce((sum, item) => sum + Math.round(item.price * (1 - (item.discount || 0)/100)), 0),
        date: new Date().toISOString(),
        status: "–ù–æ–≤—ã–π",
        shopId: shopId
      };
      await addDoc(collection(db, "orders"), orderData);
    }

    alert("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
    localStorage.removeItem("cart");
    window.location.href = "/";
  } catch (err) {
    console.error(err);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ üò¢");
  }
});
</script>
</body>
</html>
