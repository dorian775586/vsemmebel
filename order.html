<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; }
.orange-btn { background:#f97316; color:white; font-weight:700; transition:0.3s; }
.orange-btn:hover { background:#ea580c; }
.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: flex; align-items: center; justify-content: center;
  z-index: 50; backdrop-filter: blur(2px);
}
.modal-content {
  background: white; padding: 2rem; border-radius: 1rem;
  text-align: center; max-width: 400px; width: 90%;
}
</style>
</head>
<body class="pb-20">

<header class="sticky top-0 bg-white shadow z-10">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <a href="/" class="text-3xl font-black text-gray-900 tracking-tight">Mebel.by</a>
    <a href="favorites.html" class="text-orange-500 font-medium hover:underline">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</a>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 mt-8 grid lg:grid-cols-3 gap-10">
  <section class="lg:col-span-2 bg-white p-6 rounded-3xl shadow">
    <h1 class="text-3xl font-black mb-6">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>
    <div id="cart-items" class="space-y-4"></div>
    <p id="empty-cart" class="text-gray-500 text-center mt-10 hidden">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
  </section>

  <aside class="bg-white p-6 rounded-3xl shadow h-fit sticky top-20">
    <h2 class="text-2xl font-bold mb-4">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
    <form id="order-form" class="space-y-4">
      <div>
        <label class="block font-medium mb-1">–ò–º—è</label>
        <input type="text" id="name" class="w-full border rounded-lg p-3" required>
      </div>
      <div>
        <label class="block font-medium mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" class="w-full border rounded-lg p-3" placeholder="+375 (XX) XXX-XX-XX" required>
      </div>
      <div>
        <label class="block font-medium mb-1">Email</label>
        <input type="email" id="email" class="w-full border rounded-lg p-3">
      </div>

      <!-- –í—ã–±–æ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ -->
      <div>
        <label class="block font-medium mb-2">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</label>
        <div class="flex gap-4">
          <label class="flex items-center gap-2">
            <input type="radio" name="delivery" value="–î–æ—Å—Ç–∞–≤–∫–∞" checked> –î–æ—Å—Ç–∞–≤–∫–∞
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="delivery" value="–°–∞–º–æ–≤—ã–≤–æ–∑"> –°–∞–º–æ–≤—ã–≤–æ–∑
          </label>
        </div>
      </div>

      <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
      <div id="delivery-address-block">
        <label class="block font-medium mb-1">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
        <textarea id="address" class="w-full border rounded-lg p-3" rows="3" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"></textarea>
      </div>

      <!-- –ê–¥—Ä–µ—Å —Å–∞–º–æ–≤—ã–≤–æ–∑–∞ -->
      <div id="pickup-info" class="hidden text-sm text-gray-700 bg-gray-100 p-3 rounded-lg">
        –°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞: <br>
        <strong>–≥. –ú–∏–Ω—Å–∫, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10</strong> <br>
        (–∞–¥—Ä–µ—Å –±—É–¥–µ—Ç —É—Ç–æ—á–Ω—ë–Ω)
      </div>

      <div>
        <label class="block font-medium mb-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
        <div class="flex gap-4">
          <label class="flex items-center gap-2">
            <input type="radio" name="payment" value="–ù–∞–ª–∏—á–Ω—ã–π" checked> –ù–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="payment" value="–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π"> –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç
          </label>
        </div>
      </div>

      <div class="border-t pt-4 mt-4">
        <p class="text-lg font-semibold flex justify-between">
          <span>–ò—Ç–æ–≥–æ:</span>
          <span id="total-price" class="text-orange-600 text-2xl font-black">0 BYN</span>
        </p>
      </div>

      <button type="submit" class="orange-btn w-full py-4 rounded-xl text-lg uppercase">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </form>
  </aside>
</main>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="success-modal" class="modal hidden">
  <div class="modal-content">
    <div class="text-green-600 text-5xl mb-3">‚úÖ</div>
    <h3 class="text-2xl font-bold mb-2 text-gray-800">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</h3>
    <p class="text-gray-700 mb-3">–° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
    <p class="font-semibold text-lg mb-4">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: <span id="order-number" class="text-orange-600"></span></p>
    <button id="close-modal" class="orange-btn px-6 py-2 rounded-lg">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
await signInAnonymously(auth);

// === CART ===
let cart = JSON.parse(localStorage.getItem("cart") || "[]");
const cartItemsContainer = document.getElementById("cart-items");
const totalPriceEl = document.getElementById("total-price");
const emptyCartMsg = document.getElementById("empty-cart");

function renderCart() {
  cartItemsContainer.innerHTML = "";
  if (cart.length === 0) {
    emptyCartMsg.classList.remove("hidden");
    totalPriceEl.textContent = "0 BYN";
    return;
  }
  emptyCartMsg.classList.add("hidden");
  let total = 0;
  cart.forEach((item, index) => {
    const itemEl = document.createElement("div");
    itemEl.className = "flex items-center justify-between border-b pb-4";
    const price = Math.round(item.price * (1 - (item.discount || 0) / 100));
    total += price;
    itemEl.innerHTML = `
      <div class="flex items-center gap-4">
        <img src="${item.image}" class="w-20 h-20 rounded-lg object-cover">
        <div>
          <p class="font-bold text-lg">${item.title}</p>
          <p class="text-sm text-gray-600">${item.material || ''} ${item.color || ''}</p>
          <p class="text-orange-600 font-semibold">${price} BYN</p>
        </div>
      </div>
      <button class="text-red-500 font-bold" data-index="${index}">‚úï</button>`;
    cartItemsContainer.appendChild(itemEl);
  });
  totalPriceEl.textContent = `${total.toLocaleString("ru-RU")} BYN`;
  cartItemsContainer.querySelectorAll("button").forEach(btn => {
    btn.onclick = () => {
      cart.splice(parseInt(btn.dataset.index), 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    };
  });
}
renderCart();

// === SWITCH DELIVERY METHOD ===
const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
const deliveryAddressBlock = document.getElementById("delivery-address-block");
const pickupInfo = document.getElementById("pickup-info");
deliveryRadios.forEach(radio => {
  radio.addEventListener("change", () => {
    if (radio.value === "–î–æ—Å—Ç–∞–≤–∫–∞") {
      deliveryAddressBlock.classList.remove("hidden");
      pickupInfo.classList.add("hidden");
    } else {
      deliveryAddressBlock.classList.add("hidden");
      pickupInfo.classList.remove("hidden");
    }
  });
});

// === ORDER SUBMIT ===
document.getElementById("order-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");

  const deliveryType = document.querySelector('input[name="delivery"]:checked').value;
  const address = deliveryType === "–î–æ—Å—Ç–∞–≤–∫–∞" ? document.getElementById("address").value.trim() : "–°–∞–º–æ–≤—ã–≤–æ–∑ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞";

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
  const orderNumber = "MBL-" + new Date().getFullYear() + "-" + Math.floor(Math.random() * 100000).toString().padStart(5, "0");

  const groupedByShop = {};
  cart.forEach(item => {
    const shopId = item.shopId;
    if (!groupedByShop[shopId]) groupedByShop[shopId] = [];
    groupedByShop[shopId].push(item);
  });

  try {
    for (const shopId in groupedByShop) {
      const orderData = {
        orderNumber,
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        email: document.getElementById("email").value.trim(),
        address,
        deliveryType,
        payment: document.querySelector('input[name="payment"]:checked').value,
        items: groupedByShop[shopId],
        total: groupedByShop[shopId].reduce((sum, i) => sum + Math.round(i.price * (1 - (i.discount || 0) / 100)), 0),
        date: new Date().toISOString(),
        status: "–ù–æ–≤—ã–π",
        shopId
      };
      await addDoc(collection(db, "orders"), orderData);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    document.getElementById("order-number").textContent = orderNumber;
    document.getElementById("success-modal").classList.remove("hidden");

  } catch (err) {
    console.error(err);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ üò¢");
  }
});

// === CLOSE MODAL ===
document.getElementById("close-modal").addEventListener("click", () => {
  localStorage.removeItem("cart");
  window.location.href = "/";
});
</script>
</body>
</html>
