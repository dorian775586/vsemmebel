<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление магазинами и товарами</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Установка шрифта Inter для Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Стиль для обеспечения плавности переходов */
        .tab-button {
            transition: background-color 0.2s, color 0.2s;
        }
    </style>
    <script type="module">
        // Импорты Firebase v9: collection, getDocs и другие импортируются как отдельные функции.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteField, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Установка уровня логирования для Firestore
        setLogLevel('error');

        // ======== Использование глобальных переменных Canvas (ОБЯЗАТЕЛЬНО) ========
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Пути к коллекциям (Исправлено: Добавлен префикс artifacts/{appId}/public/data/ для соблюдения правил безопасности)
        const shopCollectionPath = `artifacts/${appId}/public/data/shops`;
        const productCollectionPath = `artifacts/${appId}/public/data/offers`; // Путь из вашего кода

        // ======== Пароль для доступа (Hardcoded, как у вас) ========
        const ACCESS_PASSWORD = "create775586";

        // ======== Элементы DOM ========
        const passwordCheckDiv = document.getElementById("password-check");
        const mainInterface = document.getElementById("main-interface");
        const checkBtn = document.getElementById("check-password-btn");
        const passwordInput = document.getElementById("access-password");
        const passwordError = document.getElementById("password-error");
        
        // Элементы вкладок
        const tabCreate = document.getElementById("tab-create-shop");
        const tabManage = document.getElementById("tab-manage-products");
        const createFormDiv = document.getElementById("create-shop-form");
        const manageDiv = document.getElementById("manage-products");

        // Элементы формы создания
        const createBtn = document.getElementById("create-shop-btn");
        const shopNameInput = document.getElementById("shop-name");
        const shopEmailInput = document.getElementById("shop-email");
        const shopPasswordInput = document.getElementById("shop-password");
        const messageP = document.getElementById("create-shop-message");

        // Элементы привязки товаров
        const shopSelect = document.getElementById("shop-select");
        const productsListDiv = document.getElementById("products-list");
        const saveAssignmentsBtn = document.getElementById("save-assignments");
        const assignMessage = document.getElementById("assign-message");

        // ======== Обработка входа по паролю ========
        checkBtn.addEventListener("click", () => {
            if(passwordInput.value === ACCESS_PASSWORD){
                passwordCheckDiv.classList.add("hidden");
                mainInterface.classList.remove("hidden");
                loadShops();
                loadProducts();
            } else {
                passwordError.textContent = "Неверный пароль";
                passwordError.classList.remove("hidden");
            }
        });

        // ======== Переключение вкладок ====
        function setActiveTab(activeTab, inactiveTab, activeContent, inactiveContent) {
            activeContent.classList.remove("hidden");
            inactiveContent.classList.add("hidden");
            activeTab.classList.add("bg-orange-500", "text-white");
            activeTab.classList.remove("bg-gray-300", "text-gray-700");
            inactiveTab.classList.remove("bg-orange-500", "text-white");
            inactiveTab.classList.add("bg-gray-300", "text-gray-700");
        }

        tabCreate.addEventListener("click", () => {
            setActiveTab(tabCreate, tabManage, createFormDiv, manageDiv);
        });

        tabManage.addEventListener("click", () => {
            setActiveTab(tabManage, tabCreate, manageDiv, createFormDiv);
        });

        // ======== Создание магазина ========
        createBtn.addEventListener("click", async () => {
            const name = shopNameInput.value.trim();
            const email = shopEmailInput.value.trim();
            const password = shopPasswordInput.value;

            if(!name || !email || !password){
                messageP.textContent = "Заполните все поля!";
                messageP.className = "mt-4 text-sm text-red-500 font-medium";
                return;
            }

            try {
                // 1. Создание пользователя в Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // 2. Создание документа магазина в Firestore
                // Используется setDoc и doc - ПРАВИЛЬНЫЙ МОДУЛЬНЫЙ СИНТАКСИС v9
                const shopRef = doc(db, shopCollectionPath, uid);
                await setDoc(shopRef, {
                    shopName: name,
                    email: email,
                    ownerUid: uid,
                    createdAt: serverTimestamp()
                });

                messageP.textContent = "Магазин успешно создан и связан с аккаунтом!";
                messageP.className = "mt-4 text-sm text-green-600 font-medium";

                shopNameInput.value = "";
                shopEmailInput.value = "";
                shopPasswordInput.value = "";

                loadShops(); // Обновляем список магазинов
            } catch (error) {
                console.error("Ошибка при создании магазина:", error);
                messageP.textContent = `Ошибка: ${error.message}`;
                messageP.className = "mt-4 text-sm text-red-500 font-medium";
            }
        });

        // ======== Загрузка магазинов ========
        async function loadShops(){
            shopSelect.innerHTML = '<option value="" disabled selected>-- Выберите магазин --</option>';
            try {
                // Используется collection(db, path) и getDocs - ПРАВИЛЬНЫЙ МОДУЛЬНЫЙ СИНТАКСИС v9
                const shopsSnapshot = await getDocs(collection(db, shopCollectionPath));
                shopsSnapshot.forEach(docSnap => {
                    const shop = docSnap.data();
                    const option = document.createElement("option");
                    option.value = docSnap.id;
                    option.textContent = shop.shopName;
                    shopSelect.appendChild(option);
                });
            } catch(e) {
                console.error("Ошибка загрузки магазинов:", e);
            }
        }

        // ======== Загрузка товаров ========
        async function loadProducts(){
            productsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Загрузка товаров...</p>';
            try {
                // Используется collection(db, path) и getDocs - ПРАВИЛЬНЫЙ МОДУЛЬНЫЙ СИНТАКСИС v9
                const productsSnapshot = await getDocs(collection(db, productCollectionPath));
                productsListDiv.innerHTML = '';
                productsSnapshot.forEach(docSnap => {
                    const product = docSnap.data();
                    const div = document.createElement("div");
                    div.className = "flex items-center justify-between p-2 border-b hover:bg-gray-50 transition duration-150";
                    
                    // Проверяем, привязан ли товар
                    // Если поле shopId равно ID магазина, который мы выбираем в селекте,
                    // оно будет отмечено при условии, что мы обновляем UI при выборе магазина.
                    // Поскольку мы не знаем, какой магазин выбран, мы просто проверяем наличие shopId.
                    const isChecked = product.shopId ? 'checked' : ''; 

                    div.innerHTML = `
                        <span class="truncate pr-4">${product.title || 'Без названия'}</span>
                        <input type="checkbox" data-id="${docSnap.id}" ${isChecked} class="h-5 w-5 text-blue-600 rounded">
                    `;
                    productsListDiv.appendChild(div);
                });
            } catch(e) {
                console.error("Ошибка загрузки товаров:", e);
                productsListDiv.innerHTML = `<p class="text-red-500 p-4">Не удалось загрузить список товаров: ${e.message}</p>`;
            }
        }

        // ======== Сохранение привязки товаров ========
        saveAssignmentsBtn.addEventListener("click", async () => {
            const selectedShop = shopSelect.value;
            if(!selectedShop){
                assignMessage.textContent = "Выберите магазин!";
                assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
                return;
            }

            const checkboxes = productsListDiv.querySelectorAll('input[type=checkbox]');
            const batchUpdates = [];

            checkboxes.forEach(cb => {
                // Используется doc(db, path, id) - ПРАВИЛЬНЫЙ МОДУЛЬНЫЙ СИНТАКСИС v9
                const productRef = doc(db, productCollectionPath, cb.dataset.id);
                if(cb.checked){
                    // Привязка товара к выбранному магазину
                    batchUpdates.push(updateDoc(productRef, { shopId: selectedShop }));
                } else {
                    // Отвязка товара
                    batchUpdates.push(updateDoc(productRef, { shopId: deleteField() }));
                }
            });

            try {
                // Примечание: Для выполнения всех операций сразу рекомендуется использовать 'writeBatch', 
                // но Promise.all также сработает для небольшого количества операций.
                await Promise.all(batchUpdates);
                assignMessage.textContent = "Товары успешно обновлены!";
                assignMessage.className = "mt-4 text-sm text-green-600 font-medium";
                loadProducts(); // Перезагружаем список, чтобы увидеть актуальные статусы
            } catch(e){
                console.error("Ошибка при сохранении привязки:", e);
                assignMessage.textContent = "Ошибка при сохранении привязки!";
                assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
            }
        });
        
        // Автоматическая аутентификация при загрузке (для доступа к Firestore)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        async function authenticate() {
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Успешная аутентификация по токену.");
                } catch (error) {
                    console.error("Ошибка аутентификации по токену:", error);
                }
            }
        }

        window.onload = authenticate;
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 font-sans">

<div id="password-check" class="max-w-md mx-auto mt-20 bg-white p-6 rounded-xl shadow-2xl border border-gray-200">
    <h2 class="text-2xl font-extrabold mb-4 text-gray-800 text-center">🔐 Панель администратора</h2>
    <input id="access-password" type="password" placeholder="Пароль доступа" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-orange-500 focus:border-orange-500">
    <button id="check-password-btn" class="bg-blue-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 w-full shadow-md">Войти</button>
    <p id="password-error" class="text-red-500 mt-3 text-center text-sm hidden"></p>
</div>

<div id="main-interface" class="hidden max-w-4xl mx-auto mt-6">
    <div class="flex gap-2 sm:gap-4 mb-6">
        <button id="tab-create-shop" class="tab-button bg-orange-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md flex-1">Создание магазина</button>
        <button id="tab-manage-products" class="tab-button bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg shadow-md flex-1">Привязка товаров</button>
    </div>

    <div id="create-shop-form" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-200">
        <h2 class="text-2xl font-bold mb-6 text-orange-600">Создание нового интернет-магазина</h2>
        <input id="shop-name" type="text" placeholder="Название магазина (Например: Мебель от Ивана)" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-green-500 focus:border-green-500">
        <input id="shop-email" type="email" placeholder="Email (Логин владельца)" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-green-500 focus:border-green-500">
        <input id="shop-password" type="password" placeholder="Пароль для входа (мин. 6 символов)" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-green-500 focus:border-green-500">
        <button id="create-shop-btn" class="bg-green-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 w-full shadow-md">Создать магазин</button>
        <p id="create-shop-message" class="mt-4 text-sm text-gray-700"></p>
    </div>

    <div id="manage-products" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-200 hidden">
        <h2 class="text-2xl font-bold mb-6 text-blue-600">Привязка товаров к магазину</h2>
        
        <label for="shop-select" class="font-semibold mb-2 block text-gray-700">Выберите магазин:</label>
        <select id="shop-select" class="p-3 border border-gray-300 rounded-lg w-full mb-6 focus:ring-blue-500 focus:border-blue-500">
            <option value="" disabled selected>-- Выберите магазин --</option>
        </select>

        <h3 class="font-semibold mb-2 text-gray-700">Список товаров (отметьте, которые нужно привязать к выбранному магазину):</h3>
        <div id="products-list" class="max-h-[50vh] overflow-y-auto border border-gray-300 p-4 mb-6 rounded-lg bg-gray-50">
            <p class="text-gray-500 text-center py-4">Загрузка товаров...</p>
        </div>

        <button id="save-assignments" class="bg-blue-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 w-full shadow-md">Сохранить привязку</button>
        <p id="assign-message" class="mt-4 text-sm text-gray-700"></p>
    </div>
</div>

</body>
</html>
