<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Управление магазинами и товарами</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.tab-button { transition: background-color 0.2s, color 0.2s; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteField, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
  authDomain: "vsemmebel-90d48.firebaseapp.com",
  projectId: "vsemmebel-90d48",
  storageBucket: "vsemmebel-90d48.appspot.com",
  messagingSenderId: "958123504041",
  appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const appId = 'default-app-id'; // замените на ваш appId
const shopCollectionPath = ['artifacts', appId, 'public', 'data', 'shops'];
const productCollectionPath = ['artifacts', appId, 'public', 'data', 'offers'];

// ===== Hardcoded пароль =====
const ACCESS_PASSWORD = "create775586";

// ===== DOM =====
const passwordCheckDiv = document.getElementById("password-check");
const mainInterface = document.getElementById("main-interface");
const checkBtn = document.getElementById("check-password-btn");
const passwordInput = document.getElementById("access-password");
const passwordError = document.getElementById("password-error");

const tabCreate = document.getElementById("tab-create-shop");
const tabManage = document.getElementById("tab-manage-products");
const createFormDiv = document.getElementById("create-shop-form");
const manageDiv = document.getElementById("manage-products");

const createBtn = document.getElementById("create-shop-btn");
const shopNameInput = document.getElementById("shop-name");
const shopEmailInput = document.getElementById("shop-email");
const shopPasswordInput = document.getElementById("shop-password");
const messageP = document.getElementById("create-shop-message");

const shopSelect = document.getElementById("shop-select");
const productsListDiv = document.getElementById("products-list");
const saveAssignmentsBtn = document.getElementById("save-assignments");
const assignMessage = document.getElementById("assign-message");

// ===== Пароль доступа =====
checkBtn.addEventListener("click", () => {
  if(passwordInput.value === ACCESS_PASSWORD){
    passwordCheckDiv.classList.add("hidden");
    mainInterface.classList.remove("hidden");
    loadShops();
    loadProducts();
  } else {
    passwordError.textContent = "Неверный пароль";
    passwordError.classList.remove("hidden");
  }
});

// ===== Вкладки =====
function setActiveTab(activeTab, inactiveTab, activeContent, inactiveContent) {
  activeContent.classList.remove("hidden");
  inactiveContent.classList.add("hidden");
  activeTab.classList.add("bg-orange-500","text-white");
  activeTab.classList.remove("bg-gray-300","text-gray-700");
  inactiveTab.classList.remove("bg-orange-500","text-white");
  inactiveTab.classList.add("bg-gray-300","text-gray-700");
}
tabCreate.addEventListener("click", () => setActiveTab(tabCreate, tabManage, createFormDiv, manageDiv));
tabManage.addEventListener("click", () => setActiveTab(tabManage, tabCreate, manageDiv, createFormDiv));

// ===== Создание магазина =====
createBtn.addEventListener("click", async () => {
  const name = shopNameInput.value.trim();
  const email = shopEmailInput.value.trim();
  const password = shopPasswordInput.value;

  if(!name || !email || !password){
    messageP.textContent = "Заполните все поля!";
    messageP.className = "mt-4 text-sm text-red-500 font-medium";
    return;
  }

  // Проверка email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailRegex.test(email)){
    messageP.textContent = "Введите корректный email!";
    messageP.className = "mt-4 text-sm text-red-500 font-medium";
    return;
  }

  if(password.length < 6){
    messageP.textContent = "Пароль должен быть не меньше 6 символов!";
    messageP.className = "mt-4 text-sm text-red-500 font-medium";
    return;
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;

    const shopRef = doc(db, ...shopCollectionPath, uid);
    await setDoc(shopRef, {
      shopName: name,
      email: email,
      ownerUid: uid,
      createdAt: serverTimestamp()
    });

    messageP.textContent = "Магазин успешно создан!";
    messageP.className = "mt-4 text-sm text-green-600 font-medium";

    shopNameInput.value = "";
    shopEmailInput.value = "";
    shopPasswordInput.value = "";

    loadShops();
  } catch (error) {
    console.error("Ошибка при создании магазина:", error);
    messageP.textContent = `Ошибка: ${error.message}`;
    messageP.className = "mt-4 text-sm text-red-500 font-medium";
  }
});

// ===== Загрузка магазинов =====
async function loadShops(){
  shopSelect.innerHTML = '<option value="" disabled selected>-- Выберите магазин --</option>';
  try {
    const shopsSnapshot = await getDocs(collection(db, ...shopCollectionPath));
    shopsSnapshot.forEach(docSnap => {
      const shop = docSnap.data();
      const option = document.createElement("option");
      option.value = docSnap.id;
      option.textContent = shop.shopName;
      shopSelect.appendChild(option);
    });
  } catch(e){
    console.error("Ошибка загрузки магазинов:", e);
    assignMessage.textContent = `Ошибка загрузки магазинов: ${e.message}`;
    assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
  }
}

// ===== Загрузка товаров =====
async function loadProducts(){
  productsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Загрузка товаров...</p>';
  try {
    const productsSnapshot = await getDocs(collection(db, ...productCollectionPath));
    productsListDiv.innerHTML = '';

    if(productsSnapshot.empty){
      productsListDiv.innerHTML = `<p class="text-gray-500 p-4">Товары отсутствуют.</p>`;
      return;
    }

    productsSnapshot.forEach(docSnap => {
      const product = docSnap.data();
      const div = document.createElement("div");
      div.className = "flex items-center justify-between p-2 border-b hover:bg-gray-50 transition duration-150";
      const isChecked = product.shopId ? 'checked' : '';
      div.innerHTML = `
        <span class="truncate pr-4">${product.title || 'Без названия'}</span>
        <input type="checkbox" data-id="${docSnap.id}" ${isChecked} class="h-5 w-5 text-blue-600 rounded">
      `;
      productsListDiv.appendChild(div);
    });
  } catch(e){
    console.error("Ошибка загрузки товаров:", e);
    productsListDiv.innerHTML = `<p class="text-red-500 p-4">Не удалось загрузить список товаров: ${e.message}</p>`;
  }
}

// ===== Сохранение привязки товаров =====
saveAssignmentsBtn.addEventListener("click", async () => {
  const selectedShop = shopSelect.value;
  if(!selectedShop){
    assignMessage.textContent = "Выберите магазин!";
    assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
    return;
  }

  const checkboxes = productsListDiv.querySelectorAll('input[type=checkbox]');
  const batchUpdates = [];

  checkboxes.forEach(cb => {
    const productRef = doc(db, ...productCollectionPath, cb.dataset.id);
    if(cb.checked){
      batchUpdates.push(updateDoc(productRef, { shopId: selectedShop }));
    } else {
      batchUpdates.push(updateDoc(productRef, { shopId: deleteField() }));
    }
  });

  try {
    await Promise.all(batchUpdates);
    assignMessage.textContent = "Товары успешно обновлены!";
    assignMessage.className = "mt-4 text-sm text-green-600 font-medium";
    loadProducts();
  } catch(e){
    console.error("Ошибка при сохранении привязки:", e);
    assignMessage.textContent = "Ошибка при сохранении привязки!";
    assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
  }
});
</script>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 font-sans">

<div id="password-check" class="max-w-md mx-auto mt-20 bg-white p-6 rounded-xl shadow-2xl border border-gray-200">
    <h2 class="text-2xl font-extrabold mb-4 text-gray-800 text-center">
