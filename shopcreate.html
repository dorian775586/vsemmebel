<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞–º–∏ –∏ —Ç–æ–≤–∞—Ä–∞–º–∏</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –¥–ª—è Tailwind CSS
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <style>
    .tab-button {
      transition: background-color 0.2s, color 0.2s;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 font-sans">

<div id="password-check" class="max-w-md mx-auto mt-20 bg-white p-6 rounded-xl shadow-2xl border border-gray-200">
  <h2 class="text-2xl font-extrabold mb-4 text-gray-800 text-center">üîê –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
  <input id="access-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-orange-500 focus:border-orange-500">
  <button id="check-password-btn" class="bg-blue-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 w-full shadow-md">–í–æ–π—Ç–∏</button>
  <p id="password-error" class="text-red-500 mt-3 text-center text-sm hidden"></p>
</div>

<div id="main-interface" class="hidden max-w-4xl mx-auto mt-6">
  <div class="flex gap-2 sm:gap-4 mb-6">
    <button id="tab-create-shop" class="tab-button bg-orange-500 text-white font-semibold px-4 py-2 rounded-lg shadow-md flex-1">–°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</button>
    <button id="tab-manage-products" class="tab-button bg-gray-300 text-gray-700 font-semibold px-4 py-2 rounded-lg shadow-md flex-1">–ü—Ä–∏–≤—è–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</button>
  </div>

  <div id="create-shop-form" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-200">
    <h2 class="text-2xl font-bold mb-6 text-orange-600">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞</h2>
    <input id="shop-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ (–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ–±–µ–ª—å –æ—Ç –ò–≤–∞–Ω–∞)" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-green-500 focus:border-green-500">
    <input id="shop-email" type="email" placeholder="Email (–õ–æ–≥–∏–Ω –≤–ª–∞–¥–µ–ª—å—Ü–∞)" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-green-500 focus:border-green-500">
    <input id="shop-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-green-500 focus:border-green-500">
    <button id="create-shop-btn" class="bg-green-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 w-full shadow-md">–°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
    <p id="create-shop-message" class="mt-4 text-sm text-gray-700"></p>
  </div>

  <div id="manage-products" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-200 hidden">
    <h2 class="text-2xl font-bold mb-6 text-blue-600">–ü—Ä–∏–≤—è–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∫ –º–∞–≥–∞–∑–∏–Ω—É</h2>
    
    <label for="shop-select" class="font-semibold mb-2 block text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω:</label>
    <select id="shop-select" class="p-3 border border-gray-300 rounded-lg w-full mb-6 focus:ring-blue-500 focus:border-blue-500">
      <option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>
    </select>

    <h3 class="font-semibold mb-2 text-gray-700">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–æ—Ç–º–µ—Ç—å—Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–∞–≥–∞–∑–∏–Ω—É):</h3>
    <div id="products-list" class="max-h-[50vh] overflow-y-auto border border-gray-300 p-4 mb-6 rounded-lg bg-gray-50">
      <p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>
    </div>

    <button id="save-assignments" class="bg-blue-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 w-full shadow-md">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É</button>
    <p id="assign-message" class="mt-4 text-sm text-gray-700"></p>
  </div>
</div>

<!-- === –ú–æ–¥—É–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –≤–Ω–∏–∑—É body –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã DOM === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteField, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  setLogLevel('error');

  const firebaseConfig = {
      apiKey: "AIzaSyA-LeQHKV4NfJrTKQCGjG-VQGhfWxtPk70",
      authDomain: "vsemmebel-90d48.firebaseapp.com",
      projectId: "vsemmebel-90d48",
      storageBucket: "vsemmebel-90d48.appspot.com",
      messagingSenderId: "958123504041",
      appId: "1:958123504041:web:1f14f4561d6bb6628494b8"
  };

  const appId = 'default-app-id';
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const shopCollectionPath = `artifacts/${appId}/public/data/shops`;
  const productCollectionPath = `artifacts/${appId}/public/data/offers`;

  const ACCESS_PASSWORD = "create775586";

  // === –≠–ª–µ–º–µ–Ω—Ç—ã DOM ===
  const passwordCheckDiv = document.getElementById("password-check");
  const mainInterface = document.getElementById("main-interface");
  const checkBtn = document.getElementById("check-password-btn");
  const passwordInput = document.getElementById("access-password");
  const passwordError = document.getElementById("password-error");
  
  const tabCreate = document.getElementById("tab-create-shop");
  const tabManage = document.getElementById("tab-manage-products");
  const createFormDiv = document.getElementById("create-shop-form");
  const manageDiv = document.getElementById("manage-products");

  const createBtn = document.getElementById("create-shop-btn");
  const shopNameInput = document.getElementById("shop-name");
  const shopEmailInput = document.getElementById("shop-email");
  const shopPasswordInput = document.getElementById("shop-password");
  const messageP = document.getElementById("create-shop-message");

  const shopSelect = document.getElementById("shop-select");
  const productsListDiv = document.getElementById("products-list");
  const saveAssignmentsBtn = document.getElementById("save-assignments");
  const assignMessage = document.getElementById("assign-message");

  // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ –ø–∞—Ä–æ–ª—é ===
  checkBtn.addEventListener("click", () => {
      if(passwordInput.value === ACCESS_PASSWORD){
          passwordCheckDiv.classList.add("hidden");
          mainInterface.classList.remove("hidden");
          loadShops();
          loadProducts();
      } else {
          passwordError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
          passwordError.classList.remove("hidden");
      }
  });

  // === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ===
  function setActiveTab(activeTab, inactiveTab, activeContent, inactiveContent) {
      activeContent.classList.remove("hidden");
      inactiveContent.classList.add("hidden");
      activeTab.classList.add("bg-orange-500", "text-white");
      activeTab.classList.remove("bg-gray-300", "text-gray-700");
      inactiveTab.classList.remove("bg-orange-500", "text-white");
      inactiveTab.classList.add("bg-gray-300", "text-gray-700");
  }

  tabCreate.addEventListener("click", () => setActiveTab(tabCreate, tabManage, createFormDiv, manageDiv));
  tabManage.addEventListener("click", () => setActiveTab(tabManage, tabCreate, manageDiv, createFormDiv));

  // === –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ ===
  createBtn.addEventListener("click", async () => {
      const name = shopNameInput.value.trim();
      const email = shopEmailInput.value.trim();
      const password = shopPasswordInput.value;

      if(!name || !email || !password){
          messageP.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!";
          messageP.className = "mt-4 text-sm text-red-500 font-medium";
          return;
      }

      try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCredential.user.uid;

          const shopRef = doc(db, shopCollectionPath, uid);
          await setDoc(shopRef, {
              shopName: name,
              email: email,
              ownerUid: uid,
              createdAt: serverTimestamp()
          });

          messageP.textContent = "–ú–∞–≥–∞–∑–∏–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ —Å–≤—è–∑–∞–Ω —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º!";
          messageP.className = "mt-4 text-sm text-green-600 font-medium";

          shopNameInput.value = "";
          shopEmailInput.value = "";
          shopPasswordInput.value = "";

          loadShops();
      } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞:", error);
          messageP.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
          messageP.className = "mt-4 text-sm text-red-500 font-medium";
      }
  });

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ ===
  async function loadShops(){
      shopSelect.innerHTML = '<option value="" disabled selected>-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω --</option>';
      try {
          const shopsSnapshot = await getDocs(collection(db, shopCollectionPath));
          shopsSnapshot.forEach(docSnap => {
              const shop = docSnap.data();
              const option = document.createElement("option");
              option.value = docSnap.id;
              option.textContent = shop.shopName;
              shopSelect.appendChild(option);
          });
      } catch(e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤:", e);
          assignMessage.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤: ${e.message}`;
          assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
      }
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ ===
  async function loadProducts(){
      productsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>';
      try {
          const productsSnapshot = await getDocs(collection(db, productCollectionPath));
          productsListDiv.innerHTML = '';
          
          if (productsSnapshot.empty) {
               productsListDiv.innerHTML = `<p class="text-gray-500 p-4">–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ${productCollectionPath} –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.</p>`;
               return;
          }

          productsSnapshot.forEach(docSnap => {
              const product = docSnap.data();
              const div = document.createElement("div");
              div.className = "flex items-center justify-between p-2 border-b hover:bg-gray-50 transition duration-150";
              
              const isChecked = product.shopId ? 'checked' : '';

              div.innerHTML = `
                  <span class="truncate pr-4">${product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</span>
                  <input type="checkbox" data-id="${docSnap.id}" ${isChecked} class="h-5 w-5 text-blue-600 rounded">
              `;
              productsListDiv.appendChild(div);
          });
      } catch(e) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:", e);
          productsListDiv.innerHTML = `<p class="text-red-500 p-4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤: ${e.message}</p>`;
      }
  }

  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ ===
  saveAssignmentsBtn.addEventListener("click", async () => {
      const selectedShop = shopSelect.value;
      if(!selectedShop){
          assignMessage.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!";
          assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
          return;
      }

      const checkboxes = productsListDiv.querySelectorAll('input[type=checkbox]');
      const batchUpdates = [];

      checkboxes.forEach(cb => {
          const productRef = doc(db, productCollectionPath, cb.dataset.id);
          if(cb.checked){
              batchUpdates.push(updateDoc(productRef, { shopId: selectedShop }));
          } else {
              batchUpdates.push(updateDoc(productRef, { shopId: deleteField() }));
          }
      });

      try {
          await Promise.all(batchUpdates);
          assignMessage.textContent = "–¢–æ–≤–∞—Ä—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!";
          assignMessage.className = "mt-4 text-sm text-green-600 font-medium";
          loadProducts();
      } catch(e){
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–∏–≤—è–∑–∫–∏:", e);
          assignMessage.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–∏–≤—è–∑–∫–∏!";
          assignMessage.className = "mt-4 text-sm text-red-500 font-medium";
      }
  });

</script>

</body>
</html>
